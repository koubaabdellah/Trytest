define("js2/CommentsExtendedNew",["jquery","./Observable"],(function(e,t){return function(n,o){"use strict";var a=document.location.href.split("#")[1]||"",s={};o=e.extend({},o);a.length>0&&(2===(a=a.split("-")).length?("answer"===a[0]&&(s.action=a[0]),24===a[1].length&&(s.comment_id=a[1])):1===a.length&&0===a[0].indexOf("comment")&&24===a[0].replace("comment","").length&&(s.comment_id=a[0]));var i,r,d=e(n),m=this;function c(t,o){var a=n.querySelector(t)&&n.querySelector(t).dataset.za;a?window.za(e.extend({},JSON.parse(a).data,{ev_action:o})):e(window).trigger("track-event",["comments",o])}e.extend(m,new t),function(){if(d.data("ownerTypes")&&("masterprice"==d.data("seoTargetType")||d.data("ownerId"))){var n=new function(n){var a,i=this,r=n.data("sort")||"default",c=+n.data("remain")||0,l=+n.data("skip")||0,h=l,f=+n.data("onpage")||0,p=+n.data("burst")||0,u=n.data("snippet")||{},v=+n.data("has-more")||0;i.setTextSnippet=function(e){u={key:"word",value:e,title:e}},"string"==typeof u&&i.setTextSnippet(u),e.extend(i,new t),i.getCommnets=function(t,n){a&&a.abort&&a.abort(),i.trigger("before.load"),t=t||{};var s={area:"service",action:"CommentList",owner:d.data("ownerTypes"),organization:d.data("ownerId"),seo_target_type:d.data("seoTargetType"),is_widget:d.data("isWidget"),snippet:u,sort:t.sort||r,limit:t.limit||i.limit(),skip:l,strategy:d.data("strategy"),strategy_options:o,template:d.data("template"),sub_comments:d.data("subComments"),allow_comment:d.data("allowComment"),allow_share:d.data("allowShare"),allow_judge:d.data("allowJudge"),stripped:d.data("stripped"),reply_on_needs_reply:d.data("replyOnNeedsReply"),highlight_needs_reply:d.data("highlightNeedsReply"),mixins:d.data("mixins"),offer_id:d.data("offerId"),debug_from_2:window.location.href};return a=e.post("/js.php",s).done((function(e){e.success&&(i.trigger("load",e.list,n),h=l,l+=s.limit,c=e.remain,v=e.has_more,m.trigger("remain",e.remain))})).always((function(){i.trigger("after.load")})),i},i.load=function(e,t){e&&e!==r&&(r=e,t=!0);var n=i.limit();t&&(n+=l,l=0),i.getCommnets({limit:n},t)},i.next=function(){c&&i.getCommnets(null,!0)},i.prev=function(){if(0!==l){var e=Math.abs(h-l);c+=e+f,l=Math.max(h-f,0),i.getCommnets(null,!0)}},i.reload=function(){return i.load(null,!0),i},i.remain=function(){return c},i.limit=function(){return c>f+p?f:c},i.hasMore=function(){return v},i.skip=function(){return l},i.onpage=function(){return f},i.on("load",(function(t,o){if(n[o?"html":"append"](t),lazyload(n[0]),window.dispatchEvent(new Event("height")),s.hasOwnProperty("comment_id")){var a=n.find("#comment"+s.comment_id);if(!a.length)return;e(window).scrollTop(a.offset().top),s.hasOwnProperty("action")&&"answer"===s.action&&a.find(".comment-container .js-comment-reply:first").trigger("click")}})),i.on("clear",(function(){n.empty()}))}(e(".js-comment-list",d));m.list=n;var a=new function(n){var o=this,a=n.siblings(".js-loader");e.extend(o,new t),n.on("click",(function(e){e.preventDefault(),n.attr("disabled")||o.trigger("click")})),o.loaderShow=function(){n.hide(),a.show()},o.loaderHide=function(){a.hide(),n.show()},o.remain=function(e,t,o){if(e<=0)n.closest(".js-show-more-box").hide();else{var a="";if(e>t){var s=t,i=e+(o?"+":"");a=(a=(a=i18n.plural("reviews.show_more_value_of_max",e)).replace(e,i)).replace(":value",s)}else a=i18n.plural("reviews.show_more_count_reviews",e);n.show().text(a).closest(".js-show-more-box").show()}}}(e(".js-show-more",d)),i=new function(n){var o=this;e.extend(o,new t),n.on("click",(function(e){e.preventDefault(),n.attr("disabled")||o.trigger("click")})),o.available=function(e){n.toggleClass("disabled",!e)}}(e(".js-comment-next",d)),r=new function(n){var o=this;e.extend(o,new t),n.on("click",(function(e){e.preventDefault(),n.attr("disabled")||o.trigger("click")})),o.available=function(e,t){n.toggleClass("disabled",e<=t)}}(e(".js-comment-prev",d)),l=new function(n){var o=this;e.extend(o,new t),e(".js-order-switch",n).on("change",(function(){var t="sort";e(this).closest("label").hasClass("asc")&&(t="sort_asc");var n=e(this);e(this).is("select")&&(t=(n=e(this).find(":selected")).data("type"));var a=n.data("field");"sort_asc"===t&&(a+="_asc"),e(this).val(a),e(this).closest("label").addClass("active").siblings().removeClass("active asc"),e(this).closest("label").toggleClass("asc");var s=e(this).closest(".js-order-controls").data("za");s&&window.za(e.extend({},s.data,{ev_action:t,ev_label:"by_"+n.data("field")})),o.trigger("change",this.value)}))}(e(".js-order-controls",d));e(".js-order-buttons .js-order-switch",d).on("click",(function(){var t=e(this).prop("value"),a=e(this).closest("label");a.hasClass("active")?(o[t]=0,a.removeClass("active")):(a.addClass("active"),e(window).trigger("track-event",["comments","sort","photo"]),o[t]=1),n.reload()}));var h=new function(n){var o=this;e.extend(o,new t),o.set=function(t,a){a||(a=e('.js-snippet[data-snippet="'+t+'"]').data("title")||t),n[t?"show":"hide"](),n.find(".title").text(a),o.trigger("change",t)},o.getFromHash=function(){var e=window.location.hash.substring(1),t=e.match(/snippet=([а-я]+)/i);if(e&&t)return t[1]?t[1]:""},n.on("click",".close",(function(e){e.preventDefault(),o.set("")})),e(window).on("snippet",(function(e,t,n){t&&o.set(t,n)}))}(e(".js-filter-snippet",d));h.on("change",(function(t){var o=d.offset().top;window.offsetTop&&(o-=window.offsetTop),e("html, body").animate({scrollTop:o},300);var a=window.location.pathname;t&&(a+="#snippet="+t),window.history.pushState&&window.history.pushState(null,"",a),n.setTextSnippet(t),n.reload()}));var f,p=h.getFromHash();p&&h.set(p),n.on("before.load",a.loaderShow),n.on("after.load",a.loaderHide),l.on("change",n.load),a.on("click",(f=+d.data("reloadFirst")||0,function(){f?(--f,n.reload(),c(".comments-data-za","show_more")):n.load()})),i.on("click",(function(){n.next()})),r.on("click",(function(){n.prev()})),s.hasOwnProperty("comment_id")&&a.trigger("click"),m.on("remain",(function(e){a.remain(e,n.limit(),n.hasMore()),i.available(e),r.available(n.skip(),n.onpage())})),e(window).on("resize",(function(){a.remain(n.remain(),n.limit(),n.hasMore())})),a.remain(n.remain(),n.limit(),n.hasMore())}}(),d.on("click",".js-comment-show-full",(function(t){t.preventDefault();var n=e(this).closest(".js-comment-text"),o=n.find(".js-comment-short-text");n.find(".js-comment-additional-text").html()&&(o.find(".js-comment-show-full, .js-comment-splitmarker").addClass("hidden"),o.find(".js-comment-content").append('<span class="js-comment-appended-text">'+n.find(".js-comment-additional-text").html()+"</span>"),n.find(".js-comment-hide").removeClass("hidden"),window.dispatchEvent(new Event("height")))})),d.on("click",".js-comment-load-full",(function(t){t.preventDefault();var n=e(this).closest(".js-comment-text"),o=n.find(".js-comment-short-text"),a=n.closest(".js-comment").data("id");e.get("/js.php",{area:"service",action:"CommentSingle",organizationId:d.data("ownerId"),commentId:a},(function(e){e.success&&(e.contentAdditional&&o.find(".js-comment-content").append('<span class="js-comment-appended-text">'+e.contentAdditional+"</span>"),e.secondPart&&e.secondPart.length>0&&e.secondPart.forEach((function(e){o.append('<div class="comment-text-subtitle">'+e.title+'</div><span class="js-comment-content">'+e.content+"</span>")})),o.find(".js-comment-load-full, .js-comment-splitmarker").addClass("hidden"),n.find(".js-comment-hide").removeClass("hidden"),window.dispatchEvent(new Event("height")))}))})),d.on("click",".js-comment-hide",(function(t){t.preventDefault();var n=e(this).closest(".js-comment-text"),o=n.find(".js-comment-short-text");n.find(".js-comment-hide").addClass("hidden"),o.find(".js-comment-show-full, .js-comment-splitmarker").removeClass("hidden"),o.find(".js-comment-appended-text").remove(),window.dispatchEvent(new Event("height"))})),d.on("click",".js-subcomment-show-other",(function(t){t.preventDefault();var n=e(this),o=n.closest(".js-subcomment-list");n.closest(".js-comment").find(".js-comment-show-full").trigger("click"),o.find(".js-subcomment-other").removeClass("hidden"),o.find(".js-subcomment-list").removeClass("hidden"),n.parent(".service-block-collapse").remove(),window.dispatchEvent(new Event("height"))})),d.on("click",".js-comment-photos-show-more",(function(t){t.preventDefault();var n=e(this),o=e(this).closest(".js-comment"),a=o.find(".js-comment-photos-list:first");if(1==n.data("photos"))return n.hide(),void a.find(".comment-image-cropped").removeClass("comment-image-cropped");e.get("/js.php",{area:"messages",action:"photos",owner_id:o.data("id"),owner_type:o.data("type"),offset:1},(function(e){n.hide(),a.append(e),o.find(".js-comment-photos-list-wrapper:first").removeClass("hidden"),a.find(".comment-image-cropped").removeClass("comment-image-cropped"),lazyload(o[0]),window.dispatchEvent(new Event("height"))}))})),i={fb:"https://www.facebook.com/sharer/sharer.php?s=100&p[title]={title}&p[summary]={description:300}&p[url]={url}",vk:"https://vk.com/share.php?url={url}&title={title}&description={description:550}&noparse=false",tw:"https://twitter.com/share?url={url}&text={description:300}",ok:"https://connect.ok.ru/offer/?url={url}&title={description:300}",gp:"https://plus.google.com/share?url={url}"},e(".js-comment-list",d).on("click",".js-share-controls .js-share-button",(function(t){var n,o,a=e(this),s=a.closest(".js-comment");t.preventDefault(),(n=i[a.data("counter")])&&(o={url:window.location.href+"#"+s.attr("id"),title:(+s.data("isMy")?"О":s.data("author")+" о")+"ставил"+("F"===s.data("authorGender")?"а":"")+" отзыв "+d.data("shareAbout"),description:s.find(".js-comment-text").text()},n=n.replace(/\{([^{}]*)\}/g,(function(e,t){return(t=t.split(":")).length>1&&(o[t[0]]=o[t[0]].substr(0,t[1])),encodeURIComponent(o[t[0]])||""})),e.post("/js.php",{area:"misc",action:"share",object_type:"comment",object_id:s.data("id"),counter_type:a.data("counter")},(function(){var e=a.find("span");e.text((+e.text()||0)+1)})),window.open(n,"open_window","width=626, height=436"))})),e(".js-comment-list",d).on("click",".comment-share-button",(function(t){var n=e(this);n.next(".comment-share-balloon").hasClass("get-out")&&requirejs(["js2/Balloon"],(function(e){var t=new e(n.next(".comment-share-balloon"),{padding:5});t.show(n),t.on("hide",(function(){t=null}))}))})),e(".js-comment-list",d).on("click",".js-comment-complaint",(function(t){t.preventDefault();var n=e(this).data("id");create_layer("complaint_comment",{parameters:{id:n}})})),(r=d.get(0)).addEventListener&&r.addEventListener("load",(function(t){var n=t.target||t.srcElement;if(n&&"IMG"===n.tagName.toUpperCase()){var o=e(n);o.hasClass("js-no-height")&&(!o.data("original")||o.prop("src")===o.data("original"))&&o.height()>parseInt(o.data("maxHeight"),10)&&o.parent().addClass("comment-image-cropped").removeClass("oh").css("max-height","").closest(".js-comment-photos-list-wrapper").find(".js-comment-photo-limiter").removeClass("hidden")}}),!0),d.on("click",".js-comment-photoview-item",(function(t){if(t.preventDefault(),d.find(".js-feedbacks-new").length)var n=d.find(".feedbacks-new").find(".js-comment-photoview-item");else n=e(this).closest(".js-comment-photoview").find(".js-comment-photoview-item");create_layer("photoview",{usecache:!1,offset:0,images:e.map(n,(function(t){return{src:e(t).data("src")}})),current:n.index(this),total:n.length}),c(".comments-data-za","photo_view")}))}})),define("js2/RatingChangeBlock",["jquery","js2/Observable"],(function(e,t){var n="RatingChangeBlock";function o(t,a,s,i,r,d,m,c){if(!(this instanceof o))return new o(t,a,s,i,r,d);var l=this;this.initObservable();var h=t.data(n);if(h)return h;var f=e(t).closest(".js-reviews-module"),p=Array.prototype.slice.call(arguments,1),u=s;"organization"===u&&(u="service");var v,g=f.find(".stars-view[data-val]"),w=e(".star-item",g),_=g.data("val"),j=parseInt(e(".js-comments-total-rating-holder").find(".js-total-count").text()),y=e(".js-heading-rating-holder"),C=e(".star-item",y),b=e(".js-comments-total-rating-holder");i=g.data("my")||void 0;var k=!1,$=null,x=null;function z(t,n){var o=n%5+1===i;e(t).toggleClass("star-selected",o)}function q(){var t=window.needShowOrgMarkReCaptcha&&"service"===u;A(),g.on("mouseleave."+n,T),w.on("mouseenter."+n,(function(){I(e(this).data("pos"))})).on("mouseleave."+n,(function(){v=e(this).closest(".js-comment-form").find("input[name=mark_value]").val()||v,I(_),d&&I(v)})),t?(w.on("click."+n,(function(){R(this)})),C.on("click."+n,(function(){R(this)}))):(w.on("click."+n,(function(){E(this)})),C.on("click."+n,(function(){E(this)})))}function E(t,n){var o=+e(t).data("pos"),i=(w.index(t),null),c=0===e(t).closest("form.js-comment-form").length?1:0,h=o;function p(t){f.find(".js-comment-form").find('input[name="mark_value"]').val(o),m||e(window).trigger({type:"rating_change",user_rating:o,review_rating:o,review_mark:h,total_count:t})}if(v=o,d&&e(t).closest(".js-reviews-stars").length>0)p(j);else{var _={area:u,action:"mark",id:a,value:o,type:r,show_auth_for_guest:c};n&&(_.token=n),e.post("/js.php",_,(function(t){var n=this;t.success?(g.closest(".js-comment-form").length&&(f.find(".js-comment-form").find('input[name="mark_value"]').val(o),h=o),e(window).trigger({type:"rating_change",user_rating:o,total_rating:t.value,review_rating:v,total_count:t.count,tooltip:t.tooltip}),l.trigger("ratingChange",o,t.value,t.count),d&&p(j+1)):t.layer?create_layer("phone_confirm",{message:t.message,parameters:{type:"rating",owner_type:s,owner_id:a},onConfirmed:function(t){e.ajax(n)}}):t.auth?(create_layer("auth",{title:t.message}),i=t.ev_extra):t.refused_message&&alert(t.refused_message)}))}var y=["rating","send"];i&&y.push("",i),m||e(window).trigger("track-event",y)}function R(t){var n=f.attr("id"),o="onloadCallback"+n;if(window.hasOwnProperty(o))null!==$&&(x=t,grecaptcha.execute($));else{var a="g-recaptcha-"+n;window[o]=function(){$=grecaptcha.render(a,{sitekey:window.reCaptchaSiteKey,size:"invisible",callback:function(e){grecaptcha.reset($),null!==x&&E(x,e)}}),x=t,grecaptcha.execute($)};var s='<button id="'+a+'" class="hidden" style="display: none;"></button>',i='<script src="//www.google.com/recaptcha/api.js?onload='+o+'&render=explicit" async defer><\/script>';g.parent().append(e(s)),g.parent().append(e(i))}}function A(){g.off("."+n),w.off("."+n),C.off("."+n)}function T(){"total"===r||"user_total"===r?I(_):"user"!=r||d?"user"==r&&d&&I(v):I(i)}function I(t){if((!g.closest(".js-reviews-stars").length||d)&&"user"===r){var n=g.closest(".js-reviews-stars").find(".star-item");n.length||(n=g.find(".star-item")),n.each((function(){var n=S(e(this).data("pos"),t);e(this).find("span").css("width",n+"%").show()}))}}function S(e,t){var n=1*(100*(t-e+1)).toFixed(1);return n>100?n=100:n<0&&(n=0),n}l.init=function(){if(t.length)return k||(k=!0,"user"!=r&&"user_total"!=r||(q(),g.css("cursor","pointer"),y.css("cursor","pointer")),e(window).on("rating_change",(function(t){i=t.user_rating,_=t.total_rating||_,v=t.review_rating,g.attr("title")&&g.attr("title",t.tooltip),g.data("my",i),g.data("val",_),"user_total"===r&&(g.find(w).each((function(e){var t=parseFloat(_.toFixed(1));z(this,e),y.find(".rating-value").text(t),b.find(".stars-view-big-total").text(t)})),y.each((function(){var t=e(this);1===parseInt(t.data("sync-star-selected"))&&t.find(".star-item").each((function(e){z(this,e)}))}))),T()})),T(),t.data(n,l)),l},l.destroy=function(){A(),e.removeData(t,n)},l.clone=function(t){e.removeData(t,n),o.apply(null,[e(t)].concat(p)).init()},l.forceUpdateRating=function(e){I(e)}}return o.clone=function(t){var o=e(t).data(n);o&&o.clone(t)},Object.assign(o.prototype,t.prototype),o})),define("js2/ParameterArray",[],(function(){var e={set:function(e,t,n){var o=!1,a={name:t,value:n+""},s=e.map((function(e){return e.name!=t?e:(o=!0,a)}));return o||s.push(a),s},has:function(e,t){return e.some((function(e){return e.name==t}))},getAll:function(e,t){return e.filter((function(e){return e.name==t}))},get:function(e,t,n){var o=e.filter((function(e){return e.name==t}));return o.length?o[0].value:n},remove:function(e,t,n){return void 0===n?e.filter((function(e){return e.name!=t})):e.filter((function(e){return e.name!=t||e.value!=n}))},removeEmpty:function(e){return e.filter((function(e){return""!=e.value}))},unserialize:function(e){var t=[];try{!function(){for(var n,o=/\+/g,a=/([^&=]+)=?([^&]*)/g,s=function(e){return decodeURIComponent(e.replace(o," "))},i=e;n=a.exec(i);)t.push({name:s(n[1]),value:s(n[2])})}()}catch(e){}return t},serialize:function(e){var t=[];for(var n in e){var o=e[n];t.push(encodeURIComponent(o.name)+"="+encodeURIComponent(o.value))}return t.join("&")},toHash:function(e,t){var n=t||{};for(var o in e){var a=e[o];n[a.name]=a.value}return n},fromHash:function(e){var t=[];for(var n in e)t.push({name:n,value:e[n]});return t}};return e})),define("js2/CommentFormNew",["jquery","./Observable","./Cookie","./RatingChangeBlock","./ParameterArray","js2/ZATimer","./env"],(function(e,t,n,o,a,s,i){var r=function(t,n){n=n||{};this.node=t,this.$node=e(this.node),this.is_authorized=n.is_authorized||!1,this.anonymous=this.$node.data("anonymous")||0,this.is_fileupload_enabled=n.is_fileupload_enabled||!1,this.editable_tracker=!1,this.is_official=n.is_official||!1,this.authRequired=n.authRequired||!1,this.authToReview=n.authToReview||!1,this.phoneRequired=n.phoneRequired||!1,this.is_detached_page=n.is_detached_page,this.review_page_url=n.review_page_url,this.ab_test_new_comments=n.ab_test_new_comments,this.openModalFormOnInit=n.openModalFormOnInit||!1,this.currentUserIsOwnerOrg=n.currentUserIsOwnerOrg,this.redirect_after_send=n.redirect_after_send,this.canCommentAdd=null,this.init()};return r.prototype={init:function(){var t=this;(t.$list=e(".js-comment-list",t.node),t.$form=e(".js-comment-form",t.node),t.$loader=e(".js-loader",t.node),t.count=1*t.$list.data("count"),t.initForm(),t.openModalFormOnInit&&!t.currentUserIsOwnerOrg&&!t.authRequired&&!t.phoneRequired&&!this.is_authorized||sessionStorage.getItem("wasAuthed")&&!t.currentUserIsOwnerOrg)&&(sessionStorage.removeItem("wasAuthed"),t.$node.find(".js-comment-add").addClass("active"),t.showForm(e(".js-comment-form-container",t.node),e(this),"",""));t.$node.on("click",".js-comment-delete",(function(n){n.preventDefault();var o=e(".js-service-nav").find("[data-id=reviews]").find("span span"),a=o.text()||0,s=t.$node.find(".js-reviews-top-panel"),i=s.length&&s.find(".H3 span");a-1==0?(o.addClass("hide"),t.$node.find(".js-reviews-top-panel").addClass("hide")):a-1>0&&(o.text(+a-1),i.length>0&&i.text(+a-1)),t.remove(e(this).closest('li[data-type="comment"]'))})),t.$node.on("click",".js-textarea-clean",(function(e){e.preventDefault(),t.$form.find(".js-comment-textarea").val(""),t.$form.find(".js-comment-textarea").css("height","")})),t.$form.on("keyup input",".js-comment-textarea",(function(t){var n=this.offsetHeight-this.clientHeight;e(this).css("height","auto").css("height",this.scrollHeight+n)})),t.$form.on("click input","textarea[name=content], input[name=name]",(function(n){if(t.authRequired)t.showAuthForm(t.authRequired.message);else{var o=t.$form.find(".js-textarea-clean"),a=1;e(this).closest(".js-name-input").length&&(a=2),e(this).val().length>=a&&e(this).closest(".form-field").removeClass("invalid"),"content"===this.name&&o.toggleClass("hidden",!this.value.length)}})),t.$form.on("click",".js-user-rating-holder",(function(t){t.preventDefault(),e(this).find(".star-selected").length&&e(this).closest(".form-field").removeClass("invalid")})),t.$node.find(".textarea textarea").on("input",(function(e){t.authRequired&&t.showAuthForm(t.authRequired.message),e.stopPropagation()})),t.$node.on("click",".js-mark",(function(n){n.preventDefault(),t.mark(e(this))})),lazyload(t.node),t.trackEditable(),t.is_authorized?t.postTemp("tempApprove","#reviews"):(n.remove("tmp_comment_id"),n.remove("tmp_comment_token"))},initForm:function(){var t=this;if(t.$form[0]){t.$form.on("submit.comment",(function(e){e.preventDefault(),t.submit(this)})),s.track(".js-comment-add[data-za]",{ev_action:"write_comment_display"},{interval:s.DISPLAY_INTERVAL,visible_percent:s.VISIBLE_PERCENT}),s.track(".js-review-header",{ev_action:"display_short",ev_category:"comments"},{interval:0,visible_percent:1});var n=function(){t.changeAddButtonText(t.$form,i18n.t("reviews.send")),s.trigger(".js-comment-add[data-za]",{ev_action:"write_comment_display"},{send_once:!0});var n=e(t.$node).data();if(t.sendStat(e(".js-comment-add[data-za]",t.$node),"write_comment_click",t.authRequired?t.authRequired.ev_extra:null),e(window).trigger("track-event.metrika",["comments","write_comment_click"]),"logic"===t.ab_test_new_comments&&!t.authToReview||sessionStorage.getItem("wasAuthed")||t.is_authorized||"simple"===t.ab_test_new_comments||sessionStorage.setItem("wasAuthed","true"),t.phoneRequired)t.showPhoneConfirm(n,t.phoneRequired.message,(function(){var n=e(this);n.hasClass("active")?n.removeClass("active"):"logic"!==t.ab_test_new_comments||"1"!==t.is_detached_page||t.authToReview?(n.hasClass("js-comment-edit-top")&&e(".js-comment-reply, .js-comment-edit",n).removeClass("active"),n.addClass("active"),t.showForm(e(".js-comment-form-container",t.node),e(this),"","")):window.location.href=t.review_page_url}));else if(t.authRequired||!t.is_authorized&&"logic"===t.ab_test_new_comments)t.showAuthForm(t.authRequired.message,(function(){t.authRequired||t.showForm(e(".js-comment-form-container",t.node),e(this),"","")}));else if(!this.currentUserIsOwnerOrg){if("logic"===t.ab_test_new_comments&&"1"===t.is_detached_page&&!t.authToReview)return void setTimeout((function(){window.location.href=t.review_page_url}),0);t.showForm(e(".js-comment-form-container",t.node),e(this),"",""),e(".js-comment-delete",t.$form).addClass("hide");var o=t.$node.find(".js-your-comment");o.length>0&&o.addClass("hide"),e(".rating-field, .js-user-rating-holder",t.$form).show()}};t.$node.on("click",".js-comment-add",(function(o){o.preventDefault();var s=e(this);if(!s.hasClass("disabled"))if(!0!==t.canCommentAdd)if(!1!==t.canCommentAdd){var i=e.extend(a.toHash(t.$form.serializeArray()),{area:"messages",action:"canCommentAdd"}),r=s.css("cursor");s.addClass("disabled"),s.css({cursor:"wait"}),e.post("/js.php",i,(function(e){if(e.success)t.canCommentAdd=!0,n();else{var o="comment-in-category"===e.message,a=o?i18n.t("reviews.has_comment_in_category"):e.message;t.canCommentAdd=!o&&null,alert(a)}}),"json").done((function(){s.removeClass("disabled"),s.css({cursor:r})}))}else alert(i18n.t("reviews.has_comment_in_category"));else n()})),t.$node.on("click",".js-comment-reply",(function(n){n.preventDefault(),e(".rating-field, .js-user-rating-holder",t.$form).hide(),t.$form.removeClass("js-editing"),t.changeAddButtonText(t.$form,i18n.t("reviews.send"));t.showForm(e(this).closest(".js-comment-container"),e(this),e(this).closest("li").data("id")||"",""),e(".js-comment-delete",t.$form).addClass("hide"),t.sendStat(e(this).closest(".js-comment"),"answer",{})})),t.$node.on("click",".js-comment-reset",(function(n){n.preventDefault(),t.hideForm();var o=e(this).closest(".js-comment-container"),a=o.find(".js-comment-container-wrapper"),s=o.find(".js-your-comment");t.$node.find(".js-comment-add").removeClass("active"),e(this).closest(".js-edit-first-comment").length?(t.$node.find(".js-comment-add").addClass("active"),t.$node.find(".js-comment-edit-top").removeClass("active"),e(this).closest(".js-comment").find(".js-comment-container-wrapper").removeClass("hide")):(e(this).closest(".js-subcomment-list").length||e(this).closest(".js-comment-container-wrapper"))&&t.$node.find(".js-comment-add").removeClass("active"),a.removeClass("hide"),s.addClass("hide")})),t.$node.on("click",".js-comment-no-reply",(function(n){n.preventDefault(),t.keepWithNoReply(e(this).closest("li"),e(this).closest("form"))})),t.$node.on("click",".js-comment-edit-top",(function(n){if(!e(this).data("isLink")){t.changeAddButtonText(t.$form,i18n.t("reviews.change_review")),n.preventDefault();var o=t.$node.find(".js-your-comment");o.length>0&&o.addClass("hide");var a=t.$node.find('.js-comment[data-is-my="1"]').first();a.find(".js-comment-container-wrapper").addClass("hide"),t.showForm(a.find(".js-comment-container").first(),e(this),"",a.data("id")||""),a.find(".js-your-comment").first().removeClass("hide"),e(window).trigger("track-event",["comments","edit"])}})),t.$node.on("click",".js-comment-edit",(function(n){if(!e(this).data("is-link")){t.changeAddButtonText(t.$form,i18n.t("change_review")),n.preventDefault(),t.$node.find(".js-comment-edit-top").addClass("active");var o=t.$node.find(".js-your-comment");o.length>0&&o.addClass("hide"),t.$form.addClass("js-editing");if(t.authRequired)t.showAuthForm(t.authRequired.message),t.authRequired.ev_extra;else{var a=e(this).closest(".js-comment-container"),s=a.find(".js-comment-container-wrapper"),i=a.closest('.js-comment[data-is-my="1"]'),r=a.closest(".js-subcomment-list").length>0,d=i.closest("li").data("id")||"";t.showForm(e(this).closest(".js-comment-container"),e(this),r?d:"",i.data("id")||""),e(".js-comment-delete",t.$form).removeClass("hide"),s.addClass("hide"),e(this).closest(".js-subcomment-list").length?(e(".rating-field, .js-user-rating-holder",t.$form).hide(),t.sendStat(e(this).closest(".js-comment"),"edit_answer")):(e(".rating-field, .js-user-rating-holder",t.$form).show(),t.sendStat(e(this).closest(".js-comment"),"edit")),i.removeClass("hide")}}})),t.bindImagesUpload(t.$form)}},changeAddButtonText:function(e,t){e.find(":submit").text(t)},submit:function(t){var o=this,s=t.length?e(t):o.$form,i=e("textarea",s),r=s.find(".js-name-input"),d=s.find(".js-user-rating-holder"),m=s.closest(".js-edit-first-comment").length,c=e.extend(a.toHash(s.serializeArray()),{area:"messages",action:"post"});if(r.length&&r.val().length<2)r.closest(".form-field").addClass("invalid");else if(d.length&&d.is(":visible")&&!d.find(".star-selected").length)d.closest(".form-field").addClass("invalid");else if(0!==i.val().length){if(e.trim(c.content)&&!(s.find(".min-length-notice").data("minlength")>e.trim(c.content).length)){var l;o.is_authorized||o.anonymous?o.anonymous&&(c.anonymous=1):c.temp=1;var h,f=o.$form.hasClass("js-editing"),p=s.closest(".js-comment").length,u=o.$form.closest(".js-subcomment-list").length;p&&!f?(l="send_answer",h=["comments","send_answer"]):p&&!u&&f?(l="save_edited",h=["comments","save_edited"]):p&&u&&f?(l="save_edited_answer",h=["comments","save_edited_answer"]):(l="write_comment",h=["comments","send","write_comment"]),f&&o.$node.find(".js-comment-edit-top").removeClass("hide"),e(":submit",s).prop("disabled",!0),o.$loader.show(),e.post("/js.php",c,(function(t){var a=this;return t.layer_success_editable&&alert(i18n.t("reviews.layer_success_editable")),t.success?(e(window).trigger({type:"rating_change",user_rating:+c.mark_value,review_mark:+c.mark_value,total_count:t.count}),s.find(".js-comment-image:gt(0)").remove(),s.find("[name=photo_owner_id]").val("").trigger("change"),s.find("[name=photo_owner_type]").val("").trigger("change"),d.find(".js-reviews-stars").length&&o.$node.find(".js-total-count").text(parseInt(t.count)),i.val(""),s.hasClass("js-comment-form-cloned")?e("html, body").animate({scrollTop:o.$node.offset().top+"px"},300):(s.closest(".js-comment-container").find(".js-comment-reply, .js-comment-add, .js-comment-edit, .js-comment-edit-top").removeClass("active"),s.slideUp((function(){window.dispatchEvent(new Event("height"))}))),s.closest(".js-comment").length?m&&(o.$node.find(".js-comment-edit-top").removeClass("active"),s.closest(".js-comment").find(".js-comment-container-wrapper").removeClass("hide")):(o.$node.find(".js-comment-add").addClass("active"),o.$node.find(".js-comment-edit-top").removeClass("hide")),!c.id&&c.temp?(o.showAnonymous(s.find("[name=name]").val()),n.set("tmp_comment_id",t.message_tmp_id,3600),void n.set("tmp_comment_token",t.message_token,3600)):(o.redirect_after_send&&(window.location.href=o.redirect_after_send),o.appendComment(t),void o.trackEditable())):(t.emptyRating&&d.closest(".form-field").addClass("invalid"),t.layer?void create_layer("phone_confirm",{message:t.message,parameters:{type:"comments",owner_type:c.owner_type,owner_id:c.owner_id},needAuth:!c.id&&c.temp,onConfirmed:function(){e.ajax(a)}}):t.auth?void o.showAuthForm(t.message):("censure"!==t.message&&"empty content"!==t.message&&"wrong-length-content"!==t.message&&"third-party-link"!==t.message||alert(i18n.t("reviews.invalid_message_error")),"comment-in-category"===t.message&&alert(i18n.t("reviews.has_comment_in_category")),void(t.timeout&&alert(i18n.t("reviews.edit_message_timeout")))))}),"json").done((function(){o.$loader.hide(),e(":submit",s).prop("disabled",!1)})).always((function(t){!t.success&&t.auth&&h.push("",t.ev_extra);var n=o.$node.find(".comments-data-za");n.data("za")?o.sendStat(n,l):e(window).trigger("track-event",h);var a=e(".js-service-nav").find("[data-id=reviews]"),s=o.$node.find(".js-reviews-top-panel");if(0===a.find("span").length)a.prepend('<span class="pull-right mg-left-xs"><span class="gray simple-text">1</span></span>');else if(a.find("span span").hasClass("hide"))a.find("span span").removeClass("hide"),a.find("span span").text(1),s&&s.removeClass("hide");else{var i=a.find("span span"),r=i.text(),d=o.$node.find(".js-reviews-top-panel").find(".H3 span");i.text(+r+1),d.text(+r+1)}}))}}else i.closest(".form-field").addClass("invalid")},showAuthForm:function(e,t){var n="logic"===this.ab_test_new_comments&&!this.authToReview;create_layer("auth",{onConfirmed:t,sourceType:"comments",target_action:n?"":"reviews",go_to_new_comments:n})},showPhoneConfirm:function(e,t,n){window.za({ev_category:"phone_verification",ev_action:"display_short",ev_type:"event",ev_sourceType:"comments"}),create_layer("phone_confirm",{message:t,parameters:{type:"comments",owner_type:e.collectionName,owner_id:e.ownerId},needAuth:this.authRequired,skipLastStep:!0,onConfirmed:n})},showForm:function(t,n,o,a){var s=this;if(s.$form[0]){if(n.hasClass("active"))return n.removeClass("active"),void s.$form.slideUp((function(){window.dispatchEvent(new Event("height"))}));n.hasClass("js-comment-edit-top")&&(e(".js-comment-reply, .js-comment-edit",s.node).removeClass("active"),t.addClass("js-edit-first-comment")),n.addClass("active");var i=function(o,a,i,r,d,m,c){s.$form.removeClass("invalid"),s.$form.slideUp((function(){s.$form.appendTo(t).slideDown((function(){window.dispatchEvent(new Event("height"))})),s.$form.find("input[name=parent_id]").val(a);var l=s.$form.find("input[name=id]").val();if(s.$form.find("input[name=id]").val(o),o||l){s.$form.find(".js-comment-image:gt(0)").remove(),s.$form.find("[name=photo_owner_id]").val("").trigger("change"),s.$form.find("[name=photo_owner_type]").val("").trigger("change"),s.$form.find("textarea").val(i),s.$form.find(".js-name-input").val(m);for(var h=0;h<c;h++)e(s.$form.find(".star-item")[h]).find("span").css("width","100%");e(s.$form.find(".star-item")[c-1]).addClass("star-selected"),s.$form.find("input[name=mark_value]").val(c),s.$form.find("[name=is_official]").val(d||0),s.setPhotos(s.$form,r)}n.hasClass("js-comment-needs-reply")?s.$form.find(".js-comment-no-reply").removeClass("hide"):s.$form.find(".js-comment-no-reply").addClass("hide"),n.hasClass("js-comment-no-photo")?s.$form.find(".js-comment-images-add").addClass("hide"):s.$form.find(".js-comment-images-add").removeClass("hide"),n.attr("data-placeholder")&&s.$form.find("[name=content]").attr("placeholder",n.attr("data-placeholder"));var f=n.data("minlength"),p=s.$form.find('button[type="submit"]'),u=function(){var e=s.$form.find("textarea").val().length;p.prop("disabled",f>e)};n.attr("data-minlength")?(u(),s.$form.on("input propertychange","textarea",u),s.$form.find(".min-length-notice").html(i18n.t("reviews.min_length_notice",{minlength:f})).data("minlength",n.attr("data-minlength")).show()):(p.prop("disabled",!1),s.$form.off("input propertychange","textarea",u),s.$form.find(".min-length-notice").data("minlength",!1).hide());var v=s.$form.data("possible-owner-ids");if(a&&v){var g=e("#comment"+a).data("other-ids");for(h=0;h<g.length;h++)if(v.indexOf(g[h])>-1){s.$form.find("[name=owner_id]").val(g[h]);break}}}))};if(a)e.post("/js.php",{area:"messages",action:"getPost",id:a},(function(e){e.success&&i(a,o,e.content,e.photos||[],e.is_official,e.name,e.mark_value)}),"json");else{var r=s.$form.find('input[name="name"]').val();i("",o,"",[],this.is_official,r)}}},hideForm:function(){var t=this.$form;t&&(t.hasClass("js-comment-form-cloned")||(e(".js-comment-reply, .js-comment-add, .js-comment-edit",this.node).removeClass("active"),t.slideUp((function(){window.dispatchEvent(new Event("height"))}))))},remove:function(t){var n=this,o=t.data("id"),s=t.closest(".js-subcomment-list").length;if(o){e(".js-comment-delete",n.$form).prop("disabled",!0);var i,r=e.extend(a.toHash(n.$form.serializeArray()),{area:"messages",action:"delete",id:o});e.post("/js.php",r,(function(o){o.success&&(e(".js-comment-delete",n.$form).prop("disabled",!1),s||(n.$node.find(".js-comment-edit-top").removeClass("active"),n.$node.find(".js-comment-edit-top").addClass("hide"),n.$node.find(".js-comment-add").removeClass("active hide")),n.$form.slideUp((function(){var o=t.closest(".subcomments");e(".js-comment-form-container",n.node).append(n.$form),t.remove(),n.count--,n.trackEditable(),o.has("li").length||o.addClass("hidden"),window.dispatchEvent(new Event("height"))})))}),"json"),i=t.closest(".js-subcomment-list").length?"delete_answer":"delete";var d=n.$node.find(".comments-data-za");d.data("za")?n.sendStat(d,i):e(window).trigger("track-event",["comments",i])}},trackEditable:function(){var t=this;!t.editable_tracker&&t.$node.has(".js-comment-edit")&&(t.editable_tracker=setInterval((function(){var n=0,o=0;e(".js-comment-edit",t.$node).each((function(){var a=e(this),s=a.closest(".edit-comment-balloon-item"),i=parseInt(a.data("edit-timeout")),r=t.$node.find(".js-comment-edit-top"),d=a.closest(".js-subcomment-list").length;if(i--,n++,i<=0)return a.remove(),s.remove(),d||r.remove(),void o++;a.data("edit-timeout",i);var m=Math.floor(i/86400),c=Math.floor(i/3600%24),l=Math.floor(i/60%60),h=i%60,f="",p=i18n.t("common.day_short"),u=i18n.t("common.hour_short"),v=i18n.t("common.minute_short");f=m>=2?m+" "+p:m>=1?m+" "+p+" "+c+" "+u:c>=1?c+" "+u+" "+l+" "+v:(l=l<10?"0"+l:l)+":"+(h=h<10?"0"+h:h),e(">span",a).html(f)})),n==o&&(clearInterval(t.editable_tracker),t.editable_tracker=!1)}),1e3))},showAnonymous:function(t){var n=this;e("body").on("authSuccess.newcomment",(function(t,o){n.postTemp("tempApprove",n.redirect_after_send||o),e("body").off(".newcomment")})),e("body").on("authFail.newcomment",(function(){n.postTemp("tempReject",n.redirect_after_send),e("body").off(".newcomment")})),create_layer("auth",{popstate:i.is_phone,title:i18n.t("comment.auth_form.title"),parameters:{feedback:!0,user_name:t},target_action:"reviews",sourceType:"comments"})},postTemp:function(t,o){var a=this,s=n.get("tmp_comment_id"),i=n.get("tmp_comment_token");s&&i&&e.ajax({cache:!1,dataType:"json",url:"/js.php",type:"get",data:{area:"messages",action:t,id:s,token:i}}).done((function(e){e.success&&(n.remove("tmp_comment_id"),n.remove("tmp_comment_token"),a.appendComment(e,o),a.trackEditable())}))},appendComment:function(t,n){var o,a=this,s=e(">li","<div>"+t.message+"</div>"),i=s.find(".js-moderation-text");if(i.length&&i.on("animationend",(function(){e(this).removeClass("moderation-text_added")})),t.id)return(o=e('li[data-id="'+t.id+'"]>.comment-container',a.node)).children(":not(form)").remove(),o.prepend(e(">.comment-container",s).children()),o.slideDown(),void(a.is_fileupload_enabled&&lazyload(a.node));(o=t.parent_id?e('li[data-id="'+t.parent_id+'"]',a.node).find(".js-subcomment-list:first"):a.$list).removeClass("hidden"),s.hide().prependTo(o).slideDown(),a.is_fileupload_enabled&&lazyload(a.node),a.count++,n&&(window.location.href=n)},mark:function(t){var n=t.closest(".js-question"),o=e(".js-mark",n),a=t.data("val");parseInt(t.find(".mark-text").text());t.toggleClass("active"),t.siblings(".js-mark").hasClass("active")&&t.siblings(".js-mark").removeClass("active"),e.post("/js.php",{area:"messages",action:"mark",id:n.data("id"),value:a},(function(e){e.success&&(o.filter("[data-val=1]").find(".mark-text").text(e.mark_sum_formatted),o.filter("[data-val=0]").find(".mark-text").text(e.mark_total_formatted))})),t.hasClass("plus")&&t.hasClass("active")?this.sendStat(t.closest(".js-comment"),"like"):t.hasClass("minus")&&t.hasClass("active")&&this.sendStat(t.closest(".js-comment"),"dislike")},bindImagesUpload:function(t){var n=this;this.is_fileupload_enabled&&!t.hasClass("js-zfileuploader-binded")&&(t.addClass("js-zfileuploader-binded"),requirejs(["zfileuploader"],(function(){var o=t.find(".js-comment-images"),a=(o.find(".js-comment-image").eq(0),t.find(".js-comment-images-add-error")),s=t.find(".js-comment-images-add").show();o.find(".js-comment-image:gt(0)").remove(),o.on("click",".js-comment-image-delete",(function(o){o.preventDefault();var a=e(this).closest("li");a.hide("fast",(function(){window.dispatchEvent(new Event("height"))})),e.post("/js.php",{area:"messages",action:"removePhoto",photo_id:a.data("id")},(function(){a.remove(),n.checkPhotoCount(t)}))}));var r={action:"uploadPhoto",area:"messages"};t.find("[name=photo_owner_id]").on("change",(function(){r.hasOwnProperty("photo_owner_id")&&delete r.photo_owner_id,this.value&&(r.photo_owner_id=this.value)})),t.find("[name=photo_owner_type]").on("change",(function(){r.hasOwnProperty("photo_owner_type")&&delete r.photo_owner_type,this.value&&(r.photo_owner_type=this.value)}));var d='<i class="icon-add mg-right-xs s-icons-photo-add-dark"></i><span>'+i18n.t("comment.editor.send_photo")+'</span> <span class="gray">'+i18n.t("comment.editor.put_here")+"</span>",m='<div class="upload-area-text"><span class="uploader-download-icon"><svg width="12" height="15"><use xlink:href="/build/main/icons.svg#download-icon"></use></svg></span><span>'+i18n.t("comment.editor.drag_files")+"</span></div>";i.is_phone&&(d='<i class="icon-add mg-right-xs s-icons-photo-add-dark"></i><span>'+i18n.t("comment.editor.send_photo")+"</span>");var c=new qq.ZFileUploader({element:s[0],action:"/js.php",params:r,multiple:!0,maxConnections:1,debug:!1,template:'<div class="qq-uploader" style="display: inline"><div class="qq-upload-drop-area">'+m+'</div><div class="qq-upload-button iblock middle"><a href="#" onclick="return false;" class="button button-white button-file">'+d+'</a></div><ul class="qq-upload-list hidden middle"></ul></div>',onSubmit:function(){e(":submit",t).prop("disabled",!0)},onUpload:function(e,t,n){return r},onProgress:function(e,t,n,o){var a=this.element.querySelectorAll(".js-comment-image img"),s=n/o*100;if(null!==a)for(var i=0;i<a.length;i++){a[i].classList.add("loading"),a[i].closest(".js-comment-image").querySelector(".js-dropzone-progress-bar").style.width=s+"px"}},onComplete:function(o,s,i,r){var d=this.element.querySelectorAll(".loading"),m=document.querySelectorAll(".js-dropzone-progress-wrapper");if(t.removeClass("invalid"),c.getInProgress()||(e(":submit",t).prop("disabled",!1),n.$loader.hide()),!i.success)return t.find(".comment-file").addClass("invalid"),void a.html(i18n.t("common.photo_upload_error"));n.setPhotos(t,i.photos||[]),t.find(".blog-textarea-nonactive").removeClass("blog-textarea-nonactive");for(var l=0;l<d.length;l++)d[l].classList.remove("loading"),d[l].closest(".js-comment-image").querySelector(".js-dropzone-progress-wrapper").classList.add("hide"),m[l].classList.add("hide")}})})))},setPhotos:function(t,n){var o=document.createElement("div"),a=document.createElement("div");o.classList.add("js-dropzone-progress-wrapper","dropzone-progress-wrapper"),a.classList.add("js-dropzone-progress-bar","dropzone-progress-bar"),o.appendChild(a);for(var s=t.find(".js-comment-images"),i=s.find(".js-comment-image").eq(0),r=e("<ul />"),d=0;d<n.length;d++){var m=n[d];t.find("[name=photo_owner_id]").val()&&t.find("[name=photo_owner_type]").val()||(t.find("[name=photo_owner_id]").val(m.owner_id).trigger("change"),t.find("[name=photo_owner_type]").val(m.owner_type).trigger("change"));var c=i.clone().removeClass("hide").attr("data-id",m.id);c.append(o),e("img",c).attr("src",m.src),e("img",c).addClass("qq-uploaded-img js-comment-image-delete"),r.append(c)}s.append(r.html()),this.checkPhotoCount(t)},checkPhotoCount:function(e){var t=e.find(".js-comment-images-add");e.find(".js-comment-images").find(".js-comment-image:gt(0)").length>=30?t.hide():t.show(),window.dispatchEvent(new Event("height"))},getClonedForm:function(){var t=this;return t.$form[0]?(t.$formCloned||(t.$formCloned=t.$form.clone(!0).addClass("js-comment-form-cloned").removeClass("js-zfileuploader-binded"),t.$formCloned.find("input[name=parent_id]").remove(),t.$formCloned.find("textarea").val(""),t.bindImagesUpload(t.$formCloned),o.clone(t.$formCloned.find(".js-user-rating-holder")[0])),t.$formCloned):e([])},showFormBottomOnRemain:function(t){var n=this;t.on("remain",(function(t){if(!t){var o=e("<div />",{class:"comment-form-container comment-form-container-bottom"});o.append(n.getClonedForm().show()),o.appendTo(n.node),window.dispatchEvent(new Event("height"))}}))},keepWithNoReply:function(t,n){e.ajax({cache:!1,dataType:"json",url:"/js.php",type:"get",data:{area:"messages",action:"noReply",id:t.data("id"),type:t.data("type")}}).done((function(e){e.success?(n.closest(".js-comment-container").find(".js-comment-reply").removeClass("active"),n.slideUp((function(){window.dispatchEvent(new Event("height"))})),n.closest(".js-comment-container").find(".js-comment-reply").removeClass("js-comment-needs-reply button-purple").addClass("button-white")):alert(i18n.t("reviews.comment_save_error"))}))},sendStat:function(t,n,o){var a=t.data("za");a&&(a=a.data,o&&(a.ev_extra=e.extend({},a.ev_extra,o)),window.za(e.extend({},a,{ev_action:n})))}},r}));