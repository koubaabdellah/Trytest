//>>built
define("esri/IdentityManagerBase","dojo/_base/declare dojo/_base/config dojo/_base/lang dojo/_base/array dojo/_base/Deferred dojo/_base/url dojo/sniff dojo/io-query dojo/on ./kernel ./config ./lang ./ServerInfo ./urlUtils ./deferredUtils ./request ./Evented ./OAuthCredential ./arcgis/OAuthInfo".split(" "),function(T,C,y,r,J,H,M,N,O,v,P,A,Q,z,U,E,V,W,X){var K={},Y=function(a){var b=(new H(a.owningSystemUrl)).host;a=(new H(a.server)).host;var c=/.+\.arcgis\.com$/i;return c.test(b)&&c.test(a)},R=function(a,
b){return!!(Y(a)&&b&&r.some(b,function(c){return c.test(a.server)}))},Z=null,aa=null;try{Z=window.localStorage,aa=window.sessionStorage}catch(a){}M=T(V,{declaredClass:"esri.IdentityManagerBase",constructor:function(){this._portalConfig=y.getObject("esriGeowConfig");this.serverInfos=[];this.oAuthInfos=[];this.credentials=[];this._soReqs=[];this._xoReqs=[];this._portals=[];this._getOAuthLocationParams();O(window,"pageshow",y.hitch(this,this._pageShowHandler))},defaultOAuthInfo:null,defaultTokenValidity:60,
tokenValidity:null,normalizeWebTierAuth:!1,_appUrlObj:z.urlToObject(window.location.href),_postMessageAuthHandle:null,_busy:null,_rejectOnPersistedPageShow:!1,_oAuthLocationParams:null,_gwTokenUrl:"/sharing/generateToken",_agsRest:"/rest/services",_agsPortal:/\/sharing(\/|$)/i,_agsAdmin:/(https?:\/\/[^\/]+\/[^\/]+)\/admin\/?(\/.*)?$/i,_adminSvcs:/\/rest\/admin\/services(\/|$)/i,_gwDomains:[{regex:/^https?:\/\/www\.arcgis\.com/i,customBaseUrl:"maps.arcgis.com",tokenServiceUrl:"https://www.arcgis.com/sharing/generateToken"},
{regex:/^https?:\/\/(?:dev|[a-z\d-]+\.mapsdev)\.arcgis\.com/i,customBaseUrl:"mapsdev.arcgis.com",tokenServiceUrl:"https://dev.arcgis.com/sharing/generateToken"},{regex:/^https?:\/\/(?:devext|[a-z\d-]+\.mapsdevext)\.arcgis\.com/i,customBaseUrl:"mapsdevext.arcgis.com",tokenServiceUrl:"https://devext.arcgis.com/sharing/generateToken"},{regex:/^https?:\/\/(?:qaext|[a-z\d-]+\.mapsqa)\.arcgis\.com/i,customBaseUrl:"mapsqa.arcgis.com",tokenServiceUrl:"https://qaext.arcgis.com/sharing/generateToken"},{regex:/^https?:\/\/[a-z\d-]+\.maps\.arcgis\.com/i,
customBaseUrl:"maps.arcgis.com",tokenServiceUrl:"https://www.arcgis.com/sharing/generateToken"}],_legacyFed:[],_regexSDirUrl:/http.+\/rest\/services\/?/ig,_regexServerType:/(\/(FeatureServer|GPServer|GeoDataServer|GeocodeServer|GeoenrichmentServer|GeometryServer|GlobeServer|ImageServer|KnowledgeGraphServer|MapServer|MobileServer|NAServer|NetworkDiagramServer|OGCFeatureServer|ParcelFabricServer|RelationalCatalogServer|SceneServer|StreamServer|UtilityNetworkServer|ValidationServer|VectorTileServer|VersionManagementServer)).*/ig,
_gwUser:/http.+\/users\/([^\/]+)\/?.*/i,_gwItem:/http.+\/items\/([^\/]+)\/?.*/i,_gwGroup:/http.+\/groups\/([^\/]+)\/?.*/i,_errorCodes:[499,498,403,401],_rePortalTokenSvc:/\/sharing(\/rest)?\/generatetoken/i,_publicUrls:[/\/arcgis\/tokens/i,/\/sharing(\/rest)?\/generatetoken/i,/\/rest\/info/i],_createDefaultOAuthInfo:!0,_hasTestedIfAppIsOnPortal:!1,registerServers:function(a){var b=this.serverInfos;b?(a=r.filter(a,function(c){return!this.findServerInfo(c.server)},this),this.serverInfos=b.concat(a)):
this.serverInfos=a;r.forEach(a,function(c){c.owningSystemUrl&&this._portals.push(c.owningSystemUrl);if(c.hasPortal){this._portals.push(c.server);var d=P.defaults.io.corsEnabledServers,e=this._getOrigin(c.tokenServiceUrl);z.canUseXhr(c.server)||d.push(c.server.replace(/^https?:\/\//i,""));z.canUseXhr(e)||d.push(e.replace(/^https?:\/\//i,""))}},this)},registerOAuthInfos:function(a){var b=this.oAuthInfos;b?(r.forEach(a,function(c){(c=this.findOAuthInfo(c.portalUrl))&&b.splice(b.indexOf(c),1)},this),
this.oAuthInfos=b.concat(a)):this.oAuthInfos=a},registerToken:function(a){a=A.mixin({},a);var b=this._sanitizeUrl(a.server),c=this.findServerInfo(b),d=!0,e;c||(c=new Q,c.server=this._getServerInstanceRoot(b),c.tokenServiceUrl=this._getTokenSvcUrl(b),c.hasPortal=!0,this.registerServers([c]));(e=this.findCredential(b,a.userId))?(delete a.server,y.mixin(e,a),d=!1):(e=new F({userId:a.userId,server:c.server,token:a.token,expires:a.expires,ssl:a.ssl,scope:this._isServerRsrc(b)?"server":"portal"}),e.resources=
[b],this.credentials.push(e));e.onTokenChange(!1);d||e.refreshServerTokens()},toJson:function(){return A.fixJson({serverInfos:r.map(this.serverInfos,function(a){return a.toJson()}),oAuthInfos:r.map(this.oAuthInfos,function(a){return a.toJson()}),credentials:r.map(this.credentials,function(a){return a.toJson()})})},initialize:function(a){if(a){y.isString(a)&&(a=JSON.parse(a));var b=a.serverInfos,c=a.oAuthInfos;a=a.credentials;if(b){var d=[];r.forEach(b,function(g){g.server&&g.tokenServiceUrl&&d.push(g.declaredClass?
g:new Q(g))});d.length&&this.registerServers(d)}if(c){var e=[];r.forEach(c,function(g){g.appId&&e.push(g.declaredClass?g:new X(g))});e.length&&this.registerOAuthInfos(e)}a&&r.forEach(a,function(g){g.userId&&g.server&&g.token&&g.expires&&g.expires>(new Date).getTime()&&(g=g.declaredClass?g:new F(g),g.onTokenChange(),this.credentials.push(g))},this)}},findServerInfo:function(a){var b;a=this._sanitizeUrl(a);r.some(this.serverInfos,function(c){this._hasSameServerInstance(c.server,a)&&(b=c);return!!b},
this);return b},findOAuthInfo:function(a){var b;a=this._sanitizeUrl(a);r.some(this.oAuthInfos,function(c){this._hasSameServerInstance(c.portalUrl,a)&&(b=c);return!!b},this);return b},findCredential:function(a,b){var c;a=this._sanitizeUrl(a);var d=this._isServerRsrc(a)?"server":"portal";b?r.some(this.credentials,function(e){this._hasSameServerInstance(e.server,a)&&b===e.userId&&e.scope===d&&(c=e);return!!c},this):r.some(this.credentials,function(e){this._hasSameServerInstance(e.server,a)&&-1!==this._getIdenticalSvcIdx(a,
e)&&e.scope===d&&(c=e);return!!c},this);return c},getCredential:function(a,b){var c=!0;if(A.isDefined(b))if(y.isObject(b)){var d=!!b.token;var e=b.error;c=!1!==b.prompt}else d=b;a=this._sanitizeUrl(a);var g=new J(U._dfdCanceller),l=this._isAdminResource(a);if((d=d?this.findCredential(a):null)&&e&&498===e.code)d.destroy();else if(d)return c=Error("You are currently signed in as: '"+d.userId+"'. You do not have access to this resource: "+a),c.name="identity-manager:not-authorized",c.code="IdentityManagerBase.1",
c.httpCode=e&&e.httpCode,c.messageCode=e?e.messageCode:null,c.subcode=e?e.subcode:null,c.details=e?e.details:null,c.log=!!C.isDebug,g.errback(c),g;if(e=this._findCredential(a,b))return g.callback(e),g;var k=this.findServerInfo(a);if(k)!k.hasServer&&this._isServerRsrc(a)&&(k._restInfoDfd=this._getTokenSvcUrl(a,!0),k.hasServer=!0);else{e=this._getTokenSvcUrl(a);if(!e)return c=Error("Unknown resource - could not find token service endpoint."),c.name="identity-manager:unknown-resource",c.code="IdentityManagerBase.2",
c.log=!!C.isDebug,g.errback(c),g;k=new Q;k.server=this._getServerInstanceRoot(a);y.isString(e)?(k.tokenServiceUrl=e,k.hasPortal=!0):(k._restInfoDfd=e,k.hasServer=!0);this.registerServers([k])}k.hasPortal&&void 0===k._selfReq&&(c||z.hasSameOrigin(k.tokenServiceUrl,window.location.origin)||this._gwDomains.some(function(m){return m.tokenServiceUrl===k.tokenServiceUrl}))&&(k._selfReq={owningTenant:b&&b.owningTenant,selfDfd:this._getPortalSelf(k.tokenServiceUrl.replace(this._rePortalTokenSvc,"/sharing/rest/portals/self"),
a)});return this._enqueue(a,k,b,g,l)},getResourceName:function(a){return this._isRESTService(a)?a.replace(this._regexSDirUrl,"").replace(this._regexServerType,"")||"":this._gwUser.test(a)&&a.replace(this._gwUser,"$1")||this._gwItem.test(a)&&a.replace(this._gwItem,"$1")||this._gwGroup.test(a)&&a.replace(this._gwGroup,"$1")||""},generateToken:function(a,b,c){var d=this._rePortalTokenSvc.test(a.tokenServiceUrl),e=new H(window.location.href.toLowerCase()),g=!b;var l=a.shortLivedTokenValidity;if(b){var k=
v.id.tokenValidity||l||v.id.defaultTokenValidity;k>l&&(k=l)}if(c){var m=c.isAdmin;var f=c.serverUrl;var h=c.token;var t=c.ssl;a.customParameters=c.customParameters}if(m)l=a.adminTokenServiceUrl;else{l=a.tokenServiceUrl;var p=new H(l.toLowerCase());a.webTierAuth&&c&&c.serverUrl&&!t&&"http"===e.scheme&&(z.hasSameOrigin(e.uri,l,!0)||"https"===p.scheme&&e.host===p.host&&"7080"===e.port&&"7443"===p.port)&&(l=l.replace(/^https:/i,"http:").replace(/:7443/i,":7080"));g&&d&&(l=l.replace(/\/rest/i,""))}m=y.mixin({url:l,
content:y.mixin({request:"getToken",username:b&&b.username,password:b&&b.password,serverUrl:f,token:h,expiration:k,referer:m||d?window.location.host:null,client:m?"referer":null,f:"json"},a.customParameters),handleAs:"json",callbackParamName:g?"callback":void 0},c&&c.ioArgs);c={usePost:!g,disableIdentityLookup:!0,useProxy:this._useProxy(a,c)};d||(m.withCredentials=!1);d=E(m,c);d.addCallback(function(n){if(!n||!n.token)return n=Error("Unable to generate token"),n.name="identity-manager:authentication-failed",
n.code="IdentityManagerBase.3",n.log=!!C.isDebug,n;var B=a.server;K[B]||(K[B]={});b&&(K[B][b.username]=b.password);n.validity=k;return n});d.addErrback(function(n){});return d},isBusy:function(){return!!this._busy},checkSignInStatus:function(a){var b=new J;this.checkAppAccess(a,"").then(function(c){b.resolve(c.credential)})["catch"](function(c){b.reject(c)});return b},checkAppAccess:function(a,b,c){var d=this,e=!1;return this.getCredential(a,{prompt:!1}).then(function(g){var l={f:"json"};if("portal"===
g.scope)if(b&&(d._doPortalSignIn(a)||c&&c.force)){var k=g.server+"/sharing/rest/oauth2/validateAppAccess";l.client_id=b}else if(g.token)k=g.server+"/sharing/rest";else return{credential:g};else if(g.token)k=g.server+"/rest/services";else return{credential:g};g.token&&(l.token=g.token);return E({url:k,content:l,callbackParamName:"callback"},{disableIdentityLookup:!0}).then(function(m){if(!1===m.valid){var f=Error("You are currently signed in as: '"+g.userId+"'.  You do not have access to this app: '"+
b+"'.");f.name="identity-manager:not-authorized";f.code="IdentityManagerBase.1";f.log=!!C.isDebug;f.details=m;throw f;}e=!!m.viewOnlyUserTypeApp;return{credential:g}})["catch"](function(m){if("IdentityManagerBase.1"===m.code||400===m.code)throw 400===m.code&&(m.name="identity-manager:invalid-request"),m;if(498===m.code)throw g.destroy(),m=Error("User is not signed in."),m.name="identity-manager:not-authenticated",m.code="IdentityManagerBase.6",m.log=!!C.isDebug,m;return{credential:g}})}).then(function(g){return{credential:g.credential,
viewOnly:e}})},setProtocolErrorHandler:function(a){this._protocolFunc=a},signIn:function(){},oAuthSignIn:function(){},onCredentialCreate:function(){},onCredentialsDestroy:function(){},destroyCredentials:function(){if(this.credentials){var a=this.credentials.slice();r.forEach(a,function(b){b.destroy()})}this.onCredentialsDestroy()},enablePostMessageAuth:function(a){a||(a="https://www.arcgis.com/sharing/rest");this._postMessageAuthHandle&&this._postMessageAuthHandle.remove();this._postMessageAuthHandle=
O(window,"message",function(b){(b.origin===window.location.origin||A.endsWith(b.origin,".arcgis.com"))&&b.data&&"arcgis:auth:requestCredential"===b.data.type&&this.getCredential(a).then(function(c){b.source.postMessage({type:"arcgis:auth:credential",credential:{expires:c.expires,server:c.server,ssl:c.ssl,token:c.token,userId:c.userId}},b.origin)})["catch"](function(c){b.source.postMessage({type:"arcgis:auth:error",error:{name:c.name,message:c.message}},b.origin)})}.bind(this))},disablePostMessageAuth:function(){this._postMessageAuthHandle&&
(this._postMessageAuthHandle.remove(),this._postMessageAuthHandle=null)},_getOAuthLocationParams:function(){var a=window.location.hash;if(a){"#"===a.charAt(0)&&(a=a.substring(1));a=N.queryToObject(a);var b=!1;if(a.access_token&&a.expires_in&&a.state&&a.hasOwnProperty("username"))try{a.state=JSON.parse(a.state),a.state.portalUrl&&(this._oAuthLocationParams=a,b=!0)}catch(d){}else if(a.error&&a.error_description&&"access_denied"===a.error&&(b=!0,a.state))try{a.state=JSON.parse(a.state)}catch(d){}b&&
(window.location.hash=a.state&&a.state.hash||"")}if(a=window.location.search){"?"===a.charAt(0)&&(a=a.substring(1));a=N.queryToObject(a);b=!1;if(a.code&&a.state)try{a.state=JSON.parse(a.state),a.state.portalUrl&&a.state.uid&&(this._oAuthLocationParams=a,b=!0)}catch(d){}else if(a.error&&a.error_description&&"access_denied"===a.error&&(b=!0,a.state))try{a.state=JSON.parse(a.state)}catch(d){}if(b){var c=A.mixin({},a);"code error error_description message_code persist state".split(" ").forEach(function(d){delete c[d]});
b=N.objectToQuery(c);window.history.replaceState(window.history.state,"",window.location.pathname+(b?"?"+b:"")+(a.state&&a.state.hash||""))}}},_getOAuthToken:function(a,b,c,d,e){a=a.replace(/^http:/i,"https:");return E({url:a+"/sharing/rest/oauth2/token",content:d&&e?{grant_type:"authorization_code",code:b,redirect_uri:d,client_id:c,code_verifier:e}:{grant_type:"refresh_token",refresh_token:b,client_id:c}},{disableIdentityLookup:!0,usePost:!0})},_pageShowHandler:function(a){a.persisted&&this.isBusy()&&
this._rejectOnPersistedPageShow&&(a=Error("ABORTED"),a.name="identity-manager:user-aborted",a.code="IdentityManager.2",a.log=!!C.isDebug,this._errbackFunc(a))},_findCredential:function(a,b){var c=-1,d,e,g=b&&b.token;var l=b&&b.resource;var k=this._isServerRsrc(a)?"server":"portal",m=r.filter(this.credentials,function(p){return this._hasSameServerInstance(p.server,a)&&p.scope===k},this);a=l||a;if(m.length)if(1===m.length){l=m[0];var f=(d=(e=this.findServerInfo(l.server))&&e.owningSystemUrl)&&this.findCredential(d,
l.userId);c=this._getIdenticalSvcIdx(a,l);if(g)-1!==c&&(l.resources.splice(c,1),this._removeResource(a,f));else return-1===c&&l.resources.push(a),this._addResource(a,f),l}else{var h,t;r.some(m,function(p){t=this._getIdenticalSvcIdx(a,p);return-1!==t?(h=p,f=(d=(e=this.findServerInfo(h.server))&&e.owningSystemUrl)&&this.findCredential(d,h.userId),c=t,!0):!1},this);if(g)h&&(h.resources.splice(c,1),this._removeResource(a,f));else if(h)return this._addResource(a,f),h}},_findOAuthInfo:function(a){var b=
this.findOAuthInfo(a);b||r.some(this.oAuthInfos,function(c){this._isIdProvider(c.portalUrl,a)&&(b=c);return!!b},this);return b},_addResource:function(a,b){b&&-1===this._getIdenticalSvcIdx(a,b)&&b.resources.push(a)},_removeResource:function(a,b){var c=-1;b&&(c=this._getIdenticalSvcIdx(a,b),-1<c&&b.resources.splice(c,1))},_useProxy:function(a,b){return b&&b.isAdmin&&!z.hasSameOrigin(a.adminTokenServiceUrl,window.location.href)||!this._isPortalDomain(a.tokenServiceUrl)&&10.1==a.currentVersion&&!z.hasSameOrigin(a.tokenServiceUrl,
window.location.href)},_getOrigin:function(a){a=new H(a);return a.scheme+"://"+a.host+(A.isDefined(a.port)?":"+a.port:"")},_getServerInstanceRoot:function(a){var b=a.toLowerCase(),c=b.indexOf(this._agsRest);-1===c&&this._isAdminResource(a)&&(c=this._agsAdmin.test(a)?a.replace(this._agsAdmin,"$1").length:a.search(this._adminSvcs));-1===c&&(c=b.indexOf("/sharing"));-1===c&&"/"===b.substr(-1)&&(c=b.length-1);return-1<c?a.substring(0,c):a},_hasSameServerInstance:function(a,b){"/"===a.substr(-1)&&(a=a.slice(0,
-1));a=a.toLowerCase();b=this._getServerInstanceRoot(b).toLowerCase();a=this._normalizeAGOLorgDomain(a);b=this._normalizeAGOLorgDomain(b);a=a.substr(a.indexOf(":"));b=b.substr(b.indexOf(":"));return a===b},_normalizeAGOLorgDomain:function(a){var b=/^https?:\/\/(?:cdn|[a-z\d-]+\.maps)\.arcgis\.com/i,c=/^https?:\/\/(?:cdndev|[a-z\d-]+\.mapsdevext)\.arcgis\.com/i,d=/^https?:\/\/(?:cdnqa|[a-z\d-]+\.mapsqa)\.arcgis\.com/i;b.test(a)?a=a.replace(b,"https://www.arcgis.com"):c.test(a)?a=a.replace(c,"https://devext.arcgis.com"):
d.test(a)&&(a=a.replace(d,"https://qaext.arcgis.com"));return a},_sanitizeUrl:function(a){var b=(P.defaults.io.proxyUrl||"").toLowerCase(),c=b?a.toLowerCase().indexOf(b+"?"):-1;-1!==c&&(a=a.substring(c+b.length+1));a=z.normalize(a);return z.urlToObject(a).path},_isRESTService:function(a){return-1<a.indexOf(this._agsRest)},_isAdminResource:function(a){return this._agsAdmin.test(a)||this._adminSvcs.test(a)},_isServerRsrc:function(a){return this._isRESTService(a)||this._isAdminResource(a)},_isIdenticalService:function(a,
b){if(this._isRESTService(a)&&this._isRESTService(b)){var c=this._getSuffix(a).toLowerCase(),d=this._getSuffix(b).toLowerCase();var e=c===d;e||(e=/(.*)\/(MapServer|FeatureServer).*/ig,e=c.replace(e,"$1")===d.replace(e,"$1"))}else this._isAdminResource(a)&&this._isAdminResource(b)?e=!0:this._isServerRsrc(a)||this._isServerRsrc(b)||!this._isPortalDomain(a)||(e=!0);return e},_isPortalDomain:function(a){var b=new H(a.toLowerCase()),c=this._portalConfig;a=r.some(this._gwDomains,function(d){return d.regex.test(b.uri)});
!a&&c&&(a=this._hasSameServerInstance(this._getServerInstanceRoot(c.restBaseUrl),b.uri));a||(!this._arcgisUrl&&(c=y.getObject("esri.arcgis.utils.arcgisUrl"))&&(this._arcgisUrl=(new H(c)).authority),this._arcgisUrl&&(a=this._arcgisUrl.toLowerCase()===b.authority));a||(a=r.some(this._portals,function(d){return this._hasSameServerInstance(d,b.uri)},this));return a=a||this._agsPortal.test(b.path)},_isIdProvider:function(a,b){var c=-1,d=-1;r.forEach(this._gwDomains,function(k,m){-1===c&&k.regex.test(a)&&
(c=m);-1===d&&k.regex.test(b)&&(d=m)});var e=!1;if(-1<c&&-1<d)if(0===c||4===c){if(0===d||4===d)e=!0}else if(1===c){if(1===d||2===d)e=!0}else 2===c?2===d&&(e=!0):3===c&&3===d&&(e=!0);if(!e){var g=this.findServerInfo(b),l=g&&g.owningSystemUrl;l&&Y(g)&&this._isPortalDomain(l)&&this._isIdProvider(a,l)&&(e=!0)}return e},_isPublic:function(a){a=this._sanitizeUrl(a);return r.some(this._publicUrls,function(b){return b.test(a)})},_getIdenticalSvcIdx:function(a,b){var c=-1;r.some(b.resources,function(d,e){return this._isIdenticalService(a,
d)?(c=e,!0):!1},this);return c},_getSuffix:function(a){return a.replace(this._regexSDirUrl,"").replace(this._regexServerType,"$1")},_getTokenSvcUrl:function(a){if(this._isRESTService(a)||this._isAdminResource(a)){var b=this._getServerInstanceRoot(a);var c=b+"/admin/generateToken";a=b+"/rest/info";b=E({url:a,content:{f:"json"},handleAs:"json",callbackParamName:"callback"});b.adminUrl_=c;return b}if(this._isPortalDomain(a)){var d="";r.some(this._gwDomains,function(e){e.regex.test(a)&&(d=e.tokenServiceUrl);
return!!d});d||r.some(this._portals,function(e){this._hasSameServerInstance(e,a)&&(d=e+this._gwTokenUrl);return!!d},this);d||(c=a.toLowerCase().indexOf("/sharing"),-1!==c&&(d=a.substring(0,c)+this._gwTokenUrl));d||(d=this._getOrigin(a)+this._gwTokenUrl);d&&(c=(new H(a)).port,/^http:\/\//i.test(a)&&"7080"===c&&(d=d.replace(/:7080/i,":7443")),d=d.replace(/http:/i,"https:"));return d}if(-1!==a.toLowerCase().indexOf("premium.arcgisonline.com"))return"https://premium.arcgisonline.com/server/tokens"},_exchangeToken:function(a,
b,c){return E({url:a+"/sharing/rest/oauth2/exchangeToken",content:{f:"json",client_id:b,token:c}},{disableIdentityLookup:!0,usePost:!0}).then(function(d){return d.token})},_getPlatformSelf:function(a,b){a=a.replace(/^http:/i,"https:");return E({url:a+"/sharing/rest/oauth2/platformSelf",content:{f:"json",expiration:30},headers:{"X-Esri-Auth-Client-Id":b,"X-Esri-Auth-Redirect-Uri":window.location.href.replace(/#.*$/,"")},withCredentials:!0},{disableIdentityLookup:!0,usePost:!0})},_getPortalSelf:function(a,
b){var c="";r.some(this._gwDomains,function(e){e.regex.test(a)&&(c=e.customBaseUrl);return!!c});if(c){var d=new J;d.resolve({allSSL:!0,currentVersion:"8.4",customBaseUrl:c,portalMode:"multitenant",supportsOAuth:!0});return d}"https:"===window.location.protocol?a=a.replace(/^http:/i,"https:").replace(/:7080/i,":7443"):/^http:/i.test(b)&&(a=a.replace(/^https:/i,"http:").replace(/:7443/i,":7080"));return E({url:a,content:{f:"json"},callbackParamName:"callback",withCredentials:!0},{disableIdentityLookup:!0})},
_doPortalSignIn:function(a){var b=this._portalConfig,c=window.location.href,d=this.findServerInfo(a);return(b||this._isPortalDomain(c))&&(d?d.hasPortal||d.owningSystemUrl&&this._isPortalDomain(d.owningSystemUrl):this._isPortalDomain(a))&&(this._isIdProvider(c,a)||b&&(this._hasSameServerInstance(this._getServerInstanceRoot(b.restBaseUrl),a)||this._isIdProvider(b.restBaseUrl,a))||z.hasSameOrigin(c,a,!0))?!0:!1},_checkProtocol:function(a,b,c,d){var e=!0;d=d?b.adminTokenServiceUrl:b.tokenServiceUrl;0!==
y.trim(d).toLowerCase().indexOf("https:")||0===window.location.href.toLowerCase().indexOf("https:")||P.defaults.io.useCors&&(z.canUseXhr(d)||z.canUseXhr(z.getProxyUrl(!0).path))||(e=this._protocolFunc?!!this._protocolFunc({resourceUrl:a,serverInfo:b}):!1,e||(a=Error("Aborted the Sign-In process to avoid sending password over insecure connection."),a.name="identity-manager:aborted",a.code="IdentityManagerBase.4",a.log=!!C.isDebug,c(a)));return e},_enqueue:function(a,b,c,d,e,g){d||(d=new J(U._dfdCanceller));
d.resUrl_=a;d.sinfo_=b;d.options_=c;d.admin_=e;d.refresh_=g;this._busy?this._hasSameServerInstance(this._getServerInstanceRoot(a),this._busy.resUrl_)?(this._oAuthDfd&&this._oAuthDfd.oAuthWin_&&this._oAuthDfd.oAuthWin_.focus(),this._soReqs.push(d)):this._xoReqs.push(d):this._doSignIn(d);return d},_doSignIn:function(a){this._busy=a;this._rejectOnPersistedPageShow=!1;var b=this,c=function(f){var h=a.options_&&a.options_.resource,t=a.resUrl_,p=a.refresh_,n=!1;-1===r.indexOf(b.credentials,f)&&(p&&-1!==
r.indexOf(b.credentials,p)?(p.userId=f.userId,p.token=f.token,p.expires=f.expires,p.validity=f.validity,p.ssl=f.ssl,p.creationTime=f.creationTime,n=!0,f=p):b.credentials.push(f));f.resources||(f.resources=[]);-1===f.resources.indexOf(h||t)&&f.resources.push(h||t);f.scope=b._isServerRsrc(t)?"server":"portal";f.onTokenChange();h=b._soReqs;var B={};b._soReqs=[];r.forEach(h,function(u){if(!this._isIdenticalService(t,u.resUrl_)){var x=this._getSuffix(u.resUrl_);B[x]||(B[x]=!0,f.resources.push(u.resUrl_))}},
b);a.callback(f);r.forEach(h,function(u){this._hasSameServerInstance(this._getServerInstanceRoot(t),u.resUrl_)?u.callback(f):this._soReqs.push(u)},b);b._busy=a.resUrl_=a.sinfo_=a.refresh_=null;if(!n)b.onCredentialCreate({credential:f});b._soReqs.length?b._doSignIn(b._soReqs.shift()):b._xoReqs.length&&b._doSignIn(b._xoReqs.shift())},d=function(f){a.errback(f);b._busy=a.resUrl_=a.sinfo_=a.refresh_=null;b._soReqs.length?b._doSignIn(b._soReqs.shift()):b._xoReqs.length&&b._doSignIn(b._xoReqs.shift())},
e=function(f,h,t,p){var n=a.sinfo_,B=!a.options_||!1!==a.options_.prompt,u=n.hasPortal&&b._findOAuthInfo(a.resUrl_);if(f)c(new F({userId:f,server:n.server,token:t||null,expires:A.isDefined(p)?Number(p):null,ssl:!!h}));else if(window!==window.parent&&b._appUrlObj.query&&b._appUrlObj.query["arcgis-auth-origin"]&&b._appUrlObj.query["arcgis-auth-portal"]&&b._hasSameServerInstance(b._getServerInstanceRoot(b._appUrlObj.query["arcgis-auth-portal"]),a.resUrl_)){window.parent.postMessage({type:"arcgis:auth:requestCredential"},
b._appUrlObj.query["arcgis-auth-origin"]);var x=O(window,"message",function(q){if(q.source===window.parent&&q.data)if("arcgis:auth:credential"===q.data.type&&q.data.credential.expires<Date.now()&&(q.data.type="arcgis:auth:error",q.data.error={name:"tokenExpiredError"}),"arcgis:auth:credential"===q.data.type)x.remove(),c(new F(q.data.credential));else if("arcgis:auth:error"===q.data.type){x.remove();q=q.data.error;switch(q.name){case "identity-manager:busy":case "identity-manager:not-authorized":var D=
"IdentityManager.1";break;case "identity-manager:server-identification-failed":case "identity-manager:unknown-resource":case "identity-manager:user-aborted":D="IdentityManager.2";break;case "identity-manager:authentication-failed":case "identity-manager:credential-request-failed":case "tokenExpiredError":D="IdentityManager.3";"tokenExpiredError"===q.name&&(q.name="identity-manager:credential-request-failed",q.message="Parent application's token has expired.");break;case "identity-manager:aborted":D=
"IdentityManager.4";break;case "identity-manager:not-authenticated":D="IdentityManager.6";break;case "identity-manager:invalid-request":D=400}var L=Error(q.message);L.name=q.name;L.code=D;L.log=!!C.isDebug;d(L)}})}else if(u){var w=u._oAuthCred;w||(f=new W(u,Z),h=new W(u,aa),f.isValid()&&h.isValid()?f.expires>h.expires?(w=f,h.destroy()):(w=h,f.destroy()):w=f.isValid()?f:h,u._oAuthCred=w);if(w.isValid()){var I=new F({userId:w.userId,server:n.server,token:w.token,expires:w.expires,ssl:w.ssl,_oAuthCred:w});
var ba=u.appId!==w.appId&&b._doPortalSignIn(a.resUrl_);ba||w.refreshToken?(w.refreshToken?a._pendingDfd=b._getOAuthToken(n.server,w.refreshToken,w.appId).then(function(q){I.expires=Date.now()+1E3*q.expires_in;I.token=q.access_token;return I}):(f=new J,f.resolve(I),a._pendingDfd=f),a._pendingDfd.then(function(q){return ba?b._exchangeToken(q.server,u.appId,q.token).then(function(D){q.token=D;return q})["catch"](function(){return q}):q}).then(function(q){c(q)})["catch"](function(){w.destroy();e()})):
c(I)}else if(b._oAuthLocationParams&&b._hasSameServerInstance(u.portalUrl,b._oAuthLocationParams.state.portalUrl)&&(b._oAuthLocationParams.access_token||b._oAuthLocationParams.code&&b._oAuthLocationParams.state.uid===w.stateUID&&w.codeVerifier))f=b._oAuthLocationParams,b._oAuthLocationParams=null,a._pendingDfd=b._processOAuthResponseParams(f,u,n).then(function(q){c(q)})["catch"](d);else{var S=function(){B?a._pendingDfd=b.oAuthSignIn(a.resUrl_,n,u,a.options_).addCallbacks(c,d):(G=Error("User is not signed in."),
G.name="identity-manager:not-authenticated",G.code="IdentityManagerBase.6",G.log=!!C.isDebug,d(G))};b._doPortalSignIn(a.resUrl_)?a._pendingDfd=b._getPlatformSelf(n.server,u.appId).then(function(q){var D=q.portalUrl;!D||z.hasSameOrigin(D,window.location.origin,!0)?(I=new F({userId:q.username,server:n.server,expires:Date.now()+1E3*q.expires_in,token:q.token}),c(I)):S()})["catch"](S):S()}}else if(B)b._checkProtocol(a.resUrl_,n,d,a.admin_)&&(f=a.options_,a.admin_&&(f=f||{},f.isAdmin=!0),a._pendingDfd=
b.signIn(a.resUrl_,n,f).addCallbacks(c,d));else{var G=Error("User is not signed in.");G.name="identity-manager:not-authenticated";G.code="IdentityManagerBase.6";G.log=!!C.isDebug;d(G)}},g=function(){var f=a.sinfo_,h=f.owningSystemUrl,t=a.options_,p;if(t){var n=t.token;var B=t.error;var u=t.prompt}(p=b._findCredential(h,{token:n,resource:a.resUrl_}))||r.some(b.credentials,function(x){this._isIdProvider(h,x.server)&&(p=x);return!!p},b);p?(t=b.findCredential(a.resUrl_,p.userId))?c(t):R(f,b._legacyFed)?
(t=p.toJson(),t.server=f.server,t.resources=null,c(new F(t))):(a._pendingDfd=b.generateToken(b.findServerInfo(p.server),null,{serverUrl:a.resUrl_,token:p.token,ssl:p.ssl})).addCallbacks(function(x){c(new F({userId:p.userId,server:f.server,token:x.token,expires:A.isDefined(x.expires)?Number(x.expires):null,ssl:!!x.ssl,isAdmin:a.admin_,validity:x.validity}))},d):(b._busy=null,n&&(a.options_.token=null),(a._pendingDfd=b.getCredential(h.replace(/\/?$/,"/sharing"),{resource:a.resUrl_,owningTenant:f.owningTenant,
token:n,error:B,prompt:u})).addCallbacks(function(x){b._enqueue(a.resUrl_,a.sinfo_,a.options_,a,a.admin_)},function(x){d(x)}))};this._errbackFunc=d;var l=a.sinfo_.owningSystemUrl,k=this._isServerRsrc(a.resUrl_),m=a.sinfo_._restInfoDfd;m?m.addCallbacks(function(f){var h=a.sinfo_;h._restInfoDfd&&(h.adminTokenServiceUrl=h._restInfoDfd.adminUrl_,h._restInfoDfd=null,h.tokenServiceUrl=y.getObject("authInfo.tokenServicesUrl",!1,f)||y.getObject("authInfo.tokenServiceUrl",!1,f)||y.getObject("tokenServiceUrl",
!1,f),h.shortLivedTokenValidity=y.getObject("authInfo.shortLivedTokenValidity",!1,f),h.currentVersion=f.currentVersion,h.owningTenant=f.owningTenant,(f=h.owningSystemUrl=f.owningSystemUrl)&&b._portals.push(f));k&&h.owningSystemUrl?g():e()},function(){a.sinfo_._restInfoDfd=null;var f=Error("Unknown resource - could not find token service endpoint.");f.name="identity-manager:server-identification-failed";f.code="IdentityManagerBase.2";f.log=!!C.isDebug;d(f)}):k&&l?g():a.sinfo_._selfReq?a.sinfo_._selfReq.selfDfd.then(function(f){var h=
{};if(f){var t=f.user&&f.user.username;h.username=t;h.allSSL=f.allSSL;var p=f.supportsOAuth;var n=parseFloat(f.currentVersion);if("multitenant"===f.portalMode)var B=f.customBaseUrl;a.sinfo_.currentVersion=n}a.sinfo_.webTierAuth=!!t;return t&&b.normalizeWebTierAuth?b.generateToken(a.sinfo_,null,{ssl:h.allSSL}).addBoth(function(u){h.portalToken=u&&u.token;h.tokenExpiration=u&&u.expires;return h}):!t&&p&&4.4<=n&&!b._findOAuthInfo(a.resUrl_)?b._generateOAuthInfo({portalUrl:a.sinfo_.server,customBaseUrl:B,
owningTenant:a.sinfo_._selfReq.owningTenant}).always(function(){return h}):h}).always(function(f){a.sinfo_._selfReq=null;f?e(f.username,f.allSSL,f.portalToken,f.tokenExpiration):e()}):e()},_generateOAuthInfo:function(a){var b=this,c=a.portalUrl,d=a.customBaseUrl,e=a.owningTenant;if(a=!this.defaultOAuthInfo&&this._createDefaultOAuthInfo&&!this._hasTestedIfAppIsOnPortal){var g=window.location.href;var l=g.indexOf("?");-1<l&&(g=g.slice(0,l));l=g.search(/\/(apps|home)\//);g=-1<l?g.slice(0,l):null}a&&
g?(this._hasTestedIfAppIsOnPortal=!0,a=E({url:g+"/sharing/rest",content:{f:"json"},handleAs:"json"}).then(function(){b.defaultOAuthInfo=new X({appId:"arcgisonline",popupCallbackUrl:g+"/home/oauth-callback.html"})})):(a=new J,a.resolve(),a=a.promise);return a.then(function(){if(b.defaultOAuthInfo)return c=c.replace(/^http:/i,"https:"),E({url:c+"/sharing/rest/oauth2/validateRedirectUri",content:{accountId:e,client_id:b.defaultOAuthInfo.appId,redirect_uri:z.getAbsoluteUrl(b.defaultOAuthInfo.popupCallbackUrl),
f:"json"},handleAs:"json",callbackParamName:"callback"}).then(function(k){if(k.valid){var m=b.defaultOAuthInfo.clone();m.portalUrl=k.urlKey&&d?"https://"+k.urlKey.toLowerCase()+"."+d:c;m.popup=window!==window.top||!(z.hasSameOrigin(c,window.location.origin)||b._gwDomains.some(function(f){return f.regex.test(c)&&f.regex.test(window.location.origin)}));b.oAuthInfos.push(m)}})})}});var F=T(V,{declaredClass:"esri.Credential",tokenRefreshBuffer:2,constructor:function(a){y.mixin(this,a);this.resources=
this.resources||[];A.isDefined(this.creationTime)||(this.creationTime=(new Date).getTime())},_oAuthCred:null,refreshToken:function(){var a=this,b=this.resources&&this.resources[0],c=v.id.findServerInfo(this.server),d=c&&c.owningSystemUrl,e=!!d&&"server"===this.scope,g=e&&R(c,v.id._legacyFed),l=e&&v.id.findServerInfo(d),k,m=(k=c.webTierAuth)&&v.id.normalizeWebTierAuth,f=K[this.server];f=f&&f[this.userId];var h={username:this.userId,password:f};if(!k||m)if(e&&!l&&r.some(v.id.serverInfos,function(n){v.id._isIdProvider(d,
n.server)&&(l=n);return!!l}),k=l&&v.id.findCredential(l.server,this.userId),!e||k)if(g)k.refreshToken();else{if(e)var t={serverUrl:b,token:k&&k.token,ssl:k&&k.ssl};else if(m)h=null,t={ssl:this.ssl};else if(f)this.isAdmin&&(t={isAdmin:!0});else{if(b){b=v.id._sanitizeUrl(b);this._enqueued=1;var p=v.id._enqueue(b,c,null,null,this.isAdmin,this);p.addCallback(function(){a._enqueued=0;a.refreshServerTokens()}).addErrback(function(){a._enqueued=0})}return p}return v.id.generateToken(e?l:c,e?null:h,t).addCallback(function(n){a.token=
n.token;a.expires=A.isDefined(n.expires)?Number(n.expires):null;a.creationTime=(new Date).getTime();a.validity=n.validity;a.onTokenChange();a.refreshServerTokens()}).addErrback(function(){})}},refreshServerTokens:function(){"portal"===this.scope&&r.forEach(v.id.credentials,function(a){var b=v.id.findServerInfo(a.server),c=b&&b.owningSystemUrl;a!==this&&a.userId===this.userId&&c&&"server"===a.scope&&(v.id._hasSameServerInstance(this.server,c)||v.id._isIdProvider(c,this.server))&&(R(b,v.id._legacyFed)?
(a.token=this.token,a.expires=this.expires,a.creationTime=this.creationTime,a.validity=this.validity,a.onTokenChange()):a.refreshToken())},this)},onTokenChange:function(a){clearTimeout(this._refreshTimer);var b=this.server&&v.id.findServerInfo(this.server),c=(b=b&&b.owningSystemUrl)&&v.id.findServerInfo(b);!1!==a&&(!b||"portal"===this.scope||c&&c.webTierAuth&&!v.id.normalizeWebTierAuth)&&(A.isDefined(this.expires)||A.isDefined(this.validity))&&this._startRefreshTimer()},onDestroy:function(){},destroy:function(){this.userId=
this.server=this.token=this.expires=this.validity=this.resources=this.creationTime=null;this._oAuthCred&&(this._oAuthCred.destroy(),this._oAuthCred=null);var a=r.indexOf(v.id.credentials,this);-1<a&&v.id.credentials.splice(a,1);this.onTokenChange();this.onDestroy()},toJson:function(){return this._toJson()},_toJson:function(){var a=A.fixJson({userId:this.userId,server:this.server,token:this.token,expires:this.expires,validity:this.validity,ssl:this.ssl,isAdmin:this.isAdmin,creationTime:this.creationTime,
scope:this.scope}),b=this.resources;b&&0<b.length&&(a.resources=b.slice());return a},_startRefreshTimer:function(){clearTimeout(this._refreshTimer);var a=6E4*this.tokenRefreshBuffer,b=Math.pow(2,31)-1,c=(this.validity?this.creationTime+6E4*this.validity:this.expires)-(new Date).getTime();0>c?c=0:c>b&&(c=b);this._refreshTimer=setTimeout(y.hitch(this,this.refreshToken),c>a?c-a:c)}});M.Credential=F;return v.IdentityManagerBase=M});