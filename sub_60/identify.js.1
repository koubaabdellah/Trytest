// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.24/esri/copyright.txt for details.//>>built
define("exports ../../core/maybe ../../core/sql ../../geometry/support/jsonUtils ../../geometry/support/scaleUtils ../../layers/support/floorFilterUtils ../../layers/support/sublayerUtils".split(" "),function(q,z,D,E,F,A,G){function B(a){var b,d;const {mapExtent:e,floors:g,width:r,sublayers:h,layerIds:f,layerOption:k,gdbVersion:t}=a;a=null==h?void 0:null==(b=h.find(c=>null!=c.layer))?void 0:null==(d=b.layer)?void 0:d.serviceSublayers;const u="popup"===k;b={};const n=F.getScale({extent:e,width:r,spatialReference:null==
e?void 0:e.spatialReference}),l=[],p=c=>{const m=0===n,v=0===c.minScale||n<=c.minScale,w=0===c.maxScale||n>=c.maxScale;c.visible&&(m||v&&w)&&(c.sublayers?c.sublayers.forEach(p):!1!==(null==f?void 0:f.includes(c.id))&&(!u||c.popupTemplate&&c.popupEnabled)&&l.unshift(c))};null==h?void 0:h.forEach(p);if(h&&!l.length)b.layerIds=[];else if(d=G.isExportDynamic(l,a,t),a=l.map(c=>{const m=A.getLayerFloorFilterClause(g,c);return c.toExportImageJSON(m)}),d)b.dynamicLayers=JSON.stringify(a);else if(h?(d=l.map(({id:c})=>
c),f&&(d=d.filter(c=>f.includes(c))),b.layerIds=d):null!=f&&f.length&&(b.layerIds=f),d=H(g,l),z.isSome(d)&&d.length){a={};for(const c of d)c.definitionExpression&&(a[c.id]=c.definitionExpression);Object.keys(a).length&&(b.layerDefs=JSON.stringify(a))}return b}function H(a,b){const d=!(null==a||!a.length);b=b.filter(e=>null!=e.definitionExpression||d&&null!=e.floorInfo);return b.length?b.map(e=>{var g=A.getLayerFloorFilterClause(a,e);g=D.sqlAnd(g,e.definitionExpression);return{id:e.id,definitionExpression:g}}):
null}q.identifyToIdentifyRESTParameters=function(a,b){const {dpi:d,gdbVersion:e,geometry:g,geometryPrecision:r,height:h,layerOption:f,mapExtent:k,maxAllowableOffset:t,returnFieldName:u,returnGeometry:n,returnUnformattedValues:l,returnZ:p,spatialReference:c,timeExtent:m,tolerance:v,width:w}=a.toJSON(),{dynamicLayers:x,layerDefs:y,layerIds:C}=B(a);b=b&&z.isSome(b.geometry)?b.geometry:null;a={geometryPrecision:r,maxAllowableOffset:t,returnFieldName:u,returnGeometry:n,returnUnformattedValues:l,returnZ:p,
tolerance:v};b=b&&b.toJSON()||g;a.imageDisplay=`${w},${h},${d}`;e&&(a.gdbVersion=e);b&&(delete b.spatialReference,a.geometry=JSON.stringify(b),a.geometryType=E.getJsonType(b));c?a.sr=c.wkid||JSON.stringify(c):b&&b.spatialReference?a.sr=b.spatialReference.wkid||JSON.stringify(b.spatialReference):k&&k.spatialReference&&(a.sr=k.spatialReference.wkid||JSON.stringify(k.spatialReference));a.time=m?[m.start,m.end].join():null;if(k){const {xmin:I,ymin:J,xmax:K,ymax:L}=k;a.mapExtent=`${I},${J},${K},${L}`}y&&
(a.layerDefs=y);x&&!y&&(a.dynamicLayers=x);a.layers="popup"===f?"visible":f;C&&!x&&(a.layers+=`:${C.join(",")}`);return a};q.toDynamicLayersJSON=B;Object.defineProperties(q,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});