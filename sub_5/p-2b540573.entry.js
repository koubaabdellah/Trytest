import{r as t,h as e,H as i,g as o}from"./p-737d2cb2.js";import{g as r}from"./p-e6dfa793.js";import{c as s}from"./p-c443f4d3.js";import{c as n}from"./p-199e5a41.js";import{g as a}from"./p-d24b3b6f.js";import{t as l,d as c}from"./p-b2c66e42.js";import{g as d,a as u}from"./p-74217616.js";import{r as p}from"./p-4a6461bd.js";import{i as h}from"./p-daf9b7a7.js";import"./p-a0307a64.js";import"./p-9c7f1625.js";import"./p-34b9b8bc.js";const m=s({}).state;function v(t,e,i){var o,r;return{description:t.description,fieldAliases:null===(o=t.fields)||void 0===o?void 0:o.map((t=>t.alias)),fields:t.fields,geometryType:i?"table":t.geometryType,id:t.id,title:t.name,matched:null===(r=null==e?void 0:e.find((e=>e.id===t.id)))||void 0===r?void 0:r.matched}}function b(t,e){const{config:i}=n,o=h(t);return p(t,{},{useProxy:!1,timeout:!1===i.isMultiTenant?6e4:5e3,addSSL:o,addToken:e&&!1!==i.isMultiTenant||!1,usePost:!0,disableIdentityLookup:!0},"post")}function f(t,e,i,o){var r,s,n;const a=(null===(r=null==i?void 0:i.tables)||void 0===r?void 0:r.length)>0,l=(null===(s=null==i?void 0:i.layers)||void 0===s?void 0:s.length)>0||a,c=[...((null==i?void 0:i.layers)||[]).map((t=>t.id)),...null===(n=(null==i?void 0:i.tables)||[])||void 0===n?void 0:n.map((t=>t.id))];return(t||[]).filter((({id:t,type:e})=>!l||"Table"===e&&!a||c.includes(t))).map((t=>v(t,e,o)))}async function y({item:t,portal:e,layers:i,isSecure:o,data:r,retry:s}){var a;const l={error:{code:"unhandledError"}};try{if(!r&&!s)try{const i=u(e),o=i?`&token=${i}`:"",s=`${d(e)}content/items/${t.id}/data?f=json${o}`,n=await fetch(s),c=await n.text();if(c&&(r=JSON.parse(c)),(null==r?void 0:r.error)&&403===r.error.code&&"SB_0006"===(null===(a=r.error)||void 0===a?void 0:a.messageCode))return l.error.code="serviceNotExist",l}catch(t){r=null}if("Feature Collection"===t.type&&(null==r?void 0:r.layers))return{result:r.layers.map((({layerDefinition:t},e)=>{var i;return{description:"",fields:t.fields,fieldAliases:null===(i=t.fields)||void 0===i?void 0:i.map((t=>t.alias)),geometryType:t.geometryType,id:e,matched:!1,title:t.name}}))};try{const{url:e}=t;return async function({serviceInfo:t,item:e,layers:i,isSecure:o,data:r}){var s,n;const{url:a}=e;if(!(null===(s=t.layers)||void 0===s?void 0:s.length)&&!(null===(n=t.tables)||void 0===n?void 0:n.length)&&(null==t?void 0:t.fields))return{result:[v(t,i)]};try{const{layers:t,tables:e}=await b(`${a}/layers`,o);return{result:[...f(t,i,r),...f(e,i,r,!0)].sort(((t,e)=>t.id-e.id))}}catch(t){return{error:{code:"unhandledError"}}}}({serviceInfo:await b(e,o),item:t,layers:i,isSecure:o,data:r})}catch(s){return!o&&(499===(null==s?void 0:s.code)&&"Token Required"===(null==s?void 0:s.message)||403===s.code)&&n.user?y({item:t,portal:e,layers:i,data:r,isSecure:!0}):("Invalid URL"===(null==s?void 0:s.message)&&(l.error.code="serviceNotExist"),l)}}catch(t){return l}}const g=class{constructor(e){t(this,e),this.api=4,this.i18nNoService="Selected service does not exist or is inaccessible.",this.i18nNoLayers="The service contains no layers.",this.loading=!0,this.handleClick=async()=>{var t;const{layers:e,item:i}=this;null===(t=this.button)||void 0===t||t.focus(),e||(this.loading=!0),m[i.id]||(m[i.id]=this.fetchServiceInfo());const o=await m[i.id];var r;o.error&&(this.error=this.i18n.error,"serviceNotExist"===o.error.code&&(this.error.message=this.i18nNoService)),this.sublayers=o.result?(r=e,o.result.map((t=>{var e;return Object.assign(Object.assign({},t),{matched:null===(e=null==r?void 0:r.find((e=>e.id===t.id)))||void 0===e?void 0:e.matched})}))):e,this.loading=!1},this.handleWindowClick=({target:t})=>{this.el.contains(t)||(this.popover.open=!1)},this.handleKeyDown=({key:t})=>{var e;switch(t){case"Esc":case"Escape":this.popover&&(this.popover.open=!1);break;case" ":case"Enter":null===(e=this.popover)||void 0===e||e.toggle()}}}async componentWillLoad(){const t=await r(this.el);this.i18n=t[0],n.api=this.api,n.portal=this.portal,n.config=this.config,n.user=this.user,this.layers||(this.loading=!0)}async fetchServiceInfo(){const{item:t,portal:e,layers:i}=this,o=await y({item:t,portal:e,layers:i,isSecure:!1});return await l(1e3),o}render(){const{i18n:t,portal:o,user:r,item:s,handleClick:n,handleKeyDown:l,loading:d,searchTerm:u,error:p,tooltip:h,telemetry:m}=this,v=this.sublayers||this.layers;return e(i,{onFocusout:t=>{t.relatedTarget&&!this.el.contains(t.relatedTarget)&&(this.popover.open=!1)}},e("calcite-popover-manager",{autoClose:!0},e("button",Object.assign({class:{button:!0,"button--border":this.border},ref:t=>this.button=t,onClick:n,onTouchStart:n,onKeyDown:l},h?{title:h}:{}),e("span",{class:"button-text"},e("slot",null),e("calcite-icon",{icon:"caret-down",scale:"s",class:"button--icon"}))),e("calcite-popover",{ref:t=>this.popover=t,label:t.layersAndTables,disablePointer:!0,referenceElement:this.button,"close-button":!0,class:"popover",placement:"bottom",heading:t.layersAndTables,onCalcitePopoverOpen:()=>{var t;null===(t=this.telemetry)||void 0===t||t.logEvent({category:"preview popup",action:"click",pageName:a(),pageUrl:window.location.href}),window.addEventListener("click",this.handleWindowClick)},onCalcitePopoverClose:c((()=>{var t;null===(t=this.telemetry)||void 0===t||t.logEvent({category:"preview popup",action:"close",pageName:a(),pageUrl:window.location.href}),window.removeEventListener("click",this.handleWindowClick)}),200)},e("div",{class:"popover-content"},d?e("div",{class:"skeleton"},e("div",{class:"skeleton-content"},e("div",{class:"skeleton-left"}),e("div",{class:"skeleton-main"},e("div",{class:"skeleton-title"}),e("div",{class:"skeleton-subtitle"})),e("div",{class:"skeleton-right"}))):e("arcgis-layers-and-tables-summary",{i18nNoLayers:this.i18nNoLayers,portal:o,user:r,item:s,layers:v,showMatched:u&&!!this.layers,error:p,loading:!this.sublayers,telemetry:m,onLayersAndTablesFocusEnd:()=>{this.popover.open=!1}})))))}get el(){return o(this)}};g.style=":host{max-width:100%}arcgis-layers-and-tables-summary:not(.hydrated){visibility:hidden}.popover-content{width:380px;min-height:6rem;background-color:var(--calcite-ui-background)}.skeleton{padding:0.5rem;margin:1rem;margin-bottom:3rem;-webkit-animation:pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;animation:pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;border:1px solid var(--calcite-ui-border-2)}.skeleton-content{display:flex}.skeleton-left,.skeleton-right{width:1rem;height:1rem;background-color:var(--calcite-ui-border-3)}.skeleton-main{flex:1 1 0%;margin-left:1rem;margin-right:1rem}.skeleton-title{height:1rem;background-color:var(--calcite-ui-border-2)}.skeleton-subtitle{height:1rem;margin-top:0.25rem;background-color:var(--calcite-ui-border-3)}@-webkit-keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}.button{transition-property:all;padding:0;outline:2px solid transparent;outline-offset:2px;border-style:none;cursor:pointer;max-width:100%;color:inherit;background:transparent;font-family:inherit;font-size:inherit}.button:focus{outline:2px solid var(--calcite-ui-brand);outline-offset:4px}.button--border{padding-left:0.5rem;padding-right:0.5rem;padding-top:0.25rem;padding-bottom:0.25rem;border:1px solid var(--calcite-ui-foreground-3)}.button--border:focus{outline-offset:0}.button-text{pointer-events:none;display:flex}.button--icon{vertical-align:-3px;-webkit-margin-start:0.25rem;margin-inline-start:0.25rem}";export{g as arcgis_layers_and_tables_summary_popup}