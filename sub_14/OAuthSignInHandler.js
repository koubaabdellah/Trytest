//>>built
define("esri/OAuthSignInHandler","./Credential ./domUtils ./lang ./urlUtils dijit/Dialog dijit/registry dojo/_base/config dojo/_base/Deferred dojo/_base/kernel dojo/dom-attr dojo/i18n!./nls/jsapi dojo/io-query ./core/events dijit/form/Button dojo/query".split(" "),function(y,t,z,m,A,B,n,u,p,C,D,q,E){var v=null,w=null;try{v=window.localStorage,w=window.sessionStorage}catch(a){}var x=window.crypto||window.msCrypto;return{_oAuthDfd:null,_oAuthIntervalId:0,_oAuthDialogContent:"\x3cdiv class\x3d'dijitDialogPaneContentArea'\x3e\x3cdiv style\x3d'padding-bottom: 5px; word-wrap: break-word;'\x3e${oAuthInfo}\x3c/div\x3e\x3cdiv style\x3d'margin: 0px; padding: 0px; height: 10px;'\x3e\x3c/div\x3e\x3cdiv class\x3d'esriErrorMsg' style\x3d'display: none; color: white; background-color: #D46464; text-align: center; padding-top: 3px; padding-bottom: 3px;'\x3e${invalidUser}\x3c/div\x3e\x3cdiv style\x3d'margin: 0px; padding: 0px; height: 10px;'\x3e\x3c/div\x3e\x3cdiv class\x3d'dijitDialogPaneActionBar'\x3e\x3cbutton data-dojo-type\x3d'dijit.form.Button' data-dojo-props\x3d'type:\"button\", \"class\":\"esriIdSubmit\"'\x3e${lblOk}\x3c/button\x3e\x3cbutton data-dojo-type\x3d'dijit.form.Button' data-dojo-props\x3d'type:\"button\", \"class\":\"esriIdCancel\"'\x3e${lblCancel}\x3c/button\x3e\x3c/div\x3e",
setOAuthRedirectionHandler:function(a){this._oAuthRedirectFunc=a},oAuthSignIn:function(a,d,b,c){var e=this._oAuthDfd=new u;e.resUrl_=a;e.sinfo_=d;e.oinfo_=b;var g=b._oAuthCred;if(g.storage&&("authorization-code"===b.flowType||"auto"===b.flowType&&!b.popup&&8.4<=d.currentVersion)){var f=x.getRandomValues(new Uint8Array(32));var k=m.base64UrlEncode(f);g.codeVerifier=k;f=x.getRandomValues(new Uint8Array(32));g.stateUID=m.base64UrlEncode(f);g.save()||(g.codeVerifier=k=null)}else g.codeVerifier=null;var h=
this;this._getCodeChallenge(k).then(function(l){var r=!c||!1!==c.oAuthPopupConfirmation;if(!b.popup||!r)return h._doOAuthSignIn(a,d,b,l),e;e.codeChallenge_=l;h._nls||(h._nls=D.identity);h.oAuthDialog||(h.oAuthDialog=h._createOAuthDialog());l=h.oAuthDialog;r=c&&c.error;var F=c&&c.token;t.hide(l.errMsg_);r&&403==r.code&&F&&(C.set(l.errMsg_,"innerHTML",h._nls.forbidden),t.show(l.errMsg_));C.set(l.serverLink_,{title:d.server,innerHTML:-1!==d.server.toLowerCase().indexOf("arcgis.com")?"ArcGIS Online":
d.server});l.show()});return e},setOAuthResponseHash:function(a){a&&("#"===a.charAt(0)&&(a=a.substring(1)),this._processOAuthPopupParams(q.queryToObject(a)))},_createOAuthDialog:function(){var a=this._nls,d=z.substitute(a,this._oAuthDialogContent);d=z.substitute({server:"\x3cspan class\x3d'serverLink' style\x3d'word-wrap: break-word;'\x3e\x3c/span\x3e"},d);var b=new A({title:a.title,content:d,"class":"esriOAuthSignInDialog",style:"min-width: 18em;",esriIdMgr_:this,execute_:function(){var c=b.esriIdMgr_._oAuthDfd;
b.hide_();b.esriIdMgr_._doOAuthSignIn(c.resUrl_,c.sinfo_,c.oinfo_,c.codeChallenge_)},cancel_:function(){var c=b.esriIdMgr_._oAuthDfd;b.esriIdMgr_._oAuthDfd=null;b.hide_();var e=Error("ABORTED");e.code="IdentityManager.2";e.log=!!n.isDebug;c.errback(e)},hide_:function(){t.hide(b.errMsg_);b.hide();A._DialogLevelManager.hide(b)}});a=b.domNode;b.btnSubmit_=B.byNode(p.query(".esriIdSubmit",a)[0]);b.btnCancel_=B.byNode(p.query(".esriIdCancel",a)[0]);b.serverLink_=p.query(".serverLink",a)[0];b.errMsg_=p.query(".esriErrorMsg",
a)[0];b.connect(b.btnSubmit_,"onClick",b.execute_);b.connect(b.btnCancel_,"onClick",b.onCancel);b.connect(b,"onCancel",b.cancel_);return b},_doOAuthSignIn:function(a,d,b,c){var e=this,g=b._oAuthCred,f={portalUrl:b.portalUrl};!b.popup&&b.preserveUrlHash&&window.location.hash&&(f.hash=window.location.hash);g.stateUID&&(f.uid=g.stateUID);f={client_id:b.appId,response_type:g.codeVerifier?"code":"token",state:JSON.stringify(f),expiration:b.expiration,locale:b.locale,redirect_uri:this._getRedirectURI(b,
!!g.codeVerifier)};b.forceLogin&&(f.force_login=!0);b.forceUserId&&b.userId&&(f.prepopulatedusername=b.userId);!b.popup&&this._doPortalSignIn(a)&&(f.redirectToUserOrgUrl=!0);g.codeVerifier&&(f.code_challenge=c||g.codeVerifier,f.code_challenge_method=c?"S256":"plain");c=b.portalUrl.replace(/^http:/i,"https:")+"/sharing/oauth2/authorize";g=c+"?"+q.objectToQuery(f);if(b.popup){var k=window.open(g,"esriJSAPIOAuth",b.popupWindowFeatures);k?(k.focus(),this._oAuthDfd.oAuthWin_=k,this._oAuthIntervalId=setInterval(function(){if(k.closed){clearInterval(e._oAuthIntervalId);
e._oAuthOnPopupHandle.remove();var h=e._oAuthDfd;if(h){var l=Error("ABORTED");l.code="IdentityManager.2";l.log=!!n.isDebug;h.errback(l)}}},500),e._oAuthOnPopupHandle=E.on(window,["arcgis:auth:hash","arcgis:auth:location:search"],function(h){"arcgis:auth:hash"===h.type?e.setOAuthResponseHash(h.detail):e._setOAuthResponseQueryString(h.detail)})):(a=Error("ABORTED"),a.name="identity-manager:user-aborted",a.code="IdentityManager.2",a.log=!!n.isDebug,this._oAuthDfd.errback(a))}else this._rejectOnPersistedPageShow=
!0,this._oAuthRedirectFunc?this._oAuthRedirectFunc({authorizeParams:f,authorizeUrl:c,resourceUrl:a,serverInfo:d,oAuthInfo:b}):window.location.href=g},_getCodeChallenge:function(a){if(a&&window.isSecureContext)return a=(new TextEncoder).encode(a),x.subtle.digest("SHA-256",a).then(function(d){return m.base64UrlEncode(new Uint8Array(d))});a=new u;a.resolve(null);return a},_getRedirectURI:function(a,d){var b=window.location.href.replace(/#.*$/,"");if(a.popup)return m.getAbsoluteUrl(a.popupCallbackUrl);
if(d){var c=m.urlToObject(b);if(c.query)return"code error error_description message_code persist state".split(" ").forEach(function(e){delete c.query[e]}),(b=q.objectToQuery(c.query))?c.path+"?"+b:c.path}return b},_processOAuthPopupParams:function(a){var d=this._oAuthDfd;this._oAuthDfd=null;if(d)if(clearInterval(this._oAuthIntervalId),this._oAuthOnPopupHandle&&this._oAuthOnPopupHandle.remove(),a.error){var b="access_denied"===a.error;a=Error(b?"ABORTED":"OAuth: "+a.error+" - "+a.error_description);
a.name=b?"identity-manager:user-aborted":"identity-manager:authentication-failed";a.code="IdentityManagerBase."+(b?2:3);a.log=!!n.isDebug;d.errback(a)}else this._processOAuthResponseParams(a,d.oinfo_,d.sinfo_).then(function(c){d.resolve(c)})["catch"](function(c){d.reject(c)})},_processOAuthResponseParams:function(a,d,b){var c=d._oAuthCred;if(a.code){var e=c.codeVerifier;c.codeVerifier=null;c.stateUID=null;c.save();return this._getOAuthToken(b.server,a.code,d.appId,this._getRedirectURI(d,!0),e).then(function(f){var k=
new y({userId:f.username,server:b.server,token:f.access_token,expires:Date.now()+1E3*f.expires_in,ssl:f.ssl,oAuthState:a.state,_oAuthCred:c});d.userId=k.userId;c.storage=f.persist?v:w;c.refreshToken=f.refresh_token;c.token=null;c.expires=f.refresh_token_expires_in?Date.now()+1E3*f.refresh_token_expires_in:null;c.userId=k.userId;c.ssl=k.ssl;c.save();return k})}e=new y({userId:a.username,server:b.server,token:a.access_token,expires:Date.now()+1E3*Number(a.expires_in),ssl:"true"===a.ssl,oAuthState:a.state,
_oAuthCred:c});d.userId=e.userId;c.storage=a.persist?v:w;c.refreshToken=null;c.token=e.token;c.expires=e.expires;c.userId=e.userId;c.ssl=e.ssl;c.save();var g=new u;g.resolve(e);return g},_setOAuthResponseQueryString:function(a){a&&("?"===a.charAt(0)&&(a=a.substring(1)),this._processOAuthPopupParams(q.queryToObject(a)))}}});