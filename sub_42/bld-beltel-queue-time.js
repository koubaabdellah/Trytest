import{setPaths,createHTMLElement,setWCMJsonUrl,metrixCount}from"./bld-cci-utils.js";export class BldBeltelQueueTime extends HTMLElement{constructor(){super(),this.version="1.0.1",this.autoUpdate="false"!==new URL(document.location).searchParams.get("bld-autoupdate"),this.updater,this.attachShadow({mode:"open"}),this._data={lastUpdate:{},debug:"true"===new URL(document.location).searchParams.get("bld-debug"),GMSBaseURLsObj:{acc:"https://cciwebstats.acc.belastingdienst.nl/api/",prod:"https://cciwebstats.belastingdienst.nl/api/"},genesys:{currentDepartmentCode:"",gmsUrl:"",debugGmsUrl:"/bld-assets/bld/webcomponents/debug/queue_time/",departments:{name:"departments",data:{},hasReceivedData:!1},department:{name:"department",data:{},hasReceivedData:!1}},WCM:{data:{},hasReceivedData:!1,jsonUrl:setWCMJsonUrl({jsonPathLocal:"data/wcm/bld-beltel-queue-time.json",jsonPathWcm:"cci-content/wachtrijtijden-beltel/bld-beltel-queue-time.json",projectID:""})},hostServerUrl:"",departementsOptions:[],error:{state:"",defaultError:{title:"Er is een fout opgetreden.",text:"Het is op dit moment niet mogelijk om de wachttijd op te halen."}},interval:{time:new URL(document.location).searchParams.get("bld-interval-time")&&!1===isNaN(new URL(document.location).searchParams.get("bld-interval-time"))?parseInt(new URL(document.location).searchParams.get("updateInterval")):2e4,counter:0},metrix:{category:"beltel-queuetime"}},this.setUrls()}async connectedCallback(){await this.getDepartments(),this._data.genesys.departments.hasReceivedData&&(await this.setData(this._data.departementsOptions[0].value),this._data.genesys.department.hasReceivedData&&(await this.getJSONFromWCM(),this._data.WCM.hasReceivedData&&this.checkWCMContent()&&(this.createTemplate(),this.shadowRoot.appendChild(this.template.content.cloneNode(!0)),this.addEventListenerToElements())))}setUrls(){const{GMSBaseURL:e,hostServerUrl:t}=setPaths(this._data.GMSBaseURLsObj);this._data.genesys.gmsUrl=e,this._data.hostServerUrl=t}async getJSONFromWCM(){await fetch(this._data.WCM.jsonUrl).then(e=>{if(!e.ok)throw Error(e.statusText);return e.json()}).then(e=>{this._data.WCM.data=e,this._data.WCM.hasReceivedData=!0}).catch(e=>{console.error("Error in getJSONFromWCM():",e),this._data.WCM.hasReceivedData=!1})}checkWCMContent(){if(this._data.WCM.data.queueTimeData&&void 0!==this._data.WCM.data.queueTimeData){const{intro:{title:e,selectDepartment:{label:t}},queueTimeData:{labelQueueTime:a,suffixQueueTime:s,suffixQueueTimeSingular:n,insertionQueueTime:r,labelOpeningTime:i,suffixOpeningTime:d,insertionOpeningTime:l}}=this._data.WCM.data,o=[e,t,i,d,l,a,s,n,r].every(e=>"string"==typeof e&&e.length>0);if(o)return o;console.error("Error in checkWCMContent(): <bld-beltel-queue-time.json> doesn't meet the requirements.")}}createTemplate(){this.template=document.createElement("template");const e=this._data.WCM.data;this.template.innerHTML=`\n        <style>\n            @import '${this._data.hostServerUrl}/bld-assets/bld/webcomponents/bld-beltel-queue_time.css';\n        </style>\n        <div class="bld_beltel_queue_time_container">\n            <bldc-grid disable-padding>\n                <bldc-grid-row>\n                    <bldc-grid-column col="8" md="12" disable-padding style="margin-bottom: 1rem;">\n                        <bldc-heading level="2" size="xl" color="#154273">${e.intro.title}</bldc-heading>\n                    </bldc-grid-column>\n                </bldc-grid-row>\n                <bldc-grid-row>\n                    <bldc-grid-column col="8" md="12" disable-padding style="margin-bottom: 1rem;">\n                        <bldc-select-box class="bld_beltel_queue_time_select" data='${JSON.stringify(this._data.departementsOptions)}' placeholder="${e.intro.selectDepartment.placeholder}" aria-controls="bld_beltel_queue_time_result">\n                            <span slot="label">${e.intro.selectDepartment.label}</span>\n                        </bldc-select-box>\n                    </bldc-grid-column>\n                </bldc-grid-row>\n                <bldc-grid-row>\n                    <bldc-grid-column col="8" md="12" disable-padding>\n                        <div class="bld_beltel_queue_time_result" role="region" id="bld_beltel_queue_time_result" aria-live="polite"></div>\n                    </bldc-grid-column>\n                </bldc-grid-row>\n                <bldc-grid-row>\n                    <bldc-grid-column col="8" md="12" disable-padding style="margin-bottom: 1rem;">\n                        <div class="bld_beltel_queue_time_error"></div>\n                    </bldc-grid-column>\n                </bldc-grid-row>\n            </bldc-grid>\n        </div>\n        `}addEventListenerToElements(){this.shadowRoot.querySelector(".bld_beltel_queue_time_select").addEventListener("bldcValueChange",e=>{this._data.genesyscurrentDepartmentCode=e.detail,this._data.genesyscurrentDepartmentCode.length>0&&(this._data.interval.counter=0,clearInterval(this.updater),this.getAndShowData(),!0===this.autoUpdate&&this.runAutoUpdate()),metrixCount(this._data.metrix.category,`select-department:${this._data.departementsOptions.find(t=>t.value===e.detail).title}`)})}runAutoUpdate(){this._data.interval&&this._data.interval.time&&"number"==typeof this._data.interval.time&&this._data.interval.time>=1e3&&(this.updater=setInterval(()=>{this._data.interval.counter++,!0===this._data.debug&&console.log("runAutoUpdate",this._data.interval.counter),this.checkForUpdate()},this._data.interval.time))}async checkForUpdate(){await this.setData(this._data.genesyscurrentDepartmentCode),this.getMinutesRoundedUp(this._data.genesys.department.data.awt)===this.getMinutesRoundedUp(this._data.lastUpdate.awt)&&this._data.genesys.department.data.openinghours===this._data.lastUpdate.openinghours&&this._data.genesys.department.data.isopen===this._data.lastUpdate.isopen||this.setResult()}async getAndShowData(){await this.setData(this._data.genesyscurrentDepartmentCode),this.setResult()}getMinutesRoundedUp(e){if(e&&"string"==typeof e&&e.length>0){const t=e.split(":"),a=1e3*(60*+t[0]*60+60*+t[1]+ +t[2]);return Math.ceil(a/6e4)}return e}getFormattedQueueTime(e){const{suffixQueueTime:t,suffixQueueTimeSingular:a,insertionQueueTime:s}=this._data.WCM.data.queueTimeData,n=this.getMinutesRoundedUp(e),r=Math.floor(n/60),i=n-60*r,d=1===i?a:t;return r>=1?`${r}${s}${i}${d}`:`${i}${d}`}clearElementBasedOnClass(e){this.shadowRoot.querySelector(e)&&this.shadowRoot.querySelector(e).querySelectorAll("*").forEach(e=>e.remove())}async getDepartments(){let e="";const{gmsUrl:t,departments:{name:a}}=this._data.genesys;e=this._data.debug?`${this._data.hostServerUrl}${this._data.genesys.debugGmsUrl}${a}.json`:`${t}${a}`,await fetch(e).then(t=>{if(t.ok)return t.json();throw Error(`${e}  ${t.status} (${t.statusText})`)}).then(e=>{this._data.genesys.departments.data=e,this._data.genesys.departments.data.forEach(e=>this._data.departementsOptions.push({title:e.displayname,value:e.code})),this._data.genesys.departments.hasReceivedData=!0}).catch(e=>{console.error("Error in setData: ",e),this._data.genesys.departments.hasReceivedData=!1})}async setData(e){if(!0===this._data.debug&&"fout"===e&&this._data.interval.counter>=3&&this._data.interval.counter<8&&(e="open1.json"),this._data.genesys.department.data={},e&&"string"==typeof e&&e.length>0){const t=`?departmentcode=${e}`,{gmsUrl:a,department:{name:s}}=this._data.genesys;let n;n=this._data.debug?`${this._data.hostServerUrl}${this._data.genesys.debugGmsUrl}${e}`:`${a}${s}${t}`,await fetch(n,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}}).then(e=>{if(e.ok)return e.json();throw Error(`${n} ${e.status} (${e.statusText})`)}).then(e=>{if(this._data.debug&&(this._data.interval.counter>=3&&this._data.interval.counter<6&&(e.awt="00:02:15",e.isopen=!0),this._data.interval.counter>=6&&this._data.interval.counter<10&&(e.awt="00:00:00",e.isopen=!1),this._data.interval.counter>=10&&this._data.interval.counter<15&&(e.awt="00:00:00",e.openinghours="",e.isopen=!1),this._data.interval.counter>=15&&this._data.interval.counter<20&&delete e.awt),"string"!=typeof e.awt||"string"!=typeof e.openinghours||"boolean"!=typeof e.isopen)throw Error(`${n} ${response.status} (${response.statusText})`);this._data.genesys.department.data=e,this._data.genesys.department.hasReceivedData=!0}).catch(e=>{this.clearElementBasedOnClass(".bld_beltel_queue_time_result"),console.error("Error in setData: ",e),this.showErrorNotification("no-response-for-department"),this._data.genesys.department.hasReceivedData=!1})}}setResult(){this._data.error.state="",this.clearElementBasedOnClass(".bld_beltel_queue_time_error"),this.clearElementBasedOnClass(".bld_beltel_queue_time_result"),this._data.lastUpdate=this._data.genesys.department.data;const{labelQueueTime:e,labelOpeningTime:t,insertionOpeningTimes:a,outsideOpeningHoursOfToday:s,closedToday:n}=this._data.WCM.data.queueTimeData,{awt:r,openinghours:i,isopen:d}=this._data.genesys.department.data;if("string"==typeof r&&r.length>0&&"string"==typeof i&&"boolean"==typeof d){const l=this.getFormattedQueueTime(r);if(!0===d){const t=createHTMLElement("bldc-paragraph",{"disable-margin":!0},`${e}<span class="bld_beltel_queue_time_result-item">${l}</span>`);this.shadowRoot.querySelector(".bld_beltel_queue_time_result").insertAdjacentElement("beforeend",t)}else"00:00:00"===r&&!1===d&&i.length>0&&this.shadowRoot.querySelector(".bld_beltel_queue_time_result").insertAdjacentElement("beforeend",createHTMLElement("bldc-paragraph",{"disable-margin":!0},s));if(i.length>0){const e=this.getFormatAllOpeninghours(i);let s="";if(e.length>1)for(let t=0;t<e.length;t++)s+=`${e[t]}${t<e.length-1?a:""}`;else 1===e.length&&(s=`${e[0]}`);this.shadowRoot.querySelector(".bld_beltel_queue_time_result").insertAdjacentElement("beforeend",createHTMLElement("bldc-paragraph",{"disable-margin":!0},`${t}${s}`))}"00:00:00"===r&&""===i&&!1===d&&this.shadowRoot.querySelector(".bld_beltel_queue_time_result").insertAdjacentElement("beforeend",createHTMLElement("bldc-paragraph",{"disable-margin":!0},n));const{additionalText:o}=this._data.WCM.data.queueTimeData;"string"==typeof o&&o.length>0&&this.shadowRoot.querySelector(".bld_beltel_queue_time_result").insertAdjacentElement("beforeend",createHTMLElement("bldc-paragraph",{"disable-margin":!0},o))}}getFormatAllOpeninghours(e){const{insertionOpeningTime:t,suffixOpeningTime:a}=this._data.WCM.data.queueTimeData;let s=e.split(",");return s.forEach((e,s,n)=>{let r=e.split("-");r.forEach((e,t,a)=>{let s=e.split(":");a[t]=`${2===s[0].length&&0===s[0].indexOf("0")?s[0].charAt(1):s[0]}.${s[1]}`}),n[s]=`<span class="bld_beltel_queue_time_result-item">${r[0]}${t}${r[1]}<span aria-hidden="true">${a}</span></span>`}),s}showErrorNotification(e){if(this._data.error.state!==e){let t;if(this._data.WCM.data.errors&&this._data.WCM.data.errors[e]){const{title:a,text:s}=this._data.WCM.data.errors[e];t=[a,s].every(e=>"string"==typeof e&&e.length>0)?this._data.WCM.data.errors[e]:this._data.error.defaultError}else t=this._data.error.defaultError;this.shadowRoot.querySelector(".bld_beltel_queue_time_error").insertAdjacentElement("beforeend",createHTMLElement("bldc-notification",{type:"error","elem-title":t.title},t.text)),this._data.error.state=e}}}