// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.24/esri/copyright.txt for details.//>>built
define("exports ../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/Accessor ../../core/maybe ../../core/promiseUtils ../../core/accessorSupport/decorators/property ../../core/arrayUtils ../../core/has ../../core/accessorSupport/ensureType ../../core/accessorSupport/decorators/subclass ../../geometry/support/heightModelInfoUtils ../ViewingMode ./projectionUtils".split(" "),function(f,t,h,y,e,u,k,C,D,E,z,v,w,A){f.DefaultsFromMap=function(x){function q(a){a=x.call(this,a)||this;
a.required={tileInfo:!1,heightModelInfo:!1,extent:!1};a.defaultSpatialReference=null;a.userSpatialReference=null;a.sourcePreloadCount=10;a.priorityCollection=null;a.requiresExtentInSpatialReference=!0;a.suspended=!1;a._projectExtentTask={task:null,input:null,output:null,spatialReference:null};return a}t._inheritsLoose(q,x);var n=q.prototype;n.destroy=function(){this._projectExtentTask.task&&(this._projectExtentTask.task=e.abortMaybe(this._projectExtentTask.task));this._set("map",null)};n._narrowDownSpatialReferenceCandidates=
function(a,b){if(e.isNone(a))return b;const d=[];for(const c of a)for(const l of b)if(c.spatialReference.equals(l.spatialReference)){a=c.viewingMode;var g=l.viewingMode;a=e.isSome(a)?e.isSome(g)?a===g?a:!1:a:g;if(!1!==a){d.push({spatialReference:c.spatialReference,viewingMode:a});break}}return 0<d.length?d:null};n._pickSpatialReferenceCandidate=function(a){const b=this.defaultSpatialReference;if(e.isNone(a)||1>a.length)return e.isSome(b)?{spatialReference:b,viewingMode:null}:null;e.isSome(b)&&1<a.length&&
a.some(({spatialReference:d})=>d.equals(b))&&(a=a.filter(({spatialReference:d})=>d.equals(b)));1<a.length&&a.some(({viewingMode:d})=>d!==w.ViewingMode.Local)&&(a=a.filter(({viewingMode:d})=>d!==w.ViewingMode.Local));return a[0]};n._getSupportedSpatialReferences=function(a){var b="supportedSpatialReferences"in a&&a.supportedSpatialReferences||(a.spatialReference?[a.spatialReference]:[]);if(0===b.length)return[];const d=[];for(const g of b)if(b=this.getSpatialReferenceSupport({spatialReference:g,layer:a}),
e.isSome(b)){b=e.isSome(b.constraints)?b.constraints:[{spatialReference:g,viewingMode:null}];for(const {spatialReference:c,viewingMode:l}of b)(!this.requiresExtentInSpatialReference||e.isNone(this.userSpatialReference)||c.equals(this.userSpatialReference))&&d.push({spatialReference:c,viewingMode:l})}return d};n._pickExtentCandidate=function(a){const b=this.spatialReference;return a.find(({extent:d})=>b.equals(d.spatialReference))||a[0]};n._collectLayers=function(a){var b;if("loaded"!==this._loadMaybe(null==
(b=this.map)?void 0:b.call(this)))return{layers:[],updating:!0};b={layers:[],preloading:-1,updating:!1};for(const d of a)if(this._collectCollection(d,b),b.preloading===this.sourcePreloadCount)break;return{layers:b.layers,updating:b.updating}};n._collectCollection=function(a,b){if(a.layers){switch(this._loadMaybe(a.parent)){case "loading":b.updating=!0;++b.preloading;return;case "failed":return}for(const d of a.layers){switch(this._loadMaybe(d)){case "failed":continue;case "loading":b.updating=!0;
++b.preloading;break;case "loaded":b.updating||b.layers.push(d),"layers"in d&&this._collectCollection({layers:d.layers},b)}if(b.preloading===this.sourcePreloadCount)break}}};n._loadMaybe=function(a){return a&&"loadStatus"in a?"not-loaded"===a.loadStatus?(a.load(),"loading"):a.loadStatus:"loaded"};t._createClass(q,[{key:"ready",get:function(){return!this._spatialReferenceTask.updating&&!this._tileInfoTask.updating&&!this._extentTask.updating}},{key:"heightModelInfoReady",get:function(){return!this._heightModelInfoTask.updating}},
{key:"spatialReference",get:function(){return e.isSome(this.userSpatialReference)?this.userSpatialReference:e.unwrap(this._spatialReferenceTask.spatialReference)}},{key:"extent",get:function(){return e.unwrap(this._extentTask.extent)}},{key:"heightModelInfo",get:function(){return e.unwrap(this._heightModelInfoTask.heightModelInfo)}},{key:"vcsWkid",get:function(){return e.unwrap(this._heightModelInfoTask.vcsWkid)}},{key:"latestVcsWkid",get:function(){return e.unwrap(this._heightModelInfoTask.latestVcsWkid)}},
{key:"viewingMode",get:function(){return e.isNone(this.userSpatialReference)||this.userSpatialReference.equals(e.unwrap(this._spatialReferenceTask.spatialReference))?e.unwrap(this._spatialReferenceTask.viewingMode):null}},{key:"tileInfo",get:function(){return e.unwrap(this._tileInfoTask.tileInfo)}},{key:"mapCollections",get:function(){var a,b,d,g;const c=null==(a=this.map)?void 0:a.call(this);a=[];e.isSome(this.priorityCollection)&&a.push(this.priorityCollection);a.push({parent:null==c?void 0:c.basemap,
layers:null==c?void 0:null==(b=c.basemap)?void 0:b.baseLayers},{layers:null==c?void 0:c.layers},{parent:null==c?void 0:c.ground,layers:null==c?void 0:null==(d=c.ground)?void 0:d.layers},{parent:null==c?void 0:c.basemap,layers:null==c?void 0:null==(g=c.basemap)?void 0:g.referenceLayers});return a}},{key:"_allLayers",get:function(){return this._collectLayers(this.mapCollections)}},{key:"_spatialReferenceTask",get:function(){if(this.suspended){var a;return null!=(a=this._get("_spatialReferenceTask"))?
a:{updating:!1}}const {layers:b,updating:d}=this._allLayers;a=null;for(var g of b){var c=this._getSupportedSpatialReferences(g);0<c.length&&(c=this._narrowDownSpatialReferenceCandidates(a,c),e.isSome(c)&&(a=c));if(e.isSome(a)&&1===a.length)break}if(d&&(e.isNone(a)||1!==a.length))return{updating:!0};g=this._pickSpatialReferenceCandidate(a);return{spatialReference:e.isSome(g)?g.spatialReference:null,viewingMode:e.isSome(g)?g.viewingMode:null,updating:!1}}},{key:"_tileInfoTask",get:function(){var a,
b,d,g,c,l,m;if(!this.required.tileInfo){var p;return null!=(p=this._get("_tileInfoTask"))?p:{updating:!1}}if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const {layers:r,updating:B}=this._collectLayers([{parent:null==(a=this.map)?void 0:null==(b=a.call(this))?void 0:b.basemap,layers:null==(d=this.map)?void 0:null==(g=d.call(this))?void 0:null==(c=g.basemap)?void 0:c.baseLayers},{layers:null==(l=this.map)?void 0:null==(m=l.call(this))?void 0:m.layers}]);return r&&0<r.length&&
"tileInfo"in r[0]?(a=r[0].tileInfo,{tileInfo:a&&a.spatialReference.equals(this.spatialReference)?a:null,updating:!1}):{updating:B}}},{key:"_heightModelInfoTask",get:function(){var a;if(!this.required.heightModelInfo||this.suspended&&null!=(a=this._get("_heightModelInfoTask"))&&a.heightModelInfo){var b;return null!=(b=this._get("_heightModelInfoTask"))?b:{updating:!1}}const {layers:d,updating:g}=this._allLayers;for(const m of d)if(v.supportsHeightModelInfo(m)&&(a=v.deriveHeightModelInfoFromLayer(m))){var c,
l;return{heightModelInfo:a,vcsWkid:null==(c=m.spatialReference)?void 0:c.vcsWkid,latestVcsWkid:null==(l=m.spatialReference)?void 0:l.latestVcsWkid,updating:!1}}return{updating:g}}},{key:"_extentCandidatesTask",get:function(){if(this.suspended||!this.required.extent){var a;return null!=(a=this._get("_extentCandidatesTask"))?a:{updating:!1}}if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};var b=this._allLayers;a=b.updating;const d=[];for(const l of b.layers){var g;b="fullExtents"in
l&&l.fullExtents||(e.isSome(l.fullExtent)?[l.fullExtent]:[]);var c=this.requiresExtentInSpatialReference?null:b[0];if(c=null!=(g=b.find(m=>m.spatialReference.equals(this.spatialReference)))?g:c)return{candidates:[{extent:c,layer:l}],updating:!1};if(0<this._getSupportedSpatialReferences(l).length)for(const m of b)d.push({extent:m,layer:l})}return{candidates:d,updating:a}}},{key:"_extentTask",get:function(){var a=this;const {candidates:b,updating:d}=this._extentCandidatesTask;if(d)return{updating:d};
if(e.isNone(b)||0===b.length)return{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const g=this._pickExtentCandidate(b),c=this.spatialReference;if(g.extent.equals(this._projectExtentTask.input)&&c.equals(this._projectExtentTask.spatialReference))return{extent:this._projectExtentTask.output,updating:e.isSome(this._projectExtentTask.task)&&!this._projectExtentTask.task.finished};e.isSome(this._projectExtentTask.task)&&(this._projectExtentTask.task=e.abortMaybe(this._projectExtentTask.task));
this._projectExtentTask={input:g.extent.clone(),output:null,spatialReference:c.clone(),task:u.createTask(function(){var l=t._asyncToGenerator(function*(m){try{const p=yield A.projectWithEngineOrService(g.extent,c,g.layer.portalItem,m);a._projectExtentTask={...a._projectExtentTask,task:null,output:p}}catch(p){u.isAborted(m)||(a._projectExtentTask={...a._projectExtentTask,task:null})}});return function(m){return l.apply(this,arguments)}}())};return{updating:!0}}}]);return q}(y);h.__decorate([k.property()],
f.DefaultsFromMap.prototype,"required",void 0);h.__decorate([k.property({constructOnly:!0})],f.DefaultsFromMap.prototype,"map",void 0);h.__decorate([k.property({constructOnly:!0})],f.DefaultsFromMap.prototype,"getSpatialReferenceSupport",void 0);h.__decorate([k.property()],f.DefaultsFromMap.prototype,"defaultSpatialReference",void 0);h.__decorate([k.property()],f.DefaultsFromMap.prototype,"userSpatialReference",void 0);h.__decorate([k.property()],f.DefaultsFromMap.prototype,"sourcePreloadCount",void 0);
h.__decorate([k.property()],f.DefaultsFromMap.prototype,"priorityCollection",void 0);h.__decorate([k.property()],f.DefaultsFromMap.prototype,"requiresExtentInSpatialReference",void 0);h.__decorate([k.property()],f.DefaultsFromMap.prototype,"suspended",void 0);h.__decorate([k.property({readOnly:!0})],f.DefaultsFromMap.prototype,"ready",null);h.__decorate([k.property({readOnly:!0})],f.DefaultsFromMap.prototype,"heightModelInfoReady",null);h.__decorate([k.property({readOnly:!0})],f.DefaultsFromMap.prototype,
"spatialReference",null);h.__decorate([k.property({readOnly:!0})],f.DefaultsFromMap.prototype,"extent",null);h.__decorate([k.property({readOnly:!0})],f.DefaultsFromMap.prototype,"heightModelInfo",null);h.__decorate([k.property({readOnly:!0})],f.DefaultsFromMap.prototype,"vcsWkid",null);h.__decorate([k.property({readOnly:!0})],f.DefaultsFromMap.prototype,"latestVcsWkid",null);h.__decorate([k.property({readOnly:!0})],f.DefaultsFromMap.prototype,"viewingMode",null);h.__decorate([k.property({readOnly:!0})],
f.DefaultsFromMap.prototype,"tileInfo",null);h.__decorate([k.property({readOnly:!0})],f.DefaultsFromMap.prototype,"mapCollections",null);h.__decorate([k.property({readOnly:!0})],f.DefaultsFromMap.prototype,"_allLayers",null);h.__decorate([k.property({readOnly:!0})],f.DefaultsFromMap.prototype,"_spatialReferenceTask",null);h.__decorate([k.property({readOnly:!0})],f.DefaultsFromMap.prototype,"_tileInfoTask",null);h.__decorate([k.property({readOnly:!0})],f.DefaultsFromMap.prototype,"_heightModelInfoTask",
null);h.__decorate([k.property({readOnly:!0})],f.DefaultsFromMap.prototype,"_extentCandidatesTask",null);h.__decorate([k.property()],f.DefaultsFromMap.prototype,"_extentTask",null);h.__decorate([k.property()],f.DefaultsFromMap.prototype,"_projectExtentTask",void 0);f.DefaultsFromMap=h.__decorate([z.subclass("esri.views.support.DefaultsFromMap")],f.DefaultsFromMap);Object.defineProperties(f,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});