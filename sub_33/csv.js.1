//>>built
define("esri/arcgis/csv","dojo/_base/lang dojo/_base/array dojo/_base/Deferred dojo/sniff dojo/number dojox/data/CsvStore ../kernel ../config ../request ../SpatialReference ../geometry/jsonUtils ../geometry/webMercatorUtils".split(" "),function(r,g,G,U,V,W,X,H,Y,D,I,J){function K(b){var c=0,d="";g.forEach([","," ",";","|","\t"],function(h){var k=b.split(h).length;k>c&&(c=k,d=h)});return d}function L(b,c){if(!b||"[object Date]"!==Object.prototype.toString.call(b)||isNaN(b.getTime()))return!1;var d=
!0;if(U("chrome")&&/\d+\W*$/.test(c)){if(c.match(/[^0-9a-zA-Z\s]/))return!1;var h=c.match(/[a-zA-Z]{2,}/);if(h){d=!1;for(var k=0,l=h.length,p=/^((jan(uary)?)|(feb(ruary)?)|(mar(ch)?)|(apr(il)?)|(may)|(jun(e)?)|(jul(y)?)|(aug(ust)?)|(sep(tember)?)|(oct(ober)?)|(nov(ember)?)|(dec(ember)?)|(am)|(pm)|(gmt)|(utc))$/i;!d&&k<=l&&!(d=!p.test(h[k]));)k++;d=!d}}return d}function M(b,c,d){var h=b.indexOf("\n");h=r.trim(b.substr(0,h));var k=c.columnDelimiter;k||(k=K(h));var l=new W({data:b,separator:k});l.fetch({onComplete:function(p,
n){var a=0,m={layerDefinition:c.layerDefinition,featureSet:{features:[],geometryType:"esriGeometryPoint"}},e=m.layerDefinition.objectIdField,w=m.layerDefinition.fields;e||g.some(w,function(f){return"esriFieldTypeOID"===f.type?(e=f.name,!0):!1})||(w.push({name:"__OBJECTID",alias:"__OBJECTID",type:"esriFieldTypeOID",editable:!1}),e="__OBJECTID");var y=l._attributes,N=[],z=[];g.forEach(w,function(f){"esriFieldTypeDate"===f.type?N.push(f.name):("esriFieldTypeDouble"===f.type||"esriFieldTypeInteger"===
f.type)&&z.push(f.name)});if(c.locationInfo&&"coordinates"===c.locationInfo.locationType){var t=c.locationInfo.latitudeFieldName;var u=c.locationInfo.longitudeFieldName}else g.forEach(y,function(f){var q=g.indexOf(O,f.toLowerCase());-1!==q&&(t=f);q=g.indexOf(P,f.toLowerCase());-1!==q&&(u=f)}),t&&u&&(c.locationInfo={locationType:"coordinates",latitudeFieldName:t,longitudeFieldName:u});if(t&&u){-1===g.indexOf(z,t)&&z.push(t);-1===g.indexOf(z,u)&&z.push(u);if(r.isArray(c.outFields)&&-1===g.indexOf(c.outFields,
"*"))var A=c.outFields;g.forEach(y,function(f){g.some(w,function(q){return f===q.name})||w.push({name:f,alias:f,type:f===t||f===u?"esriFieldTypeDouble":"esriFieldTypeString"})});y=0;var Z=p.length;for(y;y<Z;y++){var B=p[y],C=l.getAttributes(B),v={};g.forEach(C,function(f){if(f&&(f===t||f===u||!A||-1<g.indexOf(A,f))){var q=f;0===f.length&&g.forEach(w,function(aa,Q){aa.name==="attribute_"+(Q-1)&&(f="attribute_"+(Q-1))});if(-1<g.indexOf(N,f)){q=l.getValue(B,q);var x=new Date(q);v[f]=L(x,q)?x.getTime():
null}else-1<g.indexOf(z,f)?(x=V.parse(l.getValue(B,q)),f!==t&&f!==u||!(isNaN(x)||181<Math.abs(x))||(x=parseFloat(l.getValue(B,q))),isNaN(x)?v[f]=null:v[f]=x):v[f]=l.getValue(B,q)}});v[e]=a;a++;C=v[t];var E=v[u];null==E||null==C||isNaN(C)||isNaN(E)||(A&&-1===g.indexOf(A,t)&&delete v[t],A&&-1===g.indexOf(A,u)&&delete v[u],m.featureSet.features.push({geometry:{x:E,y:C,spatialReference:{wkid:4326}},attributes:v}))}m.layerDefinition.name="csv";d&&d(m)}else setTimeout(function(){},1),d&&d(null,Error("File does not seem to contain fields with point coordinates."))},
onError:function(p){d&&d(null,p)}});return!0}function F(b,c,d,h,k,l){0===b.length&&k(null);var p=I.getGeometryType(c),n=[];g.forEach(b,function(a){a=new p(a);a.spatialReference=d;n.push(a)},this);c=[102113,102100,3857];d.wkid&&4326===d.wkid&&h.wkid&&-1<g.indexOf(c,h.wkid)?(g.forEach(n,function(a){a.xmin?(a.xmin=Math.max(a.xmin,-180),a.xmax=Math.min(a.xmax,180),a.ymin=Math.max(a.ymin,-89.99),a.ymax=Math.min(a.ymax,89.99)):a.rings?g.forEach(a.rings,function(m){g.forEach(m,function(e){e[0]=Math.min(Math.max(e[0],
-180),180);e[1]=Math.min(Math.max(e[1],-89.99),89.99)},this)},this):a.paths?g.forEach(a.paths,function(m){g.forEach(m,function(e){e[0]=Math.min(Math.max(e[0],-180),180);e[1]=Math.min(Math.max(e[1],-89.99),89.99)},this)},this):a.x&&(a.x=Math.min(Math.max(a.x,-180),180),a.y=Math.min(Math.max(a.y,-89.99),89.99))},this),b=[],g.forEach(n,function(a){a=J.geographicToWebMercator(a);102100!==h.wkid&&(a.spatialReference=h);b.push(a.toJson())},this),k(b)):null!==d.wkid&&-1<g.indexOf(c,d.wkid)&&null!==h.wkid&&
4326===h.wkid?(b=[],g.forEach(n,function(a){b.push(J.webMercatorToGeographic(a).toJson())},this),k(b)):(c=function(a,m){a&&a.length===b.length?(b=[],g.forEach(a,function(e){e&&(e.rings&&0<e.rings.length&&0<e.rings[0].length&&0<e.rings[0][0].length&&!isNaN(e.rings[0][0][0])&&!isNaN(e.rings[0][0][1])||e.paths&&0<e.paths.length&&0<e.paths[0].length&&0<e.paths[0][0].length&&!isNaN(e.paths[0][0][0])&&!isNaN(e.paths[0][0][1])||e.xmin&&!isNaN(e.xmin)&&e.ymin&&!isNaN(e.ymin)||e.x&&!isNaN(e.x)&&e.y&&!isNaN(e.y))?
b.push(e.toJson()):b.push(null)},this),k(b)):l(a,m)},H.defaults.geometryService?H.defaults.geometryService.project(n,h,r.hitch(this,c),l):k(null))}function R(b,c){var d=[102113,102100,3857];return b&&c&&b.wkid===c.wkid&&b.wkt===c.wkt||b&&c&&b.wkid&&c.wkid&&-1<g.indexOf(d,b.wkid)&&-1<g.indexOf(d,c.wkid)?!0:!1}function S(b,c,d,h){if(b.featureSet&&0!==b.featureSet.features.length)if(R(d,c))h(b);else{var k=function(a){var m=[];g.forEach(b.featureSet.features,function(e,w){a[w]&&(e.geometry=a[w],m.push(e))},
this);h(b)},l=function(a,m){h(b)},p=function(a,m){F(n,b.featureSet.geometryType,c,d,r.hitch(this,k),r.hitch(this,l))};if(b.featureSet.features&&0<b.featureSet.features.length){var n=[];g.forEach(b.featureSet.features,function(a){if(a.geometry.toJson)n.push(a.geometry);else{var m=I.getGeometryType(b.featureSet.geometryType);n.push(new m(a.geometry))}});c.toJson||(c=new D(c));d.toJson||(d=new D(d));F(n,b.featureSet.geometryType,c,d,r.hitch(this,k),r.hitch(this,p))}else h(b)}}var O="lat latitude y ycenter latitude83 latdecdeg point-y lat_dd".split(" "),
P="lon lng long longitude x xcenter longitude83 longdecdeg point-x long_dd".split(" "),T={latFieldStrings:O,longFieldStrings:P,buildCSVFeatureCollection:function(b){var c=new G,d=function(k,l){l?c.errback(l):c.callback(k)},h={url:b.url,handleAs:"text",load:function(k){M(k,b,r.hitch(this,d))},error:function(k){c.errback(k)}};-1<b.url.indexOf("arcgis.com")&&-1<b.url.indexOf("/content/items")&&-1<b.url.indexOf("/data")&&(h.headers={"Content-Type":""});Y(h,{usePost:!1});return c},projectFeatureCollection:function(b,
c,d){var h=new G;d||(d=new D({wkid:4326}));S(b,d,c,r.hitch(this,function(k){h.callback(k)}));return h},generateDefaultPopupInfo:function(b){var c={esriFieldTypeDouble:1,esriFieldTypeSingle:1},d={esriFieldTypeInteger:1,esriFieldTypeSmallInteger:1},h={esriFieldTypeDate:1},k=null;b=g.map(b.layerDefinition.fields,r.hitch(this,function(l){"NAME"===l.name.toUpperCase()&&(k=l.name);var p="esriFieldTypeOID"!==l.type&&"esriFieldTypeGlobalID"!==l.type&&"esriFieldTypeGeometry"!==l.type,n=null;if(p){var a=l.name.toLowerCase();
if(-1<",stretched value,fnode_,tnode_,lpoly_,rpoly_,poly_,subclass,subclass_,rings_ok,rings_nok,".indexOf(","+a+",")||-1<a.indexOf("area")||-1<a.indexOf("length")||-1<a.indexOf("shape")||-1<a.indexOf("perimeter")||-1<a.indexOf("objectid")||a.indexOf("_")===a.length-1||a.indexOf("_i")===a.length-2&&1<a.length)p=!1;l.type in d?n={places:0,digitSeparator:!0}:l.type in c?n={places:2,digitSeparator:!0}:l.type in h&&(n={dateFormat:"shortDateShortTime"})}return r.mixin({},{fieldName:l.name,label:l.alias,
isEditable:!0,tooltip:"",visible:p,format:n,stringFieldOption:"textbox"})}));return{title:k?"{"+k+"}":"",fieldInfos:b,description:null,showAttachments:!1,mediaInfos:[]}},_getSeparator:K,_isValidDate:L,_processCsvData:M,_projectGeometries:F,_sameSpatialReference:R,_projectFeatureSet:S};r.setObject("arcgis.csv",T,X);return T});