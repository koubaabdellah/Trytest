import{setPaths,setFirst_Az_toCapital}from"./bld-cci-utils.js";export class BldCallbackComponent extends HTMLElement{constructor(){super(),this.version="2.0.0",this.attachShadow({mode:"open"}),this.urls=setPaths(),this.templateTexts={},this.fetchResponsGenesys=!1,this.fetchResponsWCM=!1,this.templateCreated=!1,this.errorCountMetrix="",this.rejectedNumbers=[],this.wcmData={config:{jsonUrl:"",jsonPathLocal:"data/wcm/bld-cci-callback.json",jsonPathWcm:"cci-content/callback/bld-cci-callback.json",projectID:"a66e19ff-4a00-49f6-8eff-64e048492edd"},response:""},this.setJsonUrl(),this._data={availableTimesForSelectedDay:[],availableTimes:{},chosenAvailableDay:"",subject:this.getAttribute("subject"),skillGroup:this.getAttribute("skill-group").split("/").pop()}}async connectedCallback(){await this.getAvailableTimes(),await this.getJSONFromWCM(),this.fetchResponsWCM&&this.fetchResponsGenesys&&(this.setVarsInText(),this.createTemplate(),this.shadowRoot.appendChild(this.template.content.cloneNode(!0)),this.addAllEventlistenersToElements())}async getJSONFromWCM(){await fetch(this.wcmData.config.jsonUrl).then(e=>{if(!e.ok)throw Error(e.statusText);return e.json()}).then(e=>(this.templateTexts=e,this.fetchResponsWCM=!0)).catch(e=>(console.error(e),this.fetchResponsWCM=!1))}setJsonUrl(){const e=new URL(window.location.href),t=e.protocol,a=e.hostname,l=e.port,i=e.pathname,n=this.wcmData.config.projectID;if("localhost"===a)this.wcmData.config.jsonUrl=t+"//"+a+(l.length>0?":"+l:"")+(0===this.wcmData.config.jsonPathLocal.indexOf("/")?"":"/")+this.wcmData.config.jsonPathLocal;else if(a.endsWith(".belastingdienst.nl")){const e=/(^\/wps\/wcm\/(my)?connect)\//g,s=i.match(e)[0];this.wcmData.config.jsonUrl=t+"//"+a+(l.length>0?":"+l:"")+s+(0===this.wcmData.config.jsonPathWcm.indexOf("/")?"":"/")+this.wcmData.config.jsonPathWcm+(n&&n.length>0?`?projectid=${n}`:"")}}setVarsInText(){if(this.templateTexts&&this.templateTexts.form&&(this.templateTexts.form.title&&(this.templateTexts.form.title=this.templateTexts.form.title.replace("[[page-subject]]",this._data.subject)),this.templateTexts.form.avgText&&this.templateTexts.form.avgLink&&this.templateTexts.form.avgLink.link)){let e=this.templateTexts.form.avgLink.link;this.templateTexts.form.avgLink.txtAfterLink&&this.templateTexts.form.avgLink.txtAfterLink.length>0&&(e+=this.templateTexts.form.avgLink.txtAfterLink),this.templateTexts.form.avgText=this.templateTexts.form.avgText.replace("[[avgLink]]",e)}}createTemplate(){return this.template=document.createElement("template"),this.HTMLBold=` \n    <style>\n      @import '${this.urls.hostServerUrl}/common_ext/cci/bld-cci.css';\n    </style>\n\n     <section name="bld_section_callback">\n\n      <bldc-grid disable-padding>\n        <div class="bld_callback_head">\n          <bldc-grid-row>\n            <bldc-grid-column col="9">\n\n              <bldc-heading bold="true" disable-margin="false" color="#000" level=2 size="xl">\n                ${this.templateTexts.introduction.title}\n              </bldc-heading>\n              <bldc-paragraph margin="false">${this.templateTexts.introduction.paragraph}</bldc-paragraph>\n              <div class="bld_callback_btn_container">\n                <bldc-button\n                        class="bld_callback-btn-show-form"\n                        name='bld_callback-btn-show-form'\n                        icon="telefoon"\n                        elem-title="${this.templateTexts.introduction.buttonConfirm}"\n                        html-type="button"\n                        matomo-event-click="bldcButtonClick"\n                        matomo-event-download="bldcDownloadEvent"\n                        matomo-variable-download-status="bldcDownloadStatus"\n                        matomo-variable-text="bldcButtonText"\n                        matomo-variable-url="bldcButtonUrl"\n                        type="primary"\n                ></bldc-button>\n                <div class="bld_callback_spinner"></div>\n              </div>\n            </bldc-grid-column>\n          </bldc-grid-row>\n        </div>\n\n        <bldc-form class="bld_callback_form">\n          <bldc-grid-row>\n            <bldc-grid-column col="9">\n              <bldc-heading bold="true" disable-margin="false" color="#000" level=2 size="xl">${this.templateTexts.form.title}\n              </bldc-heading>\n              <bldc-paragraph>${this.templateTexts.form.introText}</bldc-paragraph>\n            </bldc-grid-column>\n          </bldc-grid-row>\n          <bldc-grid-row>\n            <bldc-grid-column>\n                <bldc-grid-row>\n                  <bldc-grid-column col="9" md="12">\n                    <bldc-input\n                            class="bld_callback_phoneNumber"\n                            name="phoneNumber"\n                            input-type="number"\n                            label="${this.templateTexts.form.phoneNumber.label}"\n                            required="false"\n                            validators='["required|phone|${this.templateTexts.form.phoneNumber.validationText}"]'\n                            predefined-input="phone"\n                            explanation-text="${this.templateTexts.form.phoneNumber.explanationText}"\n                    ></bldc-input>\n\n                    <bldc-input\n                            class="bld_callback_lastName"\n                            name="lastName"\n                            predefined-input="name"\n                            label="${this.templateTexts.form.lastName.label}"\n                            input-type="text"\n                            required="false"\n                            validators='["required|text|${this.templateTexts.form.lastName.validationText}"]'\n                            >\n                    </bldc-input>\n                  </bldc-grid-column>\n                </bldc-grid-row>\n\n                <bldc-grid-row style="margin-bottom: 1rem;">\n                  <bldc-grid-column col="5" md="12"  style="margin-bottom: 1rem;">\n                    <bldc-select-box\n                            class="bld_callback_select_day"\n                            name="desiredday"\n                            placeholder="${this.templateTexts.form.selectDay.placeholder}"\n                            data="[[object Object],[object Object]]"\n                            required="true"\n                    >\n                      <span slot="label">${this.templateTexts.form.selectDay.label}</span>\n                    </bldc-select-box>\n                  </bldc-grid-column>\n                  <bldc-grid-column col="4" md="12">\n                    <bldc-select-box\n                            class="bld_callback_select_time"\n                            name="desiredtime"\n                            placeholder="${this.templateTexts.form.selectTime.placeholderInit}"\n                            data="[[object Object],[object Object]]"\n                            required="true"\n                            disabled="true"\n                    >\n                      <span slot="label">${this.templateTexts.form.selectTime.label}</span>\n                    </bldc-select-box> \n                  </bldc-grid-column>\n                </bldc-grid-row>\n\n                <bldc-grid-row>\n                  <bldc-grid-column col="9" md="12"  style="margin-bottom: 1rem;">\n                    <bldc-paragraph>${this.templateTexts.form.avgText}</bldc-paragraph>\n                  </bldc-grid-column>\n                </bldc-grid-row>\n\n                <bldc-grid-row>\n                  <bldc-grid-column>\n                    <div class="bld_callback_btn_container">\n                      <bldc-button\n                              class='bld_callback_btn_submit'\n                              elem-title="${this.templateTexts.form.buttonSend.title}"\n                              icon="verzend"\n                              html-type="button"\n                              type="primary"\n                      ></bldc-button>\n                      <div class="bld_callback_spinner"></div>\n                    </div>\n                  </bldc-grid-column>\n                </bldc-grid-row>\n            </bldc-grid-column>\n          </bldc-grid-row>\n        </bldc-form>\n\n        <div class="bld_callback_confirmation">\n          <span role="img" aria-label="${this.templateTexts.confirmation.srLabelForSuccessIcon}"></span>\n          <bldc-grid-row>\n            <bldc-grid-column col="10">\n              <bldc-heading bold="true" disable-margin="false" color="#000" level=2 size="xl">\n                ${this.templateTexts.confirmation.title}\n              </bldc-heading>\n              <bldc-paragraph style="margin-bottom: 1rem;">${this.templateTexts.confirmation.paragraphTop}</bldc-paragraph>\n            </bldc-grid-column>\n          </bldc-grid-row>\n          <bldc-grid-row>\n            <bldc-grid-column col="10">\n              <ul class="bld_callback_confirmation_list">\n                <li class="bld_callback_confirmation_list-item">\n                    <bldc-icon aria-hidden="false" font-size="20" icon="kalender"\n                        ariaLabel="${this.templateTexts.confirmation.ariaLabelIconCalendar}"></bldc-icon>\n                    <span class="bld_callback_confirmation_dateTime">dag - datum - tijd</span>\n                </li>\n                <li class="bld_callback_confirmation_list-item">\n                    <bldc-icon aria-hidden="false" font-size="20" icon="telefoon"\n                        ariaLabel="${this.templateTexts.confirmation.ariaLabelIconPhone}"></bldc-icon>\n                    <span class="bld_callback_confirmation_phoneNumber">06-99999999</span>\n                </li>\n                <li class="bld_callback_confirmation_list-item">\n                    <bldc-icon aria-hidden="false" font-size="20" icon="label"\n                    ariaLabel="${this.templateTexts.confirmation.ariaLabelIconSubject}"></bldc-icon>\n                <span class="bld_callback_confirmation_subject">ONDERWERP</span>\n                </li>\n              </ul>\n            </bldc-grid-column>\n          </bldc-grid-row>\n          <bldc-grid-row>\n            <bldc-grid-column col="10">\n              <bldc-paragraph style="margin-bottom: 1rem;">${this.templateTexts.confirmation.paragraphBottom}</bldc-paragraph>\n            </bldc-grid-column>\n          </bldc-grid-row>\n        </div>\n\n        <div class="bld_callback_notification">\n          <bldc-grid-row>\n            <bldc-grid-column>\n              <div class="box">\n                <bldc-notification\n                        compact="false"\n                        disable-icon="false"\n                        elem-title="1 probleem"\n                        matomo-event-load="undefined"\n                        matomo-variable-header="undefined"\n                        matomo-variable-type="undefined"\n                        show-animation="undefined"\n                        type="error">\n                  EEN TEKST\n                </bldc-notification>\n              </div>\n            </bldc-grid-column>\n          </bldc-grid-row>\n        </div>\n\n      </bldc-grid>\n\n      <span class="status"></span>\n    </section>\n    `,this.templateCreated=!0,this.template.innerHTML=this.HTMLBold}addAllEventlistenersToElements(){this.shadowRoot.querySelector(".bld_callback-btn-show-form").addEventListener("bldcClick",e=>{e.preventDefault(),this.shadowRoot.querySelector(".bld_callback_head .bld_callback_spinner").style.display="block",this.showForm(),this.metrixCount("click:callback")}),this.shadowRoot.querySelector(".bld_callback_phoneNumber").addEventListener("bldcBlur",e=>{if(null!==e.detail){const t=/^((\+|00(\s|\s?\-\s?)?)31(\s|\s?\-\s?)?(\(0\)[\-\s]?)?|0)[1-9]((\s|\s?\-\s?)?[0-9])((\s|\s?-\s?)?[0-9])((\s|\s?-\s?)?[0-9])\s?[0-9]\s?[0-9]\s?[0-9]\s?[0-9]\s?[0-9]$/g;null!==e.detail.match(t)?(this._data.phoneNumber=e.detail.replace(/[\s|\-]/g,""),this.rejectedNumbers.includes(e.detail)&&this.inlineError(".bld_callback_phoneNumber",this.templateTexts.errors.NUMBER_REJECTED.text)):this.inlineError(".bld_callback_phoneNumber",this.templateTexts.errors.NoDutchPhoneNumber.text)}}),this.shadowRoot.querySelector(".bld_callback_lastName").addEventListener("bldcBlur",e=>{this._data.lastName=e.detail}),this.shadowRoot.querySelector(".bld_callback_btn_submit").addEventListener("bldcClick",e=>{e.preventDefault(),this.submitForm()}),this.shadowRoot.querySelector(".bld_callback_select_day").addEventListener("bldcValueChange",e=>{this._data.chosenAvailableDay=e.detail,this.setAvailableTimesOfChosenDay()}),this.shadowRoot.querySelector(".bld_callback_select_time").addEventListener("bldcValueChange",e=>{this._data.chosenAvailableTime=e.detail})}metrixCount(e){let t="";document.querySelector("body").hasAttribute("data-pagetype")&&document.querySelector("body").getAttribute("data-pagetype").length>0&&(t=document.querySelector("body").getAttribute("data-pagetype"),window._mtm.push({eventData:`[${t}]callback,${e},`}),window._mtm.push({event:"changeCount"}))}async getAvailableTimes(){this._data.availableTimes={};let e=new Date,t=new Date(new Date((new Date).setDate(e.getDate()+7)).setHours(23,59,59,999)),a=`${this.urls.GMSBaseURL.callback}/1/service/callback/${this._data.skillGroup}/availability?start=${e.toISOString()}&number-of-days=7&end=${t.toISOString()}`;await fetch(a).then(e=>{if(!e.ok)throw Error(e.statusText);return e.json()}).then(e=>(this._data.availableTimes=e,this.fetchResponsGenesys=!0)).catch(e=>(this.templateCreated&&this.callbackShowError("noCalenderData"),console.error(e),this.fetchResponsGenesys=!1))}setWeekDays(){this._data.availableDays=[];for(let e=0;e<7;e++){let t=new Date;t.setDate(t.getDate()+e);let a=t.toISOString().slice(0,10);Object.keys(this._data.availableTimes).filter(e=>e.includes(a)).length>0&&this._data.availableDays.push({title:this.getDateInFullText(t),value:t.toISOString()})}return this._data.availableDays.length>0?(this.shadowRoot.querySelector(".bld_callback_select_day").data=this._data.availableDays,!0):(this.callbackShowError("noDaysAvailable"),!1)}getDateInFullText(e=new date){let t=e.toLocaleString("nl-NL",{weekday:"long"});return`${t=t.charAt(0).toUpperCase()+t.slice(1)} ${e.toLocaleString("nl-NL",{day:"numeric"})} ${e.toLocaleString("nl-NL",{month:"long"})} ${e.toLocaleString("nl-NL",{year:"numeric"})}`}getTimeForText(e=new date){return e.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}setAvailableTimesOfChosenDay(){this._data.availableTimesForSelectedDay=[];let e=new Date(this._data.chosenAvailableDay).toISOString().slice(0,10),t=Object.keys(this._data.availableTimes).filter(t=>t.includes(e));for(const e in t)this._data.availableTimesForSelectedDay.push({title:this.getTimeForText(new Date(t[e])),value:t[e]});this._data.availableTimesForSelectedDay.length>0?(this.shadowRoot.querySelector("bldc-select-box.bld_callback_select_time").removeAttribute("disabled"),this.shadowRoot.querySelector("bldc-select-box.bld_callback_select_time").reset(),this.shadowRoot.querySelector(".bld_callback_select_time").data=this._data.availableTimesForSelectedDay):(this.shadowRoot.querySelector("bldc-select-box.bld_callback_select_time").setAttribute("disabled",""),this.callbackShowError("noTimeAvailable")),this.shadowRoot.querySelector(".bld_callback_select_time").placeholder=this.templateTexts.form.selectTime.placeholder}async showForm(){await this.getAvailableTimes(),this.fetchResponsGenesys&&this.setWeekDays()&&(this.shadowRoot.querySelector(".bld_callback_form").style.display="block",this.shadowRoot.querySelector(".bld_callback_head").style.display="none",this.shadowRoot.querySelector(".bld_callback_confirmation").style.display="none")}setDataForbackend(){this._data.dataForBackend={_customer_number:this._data.phoneNumber,lastname:this._data.lastName,SUBJECT:this._data.subject,_desired_time:this._data.chosenAvailableTime}}async triggerValidation(){const e=[];this.errorCountMetrix="";let t=[];this.shadowRoot.querySelectorAll("bldc-input, bldc-select-box").forEach((a,l)=>{(a.hasAttributes("required")&&"true"===a.getAttribute("required")||a.getAttribute("validators")&&a.getAttribute("validators").indexOf("required")>-1)&&e.push(new Promise(async e=>{try{await a.doValidate(),a.valid||t.push(a.name),e(a.valid)}catch(t){e(a.valid)}}))});const a=await Promise.all(e);return t.forEach((e,t)=>this.errorCountMetrix+=(0===t?"foutmelding:":"")+(t>0?"+":"")+e),a.some(e=>!1===e)?(this.metrixCount(this.errorCountMetrix),!1):(this.metrixCount("button:bevestigen"),!0)}setLoadingState(e){this.shadowRoot.querySelector(".bld_callback_form .bld_callback_spinner").style.display=e?"block":"none",this.shadowRoot.querySelectorAll("bldc-input").forEach(t=>t.setAttribute("element-disabled",e)),this.shadowRoot.querySelectorAll("bldc-select-box, bldc-button").forEach(t=>t.setAttribute("disabled",e))}async submitForm(){await this.triggerValidation()&&(this.setLoadingState(!0),this.setDataForbackend(),this._data.skillGroup&&this._data.skillGroup.length>0?fetch(`${this.urls.GMSBaseURL.callback}/1/service/callback/${this._data.skillGroup}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this._data.dataForBackend)}).then(async e=>{let t=await e.json();if(!e.ok){if("NUMBER_REJECTED"===t.phrase){this.setLoadingState(!1),this.inlineError(".bld_callback_phoneNumber",this.templateTexts.errors.NUMBER_REJECTED.text);const e=this.shadowRoot.querySelector(".bld_callback_phoneNumber").bldcValue;-1===this.rejectedNumbers.indexOf(e)&&this.rejectedNumbers.push(e)}else this.callbackShowError([t.phrase]);throw new Error(t.message)}this.shadowRoot.querySelector(".bld_callback_form").style.display="none",this.shadowRoot.querySelector(".bld_callback_confirmation").style.display="block",this.templateTexts.confirmation&&this.templateTexts.confirmation.txtDateAndTime&&this.templateTexts.confirmation.txtDateAndTime.length>0?this.shadowRoot.querySelector(".bld_callback_confirmation_dateTime").innerText=this.templateTexts.confirmation.txtDateAndTime.replace("[DATE]",this.getDateInFullText(new Date(this._data.chosenAvailableDay))).replace("[TIME]",this.getTimeForText(new Date(this._data.chosenAvailableTime))):this.shadowRoot.querySelector(".bld_callback_confirmation_dateTime").innerText=`${this.getDateInFullText(new Date(this._data.chosenAvailableDay))} om ${this.getTimeForText(new Date(this._data.chosenAvailableTime))} uur`,this.shadowRoot.querySelector(".bld_callback_confirmation_phoneNumber").innerText=this._data.phoneNumber,this.shadowRoot.querySelector(".bld_callback_confirmation_subject").innerText=setFirst_Az_toCapital(this._data.subject)}).catch(e=>{console.error(e)}):this.callbackShowError("default"))}inlineError(e,t){this.shadowRoot.querySelector(e).removeAttribute("outer-error-message"),this.shadowRoot.querySelector(e).setAttribute("outer-error-message",t)}callbackShowError(e=""){this.shadowRoot.querySelector(".bld_callback_form").style.display="none",this.shadowRoot.querySelector(".bld_callback_head").style.display="none",this.shadowRoot.querySelector(".bld_callback_confirmation").style.display="none";let t=this.shadowRoot.querySelector(".bld_callback_notification bldc-notification");if(t){let a=this.templateTexts.errors[e];a?(t.elemTitle=a.title,t.innerHTML=a.text):(a=this.templateTexts.errors.default,t.elemTitle=a.title,t.innerHTML=a.text)}this.shadowRoot.querySelector(".bld_callback_notification").style.display="block"}}window.customElements.define("bld-callback-component",BldCallbackComponent);