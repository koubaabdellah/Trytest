// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.41/esri/copyright.txt for details.
//>>built
define("dojo/_base/lang dojo/_base/array dojo/_base/Deferred dojo/sniff dojo/number dojox/data/CsvStore ../kernel ../config ../request ../SpatialReference ../geometry/jsonUtils ../geometry/webMercatorUtils".split(" "),function(u,g,F,S,T,U,Y,G,V,C,H,I){function J(a){var c=0,e="";g.forEach([","," ",";","|","\t"],function(k){var h=a.split(k).length;h>c&&(c=h,e=k)});return e}function K(a,c){if(!a||"[object Date]"!==Object.prototype.toString.call(a)||isNaN(a.getTime()))return!1;a=!0;if(S("chrome")&&/\d+\W*$/.test(c)){if(c.match(/[^0-9a-zA-Z\s]/))return!1;
if(c=c.match(/[a-zA-Z]{2,}/)){a=!1;for(var e=0,k=c.length,h=/^((jan(uary)?)|(feb(ruary)?)|(mar(ch)?)|(apr(il)?)|(may)|(jun(e)?)|(jul(y)?)|(aug(ust)?)|(sep(tember)?)|(oct(ober)?)|(nov(ember)?)|(dec(ember)?)|(am)|(pm)|(gmt)|(utc))$/i;!a&&e<=k&&!(a=!h.test(c[e]));)e++;a=!a}}return a}function L(a,c,e){var k=a.indexOf("\n");k=u.trim(a.substr(0,k));var h=c.columnDelimiter;h||(h=J(k));var l=new U({data:a,separator:h});l.fetch({onComplete:function(p,m){m=0;var b={layerDefinition:c.layerDefinition,featureSet:{features:[],
geometryType:"esriGeometryPoint"}},n=b.layerDefinition.objectIdField,d=b.layerDefinition.fields;n||g.some(d,function(f){return"esriFieldTypeOID"===f.type?(n=f.name,!0):!1})||(d.push({name:"__OBJECTID",alias:"__OBJECTID",type:"esriFieldTypeOID",editable:!1}),n="__OBJECTID");var v=l._attributes,M=[],y=[];g.forEach(d,function(f){"esriFieldTypeDate"===f.type?M.push(f.name):("esriFieldTypeDouble"===f.type||"esriFieldTypeInteger"===f.type)&&y.push(f.name)});if(c.locationInfo&&"coordinates"===c.locationInfo.locationType){var r=
c.locationInfo.latitudeFieldName;var t=c.locationInfo.longitudeFieldName}else g.forEach(v,function(f){var q=g.indexOf(N,f.toLowerCase());-1!==q&&(r=f);q=g.indexOf(O,f.toLowerCase());-1!==q&&(t=f)}),r&&t&&(c.locationInfo={locationType:"coordinates",latitudeFieldName:r,longitudeFieldName:t});if(r&&t){-1===g.indexOf(y,r)&&y.push(r);-1===g.indexOf(y,t)&&y.push(t);if(u.isArray(c.outFields)&&-1===g.indexOf(c.outFields,"*"))var z=c.outFields;g.forEach(v,function(f){g.some(d,function(q){return f===q.name})||
d.push({name:f,alias:f,type:f===r||f===t?"esriFieldTypeDouble":"esriFieldTypeString"})});v=0;var W=p.length;for(v;v<W;v++){var A=p[v],B=l.getAttributes(A),w={};g.forEach(B,function(f){if(f&&(f===r||f===t||!z||-1<g.indexOf(z,f))){var q=f;0===f.length&&g.forEach(d,function(X,P){X.name==="attribute_"+(P-1)&&(f="attribute_"+(P-1))});if(-1<g.indexOf(M,f)){q=l.getValue(A,q);var x=new Date(q);w[f]=K(x,q)?x.getTime():null}else-1<g.indexOf(y,f)?(x=T.parse(l.getValue(A,q)),f!==r&&f!==t||!(isNaN(x)||181<Math.abs(x))||
(x=parseFloat(l.getValue(A,q))),isNaN(x)?w[f]=null:w[f]=x):w[f]=l.getValue(A,q)}});w[n]=m;m++;B=w[r];var D=w[t];null==D||null==B||isNaN(B)||isNaN(D)||(z&&-1===g.indexOf(z,r)&&delete w[r],z&&-1===g.indexOf(z,t)&&delete w[t],b.featureSet.features.push({geometry:{x:D,y:B,spatialReference:{wkid:4326}},attributes:w}))}b.layerDefinition.name="csv";e&&e(b)}else setTimeout(function(){console.error("File does not seem to contain fields with point coordinates.")},1),e&&e(null,Error("File does not seem to contain fields with point coordinates."))},
onError:function(p){console.error("Error fetching items from CSV store: ",p);e&&e(null,p)}});return!0}function E(a,c,e,k,h,l){0===a.length&&h(null);var p=H.getGeometryType(c),m=[];g.forEach(a,function(b){b=new p(b);b.spatialReference=e;m.push(b)},this);c=[102113,102100,3857];e.wkid&&4326===e.wkid&&k.wkid&&-1<g.indexOf(c,k.wkid)?(g.forEach(m,function(b){b.xmin?(b.xmin=Math.max(b.xmin,-180),b.xmax=Math.min(b.xmax,180),b.ymin=Math.max(b.ymin,-89.99),b.ymax=Math.min(b.ymax,89.99)):b.rings?g.forEach(b.rings,
function(n){g.forEach(n,function(d){d[0]=Math.min(Math.max(d[0],-180),180);d[1]=Math.min(Math.max(d[1],-89.99),89.99)},this)},this):b.paths?g.forEach(b.paths,function(n){g.forEach(n,function(d){d[0]=Math.min(Math.max(d[0],-180),180);d[1]=Math.min(Math.max(d[1],-89.99),89.99)},this)},this):b.x&&(b.x=Math.min(Math.max(b.x,-180),180),b.y=Math.min(Math.max(b.y,-89.99),89.99))},this),a=[],g.forEach(m,function(b){b=I.geographicToWebMercator(b);102100!==k.wkid&&(b.spatialReference=k);a.push(b.toJson())},
this),h(a)):null!==e.wkid&&-1<g.indexOf(c,e.wkid)&&null!==k.wkid&&4326===k.wkid?(a=[],g.forEach(m,function(b){a.push(I.webMercatorToGeographic(b).toJson())},this),h(a)):(c=function(b,n){b&&b.length===a.length?(a=[],g.forEach(b,function(d){d&&(d.rings&&0<d.rings.length&&0<d.rings[0].length&&0<d.rings[0][0].length&&!isNaN(d.rings[0][0][0])&&!isNaN(d.rings[0][0][1])||d.paths&&0<d.paths.length&&0<d.paths[0].length&&0<d.paths[0][0].length&&!isNaN(d.paths[0][0][0])&&!isNaN(d.paths[0][0][1])||d.xmin&&!isNaN(d.xmin)&&
d.ymin&&!isNaN(d.ymin)||d.x&&!isNaN(d.x)&&d.y&&!isNaN(d.y))?a.push(d.toJson()):a.push(null)},this),h(a)):l(b,n)},G.defaults.geometryService?G.defaults.geometryService.project(m,k,u.hitch(this,c),l):h(null))}function Q(a,c){var e=[102113,102100,3857];return a&&c&&a.wkid===c.wkid&&a.wkt===c.wkt||a&&c&&a.wkid&&c.wkid&&-1<g.indexOf(e,a.wkid)&&-1<g.indexOf(e,c.wkid)?!0:!1}function R(a,c,e,k){if(a.featureSet&&0!==a.featureSet.features.length)if(Q(e,c))k(a);else{var h=function(b){var n=[];g.forEach(a.featureSet.features,
function(d,v){b[v]&&(d.geometry=b[v],n.push(d))},this);k(a)},l=function(b,n){console.error("error projecting featureSet ("+a.layerDefinition.name+"). Final try.");k(a)},p=function(b,n){console.error("error projecting featureSet ("+a.layerDefinition.name+"). Try one more time.");E(m,a.featureSet.geometryType,c,e,u.hitch(this,h),u.hitch(this,l))};if(a.featureSet.features&&0<a.featureSet.features.length){var m=[];g.forEach(a.featureSet.features,function(b){if(b.geometry.toJson)m.push(b.geometry);else{var n=
H.getGeometryType(a.featureSet.geometryType);m.push(new n(b.geometry))}});c.toJson||(c=new C(c));e.toJson||(e=new C(e));E(m,a.featureSet.geometryType,c,e,u.hitch(this,h),u.hitch(this,p))}else k(a)}}var N="lat latitude y ycenter latitude83 latdecdeg point-y lat_dd".split(" "),O="lon lng long longitude x xcenter longitude83 longdecdeg point-x long_dd".split(" ");return{latFieldStrings:N,longFieldStrings:O,buildCSVFeatureCollection:function(a){var c=new F,e=function(h,l){l?c.errback(l):c.callback(h)},
k={url:a.url,handleAs:"text",load:function(h){L(h,a,u.hitch(this,e))},error:function(h){c.errback(h);console.error("error: "+h)}};-1<a.url.indexOf("arcgis.com")&&-1<a.url.indexOf("/content/items")&&-1<a.url.indexOf("/data")&&(k.headers={"Content-Type":""});V(k,{usePost:!1});return c},projectFeatureCollection:function(a,c,e){var k=new F;e||(e=new C({wkid:4326}));R(a,e,c,u.hitch(this,function(h){k.callback(h)}));return k},generateDefaultPopupInfo:function(a){var c={esriFieldTypeDouble:1,esriFieldTypeSingle:1},
e={esriFieldTypeInteger:1,esriFieldTypeSmallInteger:1},k={esriFieldTypeDate:1},h=null;a=g.map(a.layerDefinition.fields,u.hitch(this,function(l){"NAME"===l.name.toUpperCase()&&(h=l.name);var p="esriFieldTypeOID"!==l.type&&"esriFieldTypeGlobalID"!==l.type&&"esriFieldTypeGeometry"!==l.type,m=null;if(p){var b=l.name.toLowerCase();if(-1<",stretched value,fnode_,tnode_,lpoly_,rpoly_,poly_,subclass,subclass_,rings_ok,rings_nok,".indexOf(","+b+",")||-1<b.indexOf("area")||-1<b.indexOf("length")||-1<b.indexOf("shape")||
-1<b.indexOf("perimeter")||-1<b.indexOf("objectid")||b.indexOf("_")===b.length-1||b.indexOf("_i")===b.length-2&&1<b.length)p=!1;l.type in e?m={places:0,digitSeparator:!0}:l.type in c?m={places:2,digitSeparator:!0}:l.type in k&&(m={dateFormat:"shortDateShortTime"})}return u.mixin({},{fieldName:l.name,label:l.alias,isEditable:!0,tooltip:"",visible:p,format:m,stringFieldOption:"textbox"})}));return{title:h?"{"+h+"}":"",fieldInfos:a,description:null,showAttachments:!1,mediaInfos:[]}},_getSeparator:J,
_isValidDate:K,_processCsvData:L,_projectGeometries:E,_sameSpatialReference:Q,_projectFeatureSet:R}});