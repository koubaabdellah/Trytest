define("js2/customSelect",["jquery","js2/Toggler"],(function(e,t){var n=function(t,n){var o=n||{};this.node=t,e.extend(this,{options:{},exclude:{},onInit:function(){},onChange:function(){},onToggle:function(){}},o),this.init()};return n.prototype={refresh:function(){var e=this;e.$node.hasClass("customized")&&(e.value_old=null,e.$ul.empty(),e.getOptions().createList(),e.$node.addClass("customized"))},init:function(){var n=this;if(n.$node=e(n.node),n.$select=e("select",n.$node).hide(),n.$select.length&&!n.$node.hasClass("customized"))return n.$ul=e("<ul/>").hide(),n.getOptions().createList().createButton(),n.$node.append(n.$button),n.$node.append(n.$ul),n.toggler=new t(n.$button,n.$ul,(function(e){n.$ul.css({overflow:"auto"}),n.$ul.addClass("z-scrollbar")}),{exclude:n.exclude}),n.toggler.on("toggle",(function(e){n.$button[e?"addClass":"removeClass"]("active dropped"),n.onToggle.call(n,n.getValue(),e)})),n.$ul.on("click","li",(function(t){var o=e(this),i=o.data("key");o.hasClass("selected")||(n.options[i].href||t.preventDefault(),n.$select.val(i).trigger("change"),n.toggler.setVisible(!1))})),n.$select.on("change",(function(t,o){if(n.value_old!=this.value){n.value_old=this.value;var i=n.getValue(),a=n.getIndex();e("li",n.$ul).removeClass("selected").eq(a).addClass("selected"),n.$current.text(n.options[i].title),o||n.onChange.call(n,i,a)}})),n.$node.addClass("customized"),n.onInit.call(n,n.getValue()),n},getOptions:function(){var t=this;return t.options={},e("option",t.$select).each((function(n){t.options[this.value]={key:this.value,value:e(this).text(),descr:e(this).data("descr"),title:e(this).data("title")||e(this).text(),href:!!this.value.match(/^(http|https|ftp|ftps|#)+/),selected:!!e(this).attr("selected"),visible:void 0===e(this).data("visible")||!!e(this).data("visible")}})),t},getValue:function(){var t=this.$select.val();return null==t&&(t=e("option",this.$select).eq(0).val()),t},setValue:function(t,n){var o=this;o.$select.val(t),o.getValue()||e("option",o.$select).eq(0).attr("selected","selected"),o.$select.trigger("change",[n])},getIndex:function(){var t=this;return e("option",t.$select).filter((function(){return this.value==t.getValue()})).index()},getTitle:function(){return this.$select.find("option").eq(this.getIndex()).text()},createList:function(){var t=this;for(var n in t.options){var o=[];t.options[n].selected&&o.push("selected"),t.options[n].visible||o.push("hidden");var i=e("<li/>",{"data-key":t.options[n].key,class:o.join(" ")});t.options[n].href?i.append(e("<a />",{href:t.options[n].key,text:t.options[n].value})):i.text(t.options[n].value),t.options[n].descr&&i.prepend(e('<div class="descr"></div>').text(t.options[n].descr)),t.$ul.append(i)}return t},createButton:function(){var t=this;return t.$button=e(".button",t.$node),t.$current=e(".button .current",t.$node),t.$current.length||(t.$current=e("<span/>",{class:"current",text:t.options[t.getValue()].value})),t.$button.length||(t.$button=e("<span/>",{class:"button button-silver"})),t.$button.append(t.$current),t}},n})),define("js2/Resize",["jquery"],(function(e){var t="multicut";return{serviceItems:function(n,o){n=n instanceof e?n:e(n||".service-item"),(o=e.extend({max:1,root:null,wrap:null,text:".H3",more:null,longCls:"service-long-title service-title-{l}rows"},o)).more&&n.off("click."+t,o.more).on("click."+t,o.more,(function(t){t.preventDefault();var n=e(this),o=n.data("$wrap"),i=o.data("oldStyle");n.addClass("hidden"),o.css(i||{maxHeight:"",overflow:""})})),n.find(o.text).each((function(){var t=e(this),i=o.wrap?t.closest(o.wrap,n):t.parent(),a=i.closest(o.root||n,n),s=t.height(),r=parseFloat(t.css("line-height")),l=Math.ceil(s/r),c=o.more?a.find(o.more):null;if(c&&!c.length&&(c=null),c&&c.data({$target:t,$wrap:i,$root:a}),o.longCls)return l>o.max&&a.addClass(o.longCls.replace("{l}",""+l)),void(c&&c.removeClass("hide"));l>o.max+(c?1:0)&&(i.css({maxHeight:o.max*r,overflow:"hidden"}),c&&c.removeClass("hide"))}))}}})),define("js2/ResultsLoader",["jquery"],(function(e){var t=null;function n(){if(null!==t)throw new Error("USE ResultsLoader.getInstance()")}return n.prototype={timeoutId:{},handlers:{},load:function(t,n,o,i){var a=this,s=n+e.param(o);a.handlers.hasOwnProperty(s)||(a.handlers[s]={url:n,query:o,list:[]}),a.handlers[s].list.push({type:t,callback:i}),a.timeoutId.hasOwnProperty(s)||(a.timeoutId[s]=setTimeout((function(){a.process(s)})))},process:function(t){var n=this,o=this.handlers[t],i=o.list.map((function(e){return e.type})).filter((function(e,t,n){return n.indexOf(e)===t})),a=e.extend({need:i},o.query);e.post(o.url,a,(function(e){o.list.forEach((function(t){t.callback(e)})),delete n.timeoutId[t],delete n.handlers[t]}))}},n.getInstance=function(){return null===t&&(t=new n),t},n.getInstance()})),define("js2/CatalogPhotoSlider",["jquery","lib/sly"],(function(e,t){return function(n){e(n).on("mouseenter",".js-minicard-photo",(function(){var n=e(this),o=n.find(".js-slider-block"),i=o.data("photos"),a=document.createElement("ul");if(i&&i.length&&!o.hasClass("inited")){o.addClass("inited");var s={horizontal:!0,itemNav:"basic",smart:!0,activateMiddle:!1,mouseDragging:!0,touchDragging:!0,releaseSwing:!0,startAt:0,scrollBy:0,speed:500,swingSpeed:.3,elasticBounds:!0,slidebyone:!0,prev:e(".js-slider-prev",n),next:e(".js-slider-next",n)};i.forEach((function(e,t){if(0!==t){var n=document.createElement("li"),o=`<img\n\t\t\t\t\tsrc="${e}"\n\t\t\t\t\twidth="252"\n\t\t\t\t\theight="168"\n\t\t\t\t\tclass="pull-left"\n\t\t\t\t\tonerror="this.src='/images/photo_180_noborder.png'"\n\t\t\t\t\tstyle="object-fit: cover"\n\t\t\t\t/>`;n.innerHTML=o,a.appendChild(n)}})),o.find("ul").append(a.innerHTML),new t(o,s).init()}}))}})),define("js2/Progressbar",["jquery"],(function(e){return function(t){var n=this;n.loader=e(t);var o=!1,i=function(){o=!1};n.loadStart=function(){n.loader.length&&(o||(o=!0,n.loader.removeClass("full-load"),setTimeout((function(){n.loader.addClass("half-load")}),25)))},n.loadFinish=function(){n.loader.length&&(n.loader.addClass("full-load"),n.loader.removeClass("half-load"),i())},n.isLoading=function(){return o}}})),define("js2/Favorite",["js2/env"],(function(e){const t="active",n="favoriteOrgs";return{clientStorageList:null,isClientStorage:function(t){return e.is_phone&&!t},toggle:function(e,n){const o=!e.classList.contains(t),i=e.dataset.id,a=e.dataset.object_id,s=this;(n?this.toggleInClientStorage(i,o):this.toggleInServerStorage(i,o)).then((function(t){s.toggleActiveClass(e,t),n&&window.za({ev_action:"click",object_type:"organization",object_id:a,ev_category:"favorites",ev_label:t?"on":"off"})})).catch((function(e){e.alertError&&alert(e.message)}))},toggleInServerStorage:function(e,t){const n=new URLSearchParams;return n.append("area","service"),n.append("action","favorite"),n.append("id",e),n.append("value",t?"1":"0"),fetch("/js.php",{method:"POST",body:n}).then((function(e){return e.json()})).then((function(e){if(e.success)return Promise.resolve(e.value)}))},toggleInClientStorage:function(e,t){const o=this.getListFromClientStorage(),i=o.indexOf(e);if(t){if(-1===i){if(o.length>=100)return Promise.reject({alertError:!0,message:window.i18n.t("service.favorites_reached_limit")});o.push(e)}}else-1!==i&&o.splice(i,1);return localStorage.setItem(n,JSON.stringify(o)),this.clientStorageList=o,Promise.resolve(t)},getListFromClientStorage:function(){return null===this.clientStorageList&&(this.clientStorageList=JSON.parse(localStorage.getItem(n))||[]),this.clientStorageList},flushListFromClientStorage:function(){this.clientStorageList=null},toggleActiveClass:function(e,n){n?e.classList.add(t):e.classList.remove(t)},containsInClientStorage:function(e){return-1!==this.getListFromClientStorage().indexOf(e)}}})),define("js2/ResultsList",["jquery","js2/Observable","js2/LinksMaker","js2/StatService","js2/Resize","js2/ResultsLoader","js2/CatalogPhotoSlider","./Progressbar","./env","js2/jquery.balloon","js2/Favorite"],(function(e,t,n,o,i,a,s,r,l,c,u){var d=function(t,n){var o=n?JSON.parse(JSON.stringify(n)):{},i={type:"service",url:"",format:"html",is_locked:!1,needScroll:!0,highlight:!0,infinite_scroll:0,selector:{anchor:".js-results-anchor",container:".js-results-container",item:".js-results-item"},path:window.location.pathname,is_redirect:!1,query:{},stat:{action_type:"catalog",object_type:"organization"}};e.extend(this,i,o),this.node=t,this.$node=e(t),this.type=this.$node.data("type")||this.type,this.initObservable(),this.init()};return d.prototype={init:function(){var t=this;t.$list=e(t.selector.container,t.$node),t.$node.data("url_list")&&(t.url=t.$node.data("url_list")),t.progressbar=new r("#progressbarCatalog"),t.$list.on("mouseenter mouseleave",t.selector.item,(function(n){var o=e(this).data("id"),i="mouseenter"==n.type;t.highlight&&(t.highlightItem(o,i),t.trigger("highlight",o,i))})),t.$node.on("click",".js-next-page",(function(e){e.preventDefault(),t.nextPage()})),t.infinite_scroll>0&&t.nextPageOnScroll(),t.$list.on("click",".js-favorite",(function(e){e.preventDefault(),t.is_authorized||l.is_phone?u.toggle(this,t.isClientStorageFavorite()):create_layer("auth",{title:window.i18n.t("service.sign_in_add_favorites"),sourceType:"favorites"})})),t.$list.on("click",".js-tour3d",(function(n){n.preventDefault(),create_layer("tour3d",{width:e(window).width(),offset:10,parameters:{org_id:t.getOrgId(this)}})})),t.$list.on("click",t.selector.item+" .js-pricelist-item",(function(n){n.preventDefault();var o=e(this),i=o.closest(t.selector.item).data("id"),a=o.data("id");create_layer("priceitem",{parameters:{owner_type:"organization",owner_id:i,item_id:a}})})),t.initVerifyBalloon(),t._updateResults(),new n(t.$list[0]),l.is_phone||new s(t.$list),t.is_redirect&&t.getList().on("mousedown mouseup",".js-item-url",(function(n){var o=e(this).data("original_url"),i=this,a=e(i).closest(t.selector.item);o||(o=i.href,e(i).data("original_url",o));var s=parseInt(a.index())+1;switch(n.type){case"mousedown":i.href="/service/redirectstat/?url="+o+"&object_pos="+s;break;case"mouseup":setTimeout((function(){i.href=o}),0);var r=a.find(".photo").data("id");r||(r=a.data("object_id"));var l={ev_category:t.stat.action_type+"_click",object_type:t.stat.object_type,object_id:r,object_pos:s};window.za&&za(l)}})),t.getList().on("click",".js-item-url, .js-results-item-url",(function(n){var o=e(this).closest(t.selector.item),i=e.trim(o.find(".service-action__service-special").text());let a=o.data("ev_label");var s={ev_type:"event",ev_category:"organization",ev_action:"click",ev_label:a,ev_sourceType:"mini_card",ev_sourceId:o.data("id"),object_type:o.data("object_type")||"organization",object_id:o.data("object_id"),object_pos:parseInt(o.index())+1};let r=o.data("ev_query_id");void 0!==r&&(s.ev_query_id=r);let l=o.data("ev_search_result");void 0!==l&&(s.ev_search_result=l);let c=o.data("ev_result_index");void 0!==c&&(s.ev_result_index=c),i.length&&(s.ev_extra={service_name:i});var u=o.data("za");u&&e.extend(s,u.data),!window.za||"service"!==t.type&&"search_result"!==a||window.za(s)})),t.getList().on("click",".js-linksmake",(function(n){var o=e(this).closest(t.selector.item),i={ev_type:"event",ev_category:"comments",ev_action:"click",ev_label:o.data("ev_label"),ev_sourceType:"mini_card",ev_sourceId:o.data("id"),object_type:"organization",object_id:o.data("object_id")};const a=o.data("ev_query_id");a&&(i.ev_query_id=a);const s=o.data("ev_search_result");s&&(i.ev_search_result=s);const r=o.data("ev_result_index");r&&(i.ev_result_index=r),window.za&&window.za(i)})),t.getList().on("click",".js-show-more-prices",(function(n){n.stopPropagation();var o=e(this).closest(t.selector.item);window.za({ev_action:"click",ev_category:"organization",object_type:"organization",object_id:o.data("object_id"),ev_sourceType:"mini_card",ev_sourceId:o.data("id"),ev_label:"price",object_pos:parseInt(o.index())+1})})),t.isClientStorageFavorite()&&(t.highlightClientStorageFavorite(),window.addEventListener("message",(function(e){"closeOrgModal"===e.data[0]&&(u.flushListFromClientStorage(),t.highlightClientStorageFavorite())})))},initSliders:function(){if(l.is_phone){var t=this.getList().find(".js-slider-block"),n={horizontal:!0,itemNav:"basic",smart:!0,activateMiddle:!1,mouseDragging:!1,touchDragging:!0,releaseSwing:!0,startAt:0,scrollBy:0,speed:800,swingSpeed:.1,elasticBounds:!0,slidebyone:!0};t.each((function(){var t=e(this),o=e(this).find(".js-slider-item"),i=e(this).closest(".js-results-item").data("object_id");o.length<2||requirejs(["lib/sly"],(function(e){var o=new e(t,n);o.init(),t.removeClass("js-slider-block");var a=t.closest(".js-results-item").find(".js-minicard-sticker"),s=0;o.on("moveEnd",(function(){0!==a.length&&a.toggleClass("hidden",o.rel.activePage>0),s!==o.rel.activePage&&(s=o.rel.activePage,window.za({ev_category:"catalog",ev_action:"photo",object_type:"organization",object_id:i}))}))}))}))}},blurImages:function(){var e=this;requirejs(["lib/blurhash"],(function(t){var n=e.node.querySelectorAll(".js-minicard-photo"),o=30,i=20,a=new IntersectionObserver((function(e){e.forEach((function(e){let n=e.target.classList.contains("loaded");e.intersectionRatio>0&&!n?function(e){var n=document.createElement("canvas"),a=n.getContext("2d");n.width=o,n.height=i,n.classList.add("blur");var s=e.dataset.blur;if(!s)return;var r=t.decode(s,o,i),l=new ImageData(r,o,i);a.putImageData(l,0,0),e.removeAttribute("data-blur"),e.appendChild(n),e.classList.add("loaded")}(e.target):e.intersectionRatio<=0&&n&&(e.target.querySelector("canvas").remove(),e.target.classList.remove("loaded"),a.unobserve(e.target))}))}),{rootMargin:"600px"});n.forEach((function(e){a.observe(e)}))}))},setQuery:function(e){var t=this,n=t.query.onpage?t.query.onpage:null;t.query={},Object.assign(t.query,e,{page:1}),n&&!t.query.onpage&&(t.query.onpage=n)},_getQuery:function(){return this.query},highlightItem:function(e,t){var n=this,o=n.$list.find(n.selector.item+'[data-id="'+e+'"]');o&&o.length||(o=n.$list.find(n.selector.item+'[org-id="'+e+'"]')),o[t?"addClass":"removeClass"]("highlight")},initVerifyBalloon:function(){var e=document.querySelector(this.selector.container);function t(){Array.prototype.slice.call(e.querySelectorAll(".js-verify-icon")).forEach((function(e){var t=c.create("verify",{target:e,offset:4});e.addEventListener("mouseenter",(function(){t.show()})),e.addEventListener("mouseleave",(function(){t.close()}))}))}t(),new MutationObserver((function(e){"childList"===e[0].type&&t()})).observe(e,{attributes:!0,childList:!0,characterData:!0})},setLocked:function(e){var t=e||!1;this.is_locked=t,this.trigger("change.lock",t),t||this._updateResultsImages()},scrollToResults:function(t,n){var o=this;if(!o.is_locked&&!l.is_phone){t=void 0===t?"up":t,n=void 0===n;var i=e(window).scrollTop(),a=o.$node.find(o.selector.anchor);a.length||(a=o.$node);var s=o.$node.find(".js-filter-top").outerHeight()||e(".header-wrapper").outerHeight()||0,r=a.offset().top-s;o.needScroll&&("up"===t&&i>r||"down"===t&&i<r)&&(n?e("html, body").animate({scrollTop:r}):e("html, body").scrollTop(r)),o.needScroll=!0}},updateResultsCount:function(e){this.$node.find(".js-place-count").text(e)},_updateResultsImages:function(){var t=this;this.blurImages(),lazyload(t.$list[0],{effect:"fadeIn",appear:function(){if(!t.stat.action_type||!t.stat.object_type)return;var n=e(this),o=n.data("id");if(!o)return;var i=n.closest(t.selector.item),a=i.find("a:not(.js-phone-number)"),s=n.data("banner"),r=n.closest(".js-results-item-url").data("url"),l={ev_type:"stat",ev_category:t.stat.action_type,ev_label:i.data("ev_label"),object_type:n.data("type")||t.stat.object_type,object_id:o,object_pos:parseInt(i.index())+1};let c=i.data("ev_query_id");void 0!==c&&(l.ev_query_id=c);let u=i.data("ev_search_result");void 0!==u&&(l.ev_search_result=u);let d=i.data("ev_result_index");void 0!==d&&(l.ev_result_index=d);var p=e.trim(i.find(".service-action__service-special").text());p.length&&(l.ev_extra={service_name:p}),s&&(r&&e.post(r,(function(t){t.success&&a.each((function(){var n=e(this).attr("data-tail");e(this).attr("href",t.click_url+(n?"&tail="+encodeURIComponent(n):""))}))}),"json"),l.ev_label="banner"),window.za(l)}})},_updateResults:function(t){var n=this;return n.is_locked||n._updateResultsImages(),n.initSliders(),n._updateResize(t),e(window).off("resize.resizeItems").on("resize.resizeItems",(function(e){n._updateResize(t)})),n},_updateResize:function(e){i.serviceItems(e)},load:function(){var t=this,o=t._getQuery(),i=e.Deferred();t.getPagingBlock().find(".js-next-page").hide(),t.progressbar.loadStart(),t.getLoadingBox().show();var s=t.node.querySelector(".js-filters-reset");return s&&s.classList.add("z-button--loading"),a.load("items",t.url,o,(function(a){var r="json"===t.format?a.html:a,l=e("<div>"+r+"</div>"),c=l.find(t.selector.item+", .js-results-slot");new n(l[0]),l.find(".js-paging-block").length?t.getPagingBlock().replaceWith(l.find(".js-paging-block")).show():t.getPagingBlock().hide(),1==o.page?t.$list.html(c):t.$list.append(c),t._updateResults(c),t.isClientStorageFavorite()&&t.highlightClientStorageFavorite(),t.progressbar.isLoading()&&t.progressbar.loadFinish(),s&&s.classList.remove("z-button--loading"),t.trigger("loaded",r,o,c),window.dispatchEvent(new Event("height")),i.resolve()})),t.trigger("content.update",o),i},nextPage:function(){this.query.page||this.trigger("query.refresh"),this.query.page&&(this.query.page++,this.load())},nextPageOnScroll:function(){var t=this;window.addEventListener("scroll",(function(){var n=t.$node.find(".js-next-page");if(n.length&&!((t.query.page||0)>t.infinite_scroll)){var o=e(window).scrollTop(),i=n.offset().top;o>i-e(window).height()&&i>0&&t.nextPage()}}),{passive:!0})},getList:function(){return this.$list},getItems:function(){return this.$list.find(this.selector.item)},getLoadingBox:function(){return this.$node.find(".js-loading-box")},getPagingBlock:function(){return this.$node.find(".js-paging-block")},getOrgId:function(t){return e(t).closest(this.selector.item).data("id")},isClientStorageFavorite:function(){return u.isClientStorage(this.is_authorized)},highlightClientStorageFavorite:function(){const e=document.querySelector(this.selector.container).querySelectorAll(this.selector.item+" .js-favorite");0!==e.length&&Array.prototype.forEach.call(e,(function(e){const t=e.getAttribute("data-id");u.toggleActiveClass(e,u.containsInClientStorage(t))}))}},Object.assign(d.prototype,t.prototype),d})),define("js2/zSlider",["jquery"],(function(e){var t=function(t,n){var o=n||{};e.extend(this,{range:[1,5],step:1,zIndex:5,pos:[0,0],fixValue:0},o),this.node=t,this.init()};return t.prototype={init:function(){var t=this;t.$node=e(t.node),t.$zone=e(".zone.active",t.$node),t.$controls=e(".slider-control",t.$node),t.$inputs=e("input[type=text]",t.$node),t.$inputs.on("keyup.slider change.slider",(function(e){t.updateControl(t.$inputs.index(this))})).on("blur.slider",(function(e){var n=t.$inputs.index(this);t.updateInput(n),t.updateControl(n)})),t.$inputs.each((function(n){e(this).attr("placeholder",t.range[n])})),t.$controls.on("mousedown.slider",(function(e){t.moving(this)})),t.fixValue=Math.ceil(Math.log(t.step)/Math.log(.1)),t.fixValue<0&&(t.fixValue=0),t.update()},moving:function(t){var n=this,o=n.$controls.index(t);e("body").addClass("noSelect"),e(window).on("mouseup.slider",(function(t){e("body").removeClass("noSelect"),e(window).off("mouseup.slider mousemove.slider"),n.updateControl(o),n.updateInput(o)})),e(window).on("mousemove.slider",(function(e){n.updateSlider(e.pageX-n.offsetLeft,o),n.updateInput(o)}))},getPos:function(e){return this.pos[e]},getValueByPos:function(e){var t=this;return(Math.ceil(t.vpp*e/t.step)*t.step+t.range[0]).toFixed(t.fixValue)},getPosByValue:function(e){return(e-this.range[0])/this.vpp},updateSlider:function(e,t){var n=this,o=e-n.$controls.eq(t).width()/2,i=n.getPos(t?0:1);o<0?o=0:o>n.width&&(o=n.width),(!t&&o>i||t&&o<i)&&(o=i),t?n.$zone.css({right:n.width-o}):n.$zone.css({left:o}),n.$controls.css("z-index",n.zIndex).eq(t).css({left:o,"z-index":n.zIndex+1}),n.pos[t]=o},updateInput:function(e){var t=this,n=t.getValueByPos(t.getPos(e))||"";t.$inputs.eq(e).val(t.range[e]==n?"":n)},updateControl:function(e){var t=this,n=t.$inputs.eq(e).val()||t.range[e],o=t.getPosByValue(n)+t.$controls.eq(e).width()/2;t.updateSlider(o,e)},update:function(){var t=this;t.width=t.$node.hasClass("zSlider")?t.$node.width():e(".zSlider",t.$node).width(),t.offsetLeft=t.$node.offset().left,t.vpp=(t.range[1]-t.range[0])/t.width,t.$controls.each((function(e){t.updateControl(e?0:1)}))}},t})),define("js2/Balloon",["jquery","js2/Observable"],(function(e,t){var n=e(window),o=e(document.body),i=void 0,a=function(t,a){a=Object.assign({ns:"balloon-"+Math.floor(1e7*Math.random()),arrow:{width:20,height:14},padding:10},a);var s=this,r=a.ns,l={balloon:{},arrow:{}},c={left:0,top:0,right:0,bottom:0},u=!1;this.initObservable(),t instanceof e||(t=e(t));var d,p,h,f,g=t.find(".js-balloon-arrow");l.arrow.width=a.arrow.width,l.arrow.height=a.arrow.height,s.show=(p={top:"bottom",bottom:"top",left:"right",right:"left"},h=function(n){if(u){n instanceof e||(n=e(n)),l.balloon.width=t.width(),l.balloon.height=t.height();var o={};o.offset=n.offset(),o.size={},o.size.width=n.width(),o.size.height=n.height(),o.center={},o.center.top=o.offset.top+o.size.height/2,o.center.left=o.offset.left+o.size.width/2;var i={};i.left=Math.max(c.left+a.padding,o.center.left-l.balloon.width+l.arrow.width/2),i.right=Math.min(c.right-a.padding,o.center.left+l.balloon.width-l.arrow.width/2),i.top=Math.max(c.top+a.padding,o.center.top-l.balloon.height+l.arrow.width/2),i.bottom=Math.min(c.bottom-a.padding,o.center.top+l.balloon.height-l.arrow.width/2);var s,r,d,h,f,v,m,y=!1;l.balloon.width<=i.right-i.left&&(r=o.center.left-l.balloon.width/2,i.left>r?r=i.left:i.right<r+l.balloon.width&&(r=i.right-l.balloon.width),c.top<=o.offset.top-l.balloon.height-l.arrow.height?(s="top",d=o.offset.top-l.balloon.height-l.arrow.height,y=!0):c.bottom>=o.offset.top+o.size.height+l.arrow.height+l.balloon.height?(s="bottom",d=o.offset.top+o.size.height+l.arrow.height,y=!0):(s="bottom",d=o.offset.top+o.size.height+l.arrow.height),v=r,m=d),!y&&l.balloon.height<=i.bottom-i.top&&(f=o.center.top-l.balloon.height/2,i.top>f?f=i.top:i.bottom<f+l.balloon.height&&(f=i.bottom-l.balloon.height),c.left<=o.offset.left-l.balloon.width-l.arrow.height?(s="left",h=o.offset.left-l.balloon.width-l.arrow.height,y=!0):c.right>=o.offset.left+o.size.width+l.arrow.height+l.balloon.width&&(s="right",h=o.offset.left+o.size.width+l.arrow.height,y=!0),y&&(v=h,m=f)),v||m||(s="bottom",v=o.center.left-l.balloon.width/2,m=o.offset.top+o.size.height+l.arrow.height),g.removeClass(["left","right","top","bottom"].map((function(e){return"s-icons-balloon-arrow-"+e})).join(" ")).addClass("s-icons-balloon-arrow-"+(p[s]||"top")),"left"===s||"right"===s?g.css({top:0,left:"",marginTop:o.center.top-m-l.arrow.width/2,marginLeft:""}):g.css({left:0,top:"",marginLeft:o.center.left-v-l.arrow.width/2,marginTop:""}),t.css({left:v,top:m}).removeClass("get-out")}},n.on(["resize."+r+"-dim","scroll."+r+"-dim"].join(" "),function e(){return c.left=n.scrollLeft(),c.top=n.scrollTop(),c.right=c.left+n.width(),c.bottom=c.top+n.height(),e}()),function(e){u=!0;var i=throttle(h.bind(null,e),1e3/60,{leading:!1});clearTimeout(d),"function"==typeof s.onBeforeShow&&s.onBeforeShow.call(s),s.trigger("beforeShow"),t.on("mousedown."+r,(function(e){e.stopPropagation()})),o.on("mousedown."+r,s.hide),n.on("resize."+r,i),s.on("resize",i),i(),"function"==typeof s.onShow&&s.onShow.call(s),s.trigger("show")}),s.hide=(f=function(){u=!1,"function"==typeof s.onBeforeHide&&s.onBeforeHide.call(s),s.trigger("beforeHide"),t.addClass("get-out"),t.off("mousedown."+r),o.off("mousedown."+r),n.off("resize."+r),s.off("resize"),"function"==typeof s.onHide&&s.onHide.call(s),s.trigger("hide")},function(e){return e===i&&(e=-1),e<0?f():d=setTimeout(f,e)}),t.css({display:""}).addClass("get-out")};return a.prototype.onBeforeShow=a.prototype.onShow=a.prototype.onBeforeHide=a.prototype.onHide=i,Object.assign(a.prototype,t.prototype),a})),define("js2/HintBalloon",["jquery","js2/Balloon"],(function(e,t){var n=function(t,n){var o=n||{};e.extend(this,{url:"/js.php",selector:null,visible:!1,content:""},o),this.node=t,this.init()};return n.prototype={init:function(){var n=this;n.$node=e(n.node),n.$selector=e(n.selector),n.$content=e(".balloon-content",n.$node),n.balloon=new t(n.$node),n.balloon.on("beforeShow",(function(){n.$selector.addClass("hover")})),n.balloon.on("hide",(function(){n.$selector.removeClass("hover")}))},show:function(){var e=this;e.setContent(),e.balloon.show(e.$selector),e.visible=!0},hide:function(){this.balloon.hide(),this.visible=!1},setContent:function(e){this.$content.html(e||this.content)},getContent:function(t){var n=this;n.content?t&&t.call(n):e.get(n.url,n.data,(function(e){n.content=e,t&&t.call(n)}))}},n})),define("js2/FilterTags",["jquery","js2/Observable"],(function(e,t){var n,o=function(){this.initObservable(),this.init()};return Object.assign(o.prototype,{init:function(t){var n=this;e(".js-filter-tags",t).on("click",".filter-item-tag .button-filter .close",(function(t){t.stopPropagation();var o=e(this).closest(".filter-item-tag"),i=o.attr("data-key"),a=o.text();e(window).trigger("track-event",["filter","cancel",a[0].toUpperCase()+a.slice(1)]),n.remove(i)}))},add:function(e){var t=this;Array.isArray(e)||(e=[e]),e.forEach((function(e){var n=JSON.stringify(e.kvs);t.items.hasOwnProperty(n)||(t.items[n]=e,t.itemsKeys.push(n),t.trigger("add",e))})),t.update()},remove:function(e){var t=this;if(t.items.hasOwnProperty(e)){var n=Object.assign({},t.items[e]);delete t.items[e],t.removeKey(e),t.trigger("remove",n),t.update()}},removeKey:function(e){var t=this,n=(t.itemsKeys||[]).map((function(e){return e}));t.itemsKeys.forEach((function(t,o){t===e&&n.splice(o,1)})),t.itemsKeys=n},removeType:function(e){var t=this;for(var n in t.items)t.items[n].type===e&&t.remove(n);return t},reset:function(){var e=this;for(var t in e.items)e.trigger("remove",e.items[t]);this.items={},this.itemsKeys=[],this.update()},update:function(){var e=this,t="",n=e.getQuery(),o=e.itemsKeys.length;if(JSON.stringify(e.query)!==JSON.stringify(n)){for(e.query=n;o--;){var i=e.itemsKeys[o],a=e.items[i];a.hidden||(t+=e.buildTemplate({key:i,title:a.title}))}e.getList().find(".filter-item-tag").remove(),e.getList().prepend(t),e.trigger("update")}},format:function(e,t,n,o,i){return{title:e,kvs:[{key:t,value:n}],type:o||"other",hidden:i}},getKey:function(e,t){return JSON.stringify([{key:e,value:t}])},setQuery:function(e){this.query=e},getQuery:function(e){var t={},n=e||this.items;for(var o in n)n[o].kvs.forEach((function(e){if(-1!==e.key.lastIndexOf("[]",e.key.length-2)){var n=e.key.replace("[]","");t[n]||(t[n]=[]),t[n].push(e.value)}else t[e.key]=e.value}));return t},getItems:function(){return this.items},getItemsByKey:function(e){var t=this,n=[];for(var o in t.items)t.items[o].kvs.forEach((function(i){i.key===e&&n.push(t.items[o])}));return n},getItemsByType:function(e){var t=this,n=[];for(var o in t.items)t.items[o].type==e&&n.push(t.items[o]);return n},getTagKey:function(e){return JSON.stringify(e.kvs)},removeItemsByKey:function(e){var t=this,n=0;for(var o in t.items)t.items[o].kvs.forEach((function(i){i.key===e&&(delete t.items[o],t.removeKey(o),n++)}));return n},hasItems:function(){return this.itemsKeys.length},getList:function(){return e(".js-filter-tags .filter-items-container")},buildTemplate:function(e){return'<li class="filter-item filter-item-tag" data-key="'+esc(e.key)+'"><span class="button button-filter button-filter-large selected"><span class="close pull-right"><span class="filter-cross"><span class="filter-cross-icon"></span></span></span><span class="title">'+esc(e.title)+"</span></span></li>"},active:!1,category:null,type:null,count:0,query:{},items:{},itemsKeys:[]},t.prototype),n||(n=new o),n})),define("js2/FilterNew",["jquery","js2/Observable","js2/customSelect","js2/zSlider","js2/HintBalloon","js2/FilterTags","js2/Toggler","js2/env"],(function(e,t,n,o,i,a,s,r){function l(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e}function c(e,t){switch(t){case"toggle":return new m(e);case"toggle-dynamic":return new m(e,{dynamic:!0});case"search":return new y(e);case"checkbox":return new b(e);case"checkboxes":return new w(e);case"slider":return new k(e);case"select":return new $(e);case"layer":return new _(e);case"controls":return new j(e);case"aggregate":return new T(e);case"controls-multi":return new C(e);case"tags":return new O(e);case"tags-simple":return new x(e);case"tags-multi":return new z(e);case"tags-select":return new B(e);case"tags-layer":return new P(e);case"tags-shortcut":return new q(e);case"tags-geolocation":return new S(e);case"tags-sort":return new I(e);default:return new v(e)}}var u={},d={popupInit:function(){var t=this;t.balloon=null,t.$button.on("click.filter",(function(n){e(n.target).closest(t.$close).length||(t.popupVisible?(t.popupHide(),t.trigger("balloon",null)):(t.popupShow(),t.trigger("balloon",t)))}))},popupShow:function(){var t=this,n=t.$node.data("layer");t.popupVisible=!0,requirejs(["js2/LayerSelect"],(function(o){var i={city:t.city,LayerSelect:o};Object.assign(i,t.$node.data("params")||{}),create_layer(n,{popstate:r.is_phone,parameters:i,beforeShow:function(e){t.balloon=e,e.on("afterInitSelect",(function(){if("custom_filter"==t.layer&&e.addToSelected(t.query[t.field]||[]),"malls"==t.layer){var n=[];u.hasOwnProperty(t.field)||(u[t.field]={}),(t.query[t.field]||[]).forEach((function(e){n.push({id:e,name:u[t.field][e]})})),e.addToSelected(n)}}))},afterShow:function(){for(var e=t.query[t.field]||[],n=0;n<e.length;n++)this.node.find('.block-fluid li input[value="'+e[n]+'"]').closest("li").eq(0).trigger("click");this.on("update",(function(e){t.trigger("state-change",e)}))},afterClose:function(n){var o=[],i={};t.popupVisible=!1,t.balloon=null,"complete"==n?(this.node.find(".block-choosed li input").each((function(n){o.push(this.value),u.hasOwnProperty(t.field)||(u[t.field]={}),u[t.field][this.value]=e(this).data("caption")})),o.length&&(i[t.field]=o),t.setQuery(i),t.onApply()):t.trigger("cancel")}})}))},popupHide:function(){this.popupVisible=!1}},p={popupLoaded:!0,popupInit:function(){var t=this;t.ajaxAction=t.$node.data("ajaxAction")||"",t.ajaxAction.length&&(t.popupLoaded=!1),t.$balloon=e(".js-balloon",t.$node),t.$balloonList=e("div.balloon-overview",t.$balloon);var n=t.$balloon[0].querySelector(".js-filter-modal-toggle");function o(e){e.preventDefault(),t.popupHide(),t.onApply()}n&&n.addEventListener("click",o),t.$balloon.find("[type=submit]").on("click.filter",o),t.$balloon.find("[type=reset]").on("click.filter",(function(e){e.preventDefault(),t.popupHide(),t.onCancel(),t.trigger("cancel")})),t.$button.on("click.filter",(function(n){e(n.target).closest(t.$close).length||(t.popupVisible?(t.popupHide(),t.trigger("balloon",null)):(t.popupShow(),t.trigger("balloon",t)))})),t.useReorder&&t.reorderPopupInit()},popupLoad:function(t){var n=this;n.popupLoaded?t&&t():e.get("/js.php?area=catalog&action="+n.ajaxAction,(function(e){e&&e.success&&(n.$balloonList.find(".balloon-content-targets").html(e.result),n.popupLoaded=!0,n.trigger("balloon.loaded",n),t&&t())}))},usePopupShade:!1,popupShadeListCounter:0,popupShadeList:function(e,t){this.usePopupShade&&(e||this.popupShadeListCounter<=0?(t||this.$balloonList.css("opacity",.3),this.popupShadeListCounter=1):++this.popupShadeListCounter)},popupUnShadeList:function(){!this.usePopupShade||--this.popupShadeListCounter>0||this.$balloonList.css("opacity",1)},popupShow:function(){var t=this;return this.popupVisible=!0,this.$balloon.removeClass("hide"),this.popupUpdatePosition(),this.update(),this.popupLoad((function(){t.popupShadeList(!0),t.popupRiseScroll(),t.update(),t.popupUnShadeList()})),e(window).trigger("overlap"),this},popupHide:function(){return this.popupVisible=!1,this.$balloon.addClass("hide"),this.update(),e(window).trigger("overlap"),this},popupRiseScroll:function(){this.$balloonList.scrollTop(0)},popupUpdatePosition:function(){var t=this,n=e(window).width(),o=t.$button.outerWidth(),i=t.$button.outerHeight(),a=t.$button.offset(),s=t.$button.position(),l=t.$balloon.outerWidth(),c=r.is_phone?15:20,u=s.top+i,d=s.left-l/2+o/2,p=a.left+d;p<c?d+=c-p:p>n-l-c&&(d-=p-(n-l-c)),t.$balloon.css({position:"absolute",top:u,left:d}).find(".balloon-arrow").css({left:s.left-d+o/2})},popupUpdatePositionMobile:function(){var t=this,n=e(window).width(),o=t.$button.outerWidth(),i=t.$button.outerHeight(),a=t.$button.offset(),s=e(window).scrollTop(),l=t.$balloon.outerWidth(),c=t.$balloon.outerHeight(),u=r.is_phone?0:20,d=a.top+i,p="top",h=Math.min(Math.max(a.left-l/2+o/2,u),n-l-u);a.top-i-c>s&&(d=a.top-i/2-c,p="bottom"),t.$balloon.css({position:"absolute",top:d,left:h,zIndex:55}).toggleClass("balloon-arrow-position-bottom","bottom"===p).find(".balloon-arrow").css({left:a.left-h+o/2})},dummy:null},h={available_trait_xhr:null,checkAvail:function(){throw new Error("Not implemented")},_requestAvailability:function(t,n,o,i){var a=this;o=o||function(){},i=i||function(){},a.available_trait_xhr&&a.available_trait_xhr.abort(),this.available_trait_xhr=e.post(t,Object.assign(n,{action:"FilterFacets",section:a.$node.data("name")})).always((function(){a.available_trait_xhr=null})).done((function(e){e.success?o(e.result):i()})).fail((function(){i()}))}},f={useReorder:!0,reorderPopupParent:null,reorderPopupBaseContent:null,reorderPassthrough:!1,reorderPopupInit:function(){this.$balloon.data("usereorder")?(this.usePopupShade=!0,this.reorderPopupParent=this.$balloon.find("div.balloon-content:has(> div.tooltip-target)"),this.reorderPopupBaseContent=this.reorderPopupParent.children("div.tooltip-target").toArray().map((function(t,n){return{elem:t,$input:e(t).find('input[type="checkbox"]'),$alphabet:e(t).find(".js-balloon-alphabet"),index:n}}))):this.useReorder=!1},reorderItemsByAvailability:function(){if(this.useReorder&&this.reorderPopupBaseContent&&!this.reorderPassthrough){var e=this.reorderPopupBaseContent.slice().sort((function(e){return(e.$input.is(":checked")?0:e.$input.hasClass("disabled")?2:1)*this.groupMaxLength+e.index})),t=document.createDocumentFragment(),n=null;e.forEach((function(e){if(e.$alphabet){var t=e.$alphabet.text();e.$alphabet.toggleClass("hide",t==n||e.$input.prop("disabled")||e.$input.prop("checked")),n=t}this.appendChild(e.elem)}),t),this.reorderPopupParent.append(t),this.popupRiseScroll&&this.popupRiseScroll()}else this.reorderPassthrough=!1}};function g(t,n){var o=this,i=e(".input-search",t),a=e(".input-clear",i);return o.elements=n||[],o.$input=e("input[type=search]",i),o.reset=function(){return o.$input.val("").trigger("keyup.search"),!1},o.onKeyup=function(){},o.setElements=function(e){o.elements=e},o.$input.on("keyup.search",(function(n){n.preventDefault();var i=this.value,s=new RegExp("("+i+")","i");i.length>0?a.removeClass("hide"):a.addClass("hide"),e(t).toggleClass("balloon-filtered",i.length>0),e(o.elements).each((function(){var t=e(this),n=t.closest(".tooltip-target"),o=""+t.data("caption");o.match(s)?(t.next("span").find(".js-checkbox-name").html(o.replace(s,"<strong>$1</strong>")),n.show()):n.hide()}))})),a.on("click",o.reset),o}function v(t){this.node=t,this.query={},this.active=0,this.field=e(this.node).data("field"),this.range={},this.initObservable(),this.init()}function m(e,t){v.apply(this,Array.prototype.slice.call(arguments)),t=t||{},this.dynamic=t.dynamic||!1}function y(e){v.apply(this,Array.prototype.slice.call(arguments))}function b(t){v.apply(this,Array.prototype.slice.call(arguments));var n=this;n.checkbox=e("[type=checkbox]",t).get(0),n.field=n.checkbox.name,e("[type=checkbox]",n.$button).on("change",(function(e){n.onApply()}))}function w(e){v.apply(this,Array.prototype.slice.call(arguments)),this.popupInit()}function $(t){v.apply(this,Array.prototype.slice.call(arguments));var o,i=this;i.node=t,i.applyDisabled=!1,i.select=new n(e("label.select",t).get(0),{onInit:function(){i.field=this.$select.attr("name")},onChange:function(e,t){e=t>0&&e,i.trigger("change-state"),i.query[i.field]!=e&&(i.query[i.field]=e,i.onApply())},onToggle:function(e,t){t?(i.trigger("balloon",i),o=e):o===e&&i.trigger("cancel")},exclude:".close"})}function _(t){v.apply(this,Array.prototype.slice.call(arguments)),this.field=e(this.node).data("field"),this.layer=e(this.node).data("layer"),this.popupInit()}function k(t){v.apply(this,Array.prototype.slice.call(arguments));var n=this;n.popupInit(),n.slider=new o(e(".js-slider",t),{range:e(t).data("range")||[1,5],step:e(t).data("step")||1}),n.on("balloon",(function(e){e&&n.slider.update()}))}function j(t){v.apply(this,Array.prototype.slice.call(arguments));var n=this;n.popupInit(),n.sliders=[],n.checkboxes=[],n.checkboxesToggleParamsCached=!1;var i=null!==n.node.closest(".js-filter-modal");function s(){i&&n.balloonFooter&&n.balloonFooter.classList.toggle("hidden",!n.checkboxes.some((e=>e.checked)))}function l(){n.sliders=[],n.checkboxes=[],e(".js-slider",n.$balloon).each((function(t,i){var a=e(i).data();n.sliders.push(new o(i,{range:a.range,step:a.step}))})),e("input[type=checkbox]",n.$balloon).each((function(e,t){n.checkboxes.push(t)}))}n.balloonFooter=n.node.querySelector(".js-balloon-footer"),l();var c=null;e("input[type=search]",n.$balloon).length&&(c=new g(n.$balloon,n.checkboxes),n.on("balloon",(function(e){c.reset(),e&&!r.is_phone&&c.$input.focus()}))),n.on("balloon",(function(e){s(),e&&n.sliders.forEach((function(e){e.update()}))})),n.on("balloon.loaded",(function(){if(n.ajaxAction.length){n.useReorder&&n.reorderPopupInit(),l(),s();var e=a.getItems();for(var t in e)n.onAddTag&&n.onAddTag(e[t]);c&&c.setElements(n.checkboxes),n.trigger("state-change")}})),n.$balloon.on("change","input[type=checkbox]",(function(t){s(),n.reorderPassthrough=!0;var o=e(t.target);o.hasClass("disabled")?o.is(":checked")&&o.prop("checked",!1):n.trigger("state-change",o.is(":checked"),o)})),n.$balloon.on("input","input[type=text]",(function(t){n.reorderPassthrough=!0;var o=e(t.target);n.trigger("state-change",o.val(),o)}))}function C(e){j.apply(this,Array.prototype.slice.call(arguments))}function x(e){v.apply(this,Array.prototype.slice.call(arguments));var t=this;t.value=t.$node.data("value"),t.$node.on("click",".tag-remove",(function(e){e.preventDefault(),e.stopPropagation(),a.remove(a.getKey(t.field,t.value))})),a.on("add",t.onAddTag.bind(t)),a.on("remove",t.onRemoveTag.bind(t))}function q(t){v.apply(this,Array.prototype.slice.call(arguments));var n=this;n.name=n.$node.data("name"),n.value=n.$node.attr("data-value"),n.stat=n.$node.attr("data-stat"),n.$button=e(".button-filter",n.$node),n.$item=n.$node.closest(".filter-item"),n.$button.on("click",(function(t){t.preventDefault(),e(window).trigger("track-event",["filter","apply",n.name]),a.add(a.format(n.$node.data("name"),n.field,n.value,n.$node.data("filterType")||"other"))})),a.on("add",n.onAddTag.bind(n)),a.on("remove",n.onRemoveTag.bind(n))}function S(e){v.apply(this,Array.prototype.slice.call(arguments));var t=this;t.$item=t.$node.closest(".filter-item"),a.on("add",t.onAddTag.bind(t)),a.on("remove",t.onRemoveTag.bind(t))}function O(e){j.apply(this,Array.prototype.slice.call(arguments));var t=this;t.filterType=t.$node.data("filterType")||"other",a.on("add",t.onAddTag.bind(t)),a.on("remove",t.onRemoveTag.bind(t))}function z(e){C.apply(this,Array.prototype.slice.call(arguments));var t=this;t.filterType=t.$node.data("filterType")||"other",a.on("add",t.onAddTag.bind(t)),a.on("remove",t.onRemoveTag.bind(t))}function B(e){$.apply(this,Array.prototype.slice.call(arguments));var t=this;t.defaultValue=t.select.$select.data("default"),t.query[t.field]=t.defaultValue,a.on("add",(function(e){e.kvs.forEach((function(e){e.key===t.field&&(t.select.setValue(e.value,!0),t.query[t.field]=e.value)}))})),a.on("remove",(function(e){e.kvs.forEach((function(e){e.key===t.field&&(t.select.setValue(t.defaultValue,!0),t.query[t.field]=t.defaultValue)}))}))}function P(e){var t=this;_.apply(t,Array.prototype.slice.call(arguments)),a.on("add",(function(e){e.kvs.forEach((function(n){t.field===n.key&&(t.query[n.key]=t.query[n.key]||[],-1===t.query[n.key].indexOf(n.value)&&t.query[n.key].push(n.value),u[n.key]=u[n.key]||{},n.value in u[n.key]||(u[n.key][n.value]=e.title))}))})),a.on("remove",(function(e){var n=t.query[t.field]||[],o={};Array.prototype.forEach.call(n,(function(e){o[e]=1})),e.kvs.forEach((function(e){t.field===e.key&&t.query[e.key]&&e.value in o&&t.query[e.key].splice(t.query[e.key].indexOf(e.value),1)}))}))}function I(t){v.apply(this,Array.prototype.slice.call(arguments));var n=this;n.$node=e(n.node),n.$sortItem=n.$node.find(".catalog-filter-sort__item"),n.$sortGeo=n.$node.find('.catalog-filter-sort__item-geo input[type="checkbox"]'),n.$sortItem.on("click.filter",(function(t){t.preventDefault();var o=e(this).data("title"),i=e(this).data("value"),s=e(this).hasClass("active"),r=n.$sortItem.filter('[data-value^="'+i.split("_")[0]+'"]'),l=r.index(this),c=r.filter((function(e){return e!==l})),u=r.length>1;if(s&&u)o=c.data("title"),i=c.data("value");else if(s)return;a.removeItemsByKey(n.field),a.add(a.format(o,n.field,i))})),a.on("add",n.onAddTag.bind(n)),a.on("remove",n.onRemoveTag.bind(n))}Object.assign(v.prototype,{init:function(){var t=this;t.$node=e(t.node),t.$button=e(".button-filter",t.$node),t.$close=e(".close",t.$node),t.$close.on("click.filter",(function(n){n.stopPropagation(),n.preventDefault(),t.applyDisabled=!0,t.setQuery({}),t.applyDisabled=!1,t.popupHide();var o=e(n.target).closest(".js-filter-item").data("name");e(window).trigger("track-event",["filter","cancel",o]),t.trigger("apply","clear")})),t.$node.on("click",".js-hint",(function(t){t.preventDefault();var n=e(this),o=n.data("z-hint")||null;o?o.show():((o=new i(document.getElementById("hintBalloon"),{selector:n,content:n.data("text"),data:{field:n.data("id"),category:""}})).getContent((function(){o.show()})),n.data("z-hint",o))}))},onCancel:function(){this.setQuery(this.query)},onApply:function(){this.trigger("apply")},setQuery:function(e){var t=this;t.query={},e.hasOwnProperty(t.field)&&(t.query[t.field]=e[t.field]),t.update()},fillQuery:function(e){for(var t in this.query)e[t]=this.query[t]},setRange:function(e){this.range=e},popupShow:function(){},popupHide:function(){},update:function(){},dummy:null},t.prototype),l(m,v),Object.assign(m.prototype,{init:function(){var t=this;t.$node=e(t.node),t.$button=e(".button-filter",t.$node),t.$close=e(".close",t.$node),e(".close",t.node).on("click.filter",(function(e){e.preventDefault(),t.setQuery({}),t.trigger("close"),t.trigger("apply")}))},update:function(){var t=this.query[this.field];this.active=t?1:0,this.$button.toggleClass("selected",!!this.active),this.dynamic&&e(".descr",this.$node).text(t?": "+t:""),this.$node.closest(".filter-item").toggle(!!this.active)},remove:function(){this.$node.closest(".filter-item").remove()}}),l(y,v),Object.assign(y.prototype,{init:function(){var t=this;t.$node=e(t.node),t.$input=e("input[type=text]",t.node),t.$close=e(".close",t.$node),e(".close",t.node).on("click.filter",(function(e){e.preventDefault();var n={};n[t.field]="",t.$node.addClass("loading"),t.setQuery(n),t.trigger("close"),t.trigger("apply")}));var n=debounce((function(e){var n={};e!=t.query[t.field]&&(e.length>=3||!e.length&&t.query[t.field])?(n[t.field]=e,t.setQuery(n),t.onApply()):t.$node.removeClass("loading")}),600);t.$input.on("keyup",(function(o){var i=e.trim(this.value);i!=t.query[t.field]&&(i.length>=3||!i.length&&t.query[t.field])&&t.$node.addClass("loading"),n(i)})),t.$node.on("submit",(function(e){e.preventDefault()})),t.on("loaded",(function(){t.$node.removeClass("loading")}))},setQuery:function(e){var t=this;t.query={},e.hasOwnProperty(t.field)&&(t.query[t.field]=e[t.field]),t.$input.is(":focus")||t.$input.val(t.query[t.field]),t.update()},update:function(){this.active=this.query[this.field]?1:0,this.$node.toggleClass("active",!!this.active)}}),l(b,v),Object.assign(b.prototype,{onApply:function(){this.query[this.field]=!!this.checkbox.checked&&this.checkbox.value,this.update(),this.trigger("apply")},update:function(){var e=this;e.active=e.query[e.field]?1:0,e.checkbox.checked=e.active,e.$button[e.active?"addClass":"removeClass"]("selected")},dummy:null}),l(w,v),Object.assign(w.prototype,p,{setQuery:function(t){var n=this;e("input[type=checkbox]",n.$balloon).each((function(){var e=!!t[this.name]&&this.value;this.checked=e,n.query[this.name]=e})),n.update()},onApply:function(){var t=this;e("input[type=checkbox]",t.$balloon).each((function(){t.query[this.name]=!!this.checked&&this.value})),t.update(),t.trigger("apply")},update:function(){var t=this,n=[],o="";for(var i in t.query)!1!==t.query[i]&&n.push(e('[name="'+i+'"]',t.$balloon).closest("label").find(".js-checkbox-name").text());r.is_phone&&n.length?o=": "+n.length:n.length>1?o=" ("+n.length+")":1==n.length&&(o=": "+n[0]),t.active=n.length,t.$button[t.active?"addClass":"removeClass"]("selected"),t.$button[t.popupVisible?"addClass":"removeClass"]("active dropped"),e(".descr",t.$node).text(o)},dummy:null}),l($,v),Object.assign($.prototype,{setQuery:function(e){this.select.setValue(e[this.field])},onApply:function(){this.update(),this.applyDisabled||this.trigger("apply")},update:function(){var e=this;e.active=e.query.hasOwnProperty(e.field)&&e.query[e.field]?1:0,e.$button[e.active?"addClass":"removeClass"]("selected")},onCancel:function(){this.select.toggler.getVisible()&&this.select.toggler.setVisible(!1)},setRange:function(t){var n=this;if(n.range=t,n.range&&n.range.hasOwnProperty(n.field)){var o=!1;e("option",n.node).each((function(){var t=n.range[n.field][this.value];t=t||void 0===t,n.query.hasOwnProperty(n.field)&&this.value==n.query[n.field]&&(o=t),e(this).data("visible",t)})),n.select.refresh(),n.applyDisabled=!0,n.select.setValue(o?n.query[n.field]:""),n.applyDisabled=!1}},dummy:null}),l(_,v),Object.assign(_.prototype,d,{setQuery:function(e){var t=this;if(t.city||(t.city=e.city),t.query={},e.hasOwnProperty(t.field)&&e[t.field].length)t.query[t.field]=e[t.field],Object.keys(u[t.field]).length||t.getItems();else if("custom_filter"==t.layer){var n=t.field+"[";for(var o in e)0==o.indexOf(n)&&(t.query[t.field]=t.query[t.field]||[],t.query[t.field].push(e[o]))}t.update()},onApply:function(){this.trigger("apply")},update:function(){var t=this,n="",o=t.query[t.field]||[],i=u[t.field];r.is_phone&&o.length?n=": "+o.length:o.length>1?n=" ("+o.length+")":1==o.length&&(n=i&&i.hasOwnProperty(o[0])?": "+capitalize(i[o[0]]):": "+capitalize(o[0])),t.active=o.length,t.$button[t.active?"addClass":"removeClass"]("selected"),t.$button[t.popupVisible?"addClass":"removeClass"]("active"),e(".descr",t.$node).text(n)},getItems:function(){var t=this;if("custom_filter"!=t.layer&&"metro"!=t.layer){var n={area:"misc",action:t.layer,city:t.city};"malls"==t.layer&&Object.assign(n,{action:"getMallsByIds",ids:t.query[t.field]}),e.post("/js.php",n,(function(e){var n=e.items;if(u.hasOwnProperty(t.field)||(u[t.field]={}),"malls"==t.layer)for(var o in n)u[t.field][n[o].id]=n[o].name;else u[t.field]=n;t.update()}))}},dummy:null}),l(k,v),Object.assign(k.prototype,p,{setQuery:function(t){var n=this;e("input[type=text]",n.$balloon).each((function(){var e=!!t[this.name]&&t[this.name];this.value=!1!==e?e:"",n.query[this.name]=e})),n.slider.update(),n.update()},onApply:function(){var t=this;e("input[type=text]",t.$balloon).each((function(){t.query[this.name]=!!this.value&&this.value})),t.update(),t.trigger("apply")},update:function(){var t=this,n=[],o="";for(var i in t.query)n.push(t.query[i]);(n[0]||n[1])&&(o=":",n[0]&&(o+=" от "+n[0]),n[1]&&(o+=" до "+n[1])),t.active=n.length,t.$button[t.active?"addClass":"removeClass"]("selected"),t.$button[t.popupVisible?"addClass":"removeClass"]("active dropped"),e(".descr",t.$node).text(o)},dummy:null}),l(j,v),Object.assign(j.prototype,p,h,f,{setQuery:function(t){var n=this;e("input[type=text]",n.$balloon).each((function(e,o){var i=t[o.name]||!1;o.value=!1!==i?i:"",n.query[o.name]=i})),e("input[type=checkbox]",n.$balloon).each((function(e,o){var i=!!t[o.name]&&o.value;o.checked=!1!==i,n.query[o.name]=i})),n.update()},getQuery:function(){var t={};return e("input[type=text]",this.$balloon).each((function(e,n){t[n.name]=!!n.value&&n.value})),e("input[type=checkbox]",this.$balloon).each((function(e,n){t[n.name]=!!n.checked&&n.value})),t},onApply:function(){Object.assign(this.query,this.getQuery()),this.update(),this.trigger("apply")},update:function(){var t=this,n=[],o="";t.sliders.forEach((function(o){var i=e.trim(o.$node.find(".units").text()),a={},s="";o.$inputs.each((function(e,n){Object.hasOwnProperty.call(t.query,n.name)&&!1!==t.query[n.name]&&(a[e]=t.query[this.name])})),(a[0]||a[1])&&(a[0]&&(s+="от "+a[0]),a[0]&&a[1]&&(s+=" "),a[1]&&(s+="до "+a[1]),i&&(s+=" "+i),n.push(s))})),t.checkboxes.forEach((function(o){t.query.hasOwnProperty(o.name)&&!1!==t.query[o.name]&&n.push(e(o).closest("label").find(".js-checkbox-name").text())})),r.is_phone&&n.length?o=": "+n.length:n.length>1?o=" ("+n.length+")":1==n.length&&(o=": "+n[0]),t.active=n.length,t.$button[t.active?"addClass":"removeClass"]("selected"),t.$button[t.popupVisible?"addClass":"removeClass"]("active dropped"),e(".descr",t.$node).text(o)},cacheCheckboxesToggleParams:function(){this.checkboxesToggleParamsCached||(this.checkboxes.forEach((function(e){var t=e.name.match(/([^\[\]]+)/g);e.tpCached={type:t[0],field:t[1],value:t[2]}})),this.checkboxesToggleParamsCached=!0)},checkAvail:function(t){var n=this;n.popupShadeList(!1,!0);var o=t.data,i=n.getQuery();for(var a in i)!1===i[a]?delete o[a]:o[a]=i[a];var s="boolean"==typeof t.reorderPassthrough&&t.reorderPassthrough;n._requestAvailability(t.url,o,(function(t){n.cacheCheckboxesToggleParams(),n.checkboxes.forEach((function(n){var o=n.tpCached;switch(o.type){case"categories":e(n).toggleClass("disabled",!t[o.type][o.field]);break;case"o":case"m":case"offer_types":e(n).toggleClass("disabled",!t[o.field]);break;case"fvi":case"v":var i=t[o.field]&&t[o.field][o.value];void 0===i&&(i=!0),e(n).toggleClass("disabled",!i).prop("disabled",!i)}})),n.reorderPassthrough=s,n.reorderItemsByAvailability&&n.reorderItemsByAvailability(),n.popupUnShadeList()}),(function(){n.reorderPassthrough=s,n.reorderItemsByAvailability&&n.reorderItemsByAvailability(),n.popupUnShadeList()}))}}),l(C,j),Object.assign(C.prototype,{setQuery:function(e){var t=this;if(t.checkboxes.length){var n=t.checkboxes[0].name,o=(t.query[n]||[]).reduce((function(e,t){return e[t]=t,e}),{});delete t.query[n],t.checkboxes.forEach((function(e){e.checked=!!o[e.value],e.checked&&(t.query[n]=t.query[n]||[],t.query[n].push(e.value))})),t.update()}},onApply:function(){var e=this;e.checkboxes.length&&(delete e.query[name],e.checkboxes.forEach((function(t){var n=t.name;t.checked&&(e.query[n]=e.query[n]||[],e.query[n].push(t.value))})),e.update(),e.trigger("apply"))},update:function(){var t=this;if(t.checkboxes.length){var n=t.checkboxes[0].name,o=(t.query[n]||[]).reduce((function(e,t){return e[t]=t,e}),{}),i=t.checkboxes.reduce((function(t,n){return null!=o[n.value]&&t.push(e(n).closest("label").find(".js-checkbox-name").text()),t}),[]),a="";i.length&&(a=i.length>1?" ("+i.length+")":": "+i[0]),r.is_phone&&i.length&&(a=": "+i.length),t.active=i.length,t.$button.toggleClass("selected",!!t.active),t.$button.toggleClass("active dropped",!!t.popupVisible),e(".descr",t.$node).text(a)}}}),l(x,v),Object.assign(x.prototype,{onAddTag:function(e){var t=this;e.kvs.forEach((function(e){e.key.replace("[]","")===t.field&&t.$node.toggleClass("selected",e.value===t.value)}))},onRemoveTag:function(e){var t=this;e.kvs.forEach((function(e){e.key.replace("[]","")===t.field&&e.value===t.value&&t.$node.removeClass("selected")}))},setQuery:function(){}}),l(q,v),Object.assign(q.prototype,{onAddTag:function(e){var t=this;e.kvs.forEach((function(e){e.key.replace("[]","")===t.field&&t.$item.addClass("hidden")}))},onRemoveTag:function(e){var t=this;e.kvs.forEach((function(e){e.key.replace("[]","")===t.field&&t.$item.removeClass("hidden")}))},setQuery:function(){},onApply:function(){},onCancel:function(){},update:function(){}}),l(S,v),Object.assign(S.prototype,{onAddTag:function(e){var t=this;e.kvs.forEach((function(e){e.key.replace("[]","")===t.field&&t.$item.addClass("hidden")}))},onRemoveTag:function(e){var t=this;e.kvs.forEach((function(e){e.key.replace("[]","")===t.field&&t.$item.removeClass("hidden")}))},setQuery:function(){},onApply:function(){},onCancel:function(){},update:function(){}}),l(O,j),Object.assign(O.prototype,{onAddTag:function(t){var n=this;t.kvs.forEach((function(t){var o=t.key.replace("[]",""),i=e(['input[name="'+o+'"][value="'+t.value+'"]:checkbox','input[name="'+o+'"]:text'].join(", "),n.$balloon);i.length&&(i.is(":checkbox")?i.prop("checked",!0):i.is(":text")&&i.val(t.value))}))},onRemoveTag:function(t){var n=this;t.kvs.forEach((function(t){var o=t.key.replace("[]",""),i=e(['input[name="'+o+'"][value="'+t.value+'"]:checkbox','input[name="'+o+'"]:text'].join(", "),n.$balloon);i.length&&(i.is(":checkbox")?i.prop("checked",!1):i.is(":text")&&i.val(""))})),n.popupVisible&&n.popupHide()},setQuery:function(){},onApply:function(){var t=this;t.checkboxes.forEach((function(n){n.checked?a.add(a.format(e(n).data("caption"),n.name,n.value,t.filterType)):a.remove(a.getKey(n.name,n.value))})),t.sliders.forEach((function(t){var n=e.trim(t.$node.find(".units").text()),o={},i="";if(t.$inputs.each((function(t,n){o[t]=e(n).val()})),o[0]||o[1]){o[0]&&(i+="от "+o[0]),o[0]&&o[1]&&(i+=" "),o[1]&&(i+="до "+o[1]),n&&(i+=" "+n);var s=t.$node.data("caption"),r={title:s.charAt(0).toUpperCase()+s.slice(1)+": "+i,kvs:[{key:t.$inputs[0].name,value:o[0]},{key:t.$inputs[1].name,value:o[1]}],type:"other"},l=JSON.stringify(a.getItemsByKey(t.$inputs[0].name).map((function(e){return e.kvs})));l!==JSON.stringify([r.kvs])&&a.removeItemsByKey(t.$inputs[0].name),a.add(r)}else a.removeItemsByKey(t.$inputs[0].name)})),t.trigger("apply")},onCancel:function(){var t=this;for(var n in this.$node.find(":checkbox").prop("checked",!1),this.$node.find(":text").val(""),a.items)a.items[n].kvs.forEach((function(n){var o=e(['input[name="'+n.key+'"][value="'+n.value+'"]:checkbox','input[name="'+n.key+'"]:text'].join(", "),t.$balloon);o.length&&(o.is(":checkbox")?o.prop("checked",n.value):o.is(":text")&&o.val(n.value))}))},update:function(){this.$button.toggleClass("active dropped",!!this.popupVisible)}}),l(z,C),Object.assign(z.prototype,{onAddTag:O.prototype.onAddTag,onRemoveTag:O.prototype.onRemoveTag,setQuery:function(){},onApply:function(){var t=this;e("input[type=checkbox]",this.$balloon).each((function(){var n=this.name+"[]";this.checked?a.add(a.format(e(this).data("caption"),n,this.value,t.filterType)):a.remove(a.getKey(n,this.value))})),t.trigger("apply")},onCancel:function(){var t=this;this.$node.find(":checkbox").prop("checked",!1);var n=a.items;for(var o in n)n[o].kvs.forEach((function(n){var o=n.key.replace("[]","");e('input[name="'+o+'"][value="'+n.value+'"]',t.$balloon).prop("checked",n.value)}))},update:function(){this.$button.toggleClass("active dropped",!!this.popupVisible)}}),l(B,$),Object.assign(B.prototype,{setQuery:function(){},onApply:function(){var e=this,t=e.select.getValue();t!=e.defaultValue?(a.removeItemsByKey(e.field),a.add(a.format(e.select.getTitle(),e.field,t))):a.getItemsByKey(e.field).forEach((function(e){a.remove(a.getTagKey(e))})),e.applyDisabled||e.trigger("apply")},update:function(){}}),l(P,_),Object.assign(P.prototype,{update:function(){var e=this,t=e.query[e.field]||[],n={};for(var o in Array.prototype.forEach.call(t,(function(e){n[e]=1})),a.items)a.items[o].kvs.forEach((function(t){e.field!==t.key||t.value in n||a.remove(a.getKey(t.key,t.value))}));Array.prototype.forEach.call(t,(function(t){a.add(a.format(u[e.field][t],e.field,t))}))},dummy:null}),l(I,v),Object.assign(I.prototype,{onAddTag:function(t){var n=this;t.kvs.forEach((function(t){if(t.key.replace("[]","")===n.field){var o=n.$sortItem.filter('[data-value^="'+t.value.split("_")[0]+'"]'),i=o.length>1;n.$sortItem.removeClass("active").filter('[data-value="'+t.value+'"]').addClass("active"),n.$sortGeo.prop("checked",t.value===n.$sortGeo.val()),i&&o.addClass("hidden").filter((function(t){return e(this).hasClass("active")})).removeClass("hidden")}}))},onRemoveTag:function(e){var t=this;e.kvs.forEach((function(e){e.key.replace("[]","")===t.field&&(t.$sortGeo.prop("checked",!1),t.$sortItem.removeClass("active"))}))},setQuery:function(){}});var L=function(e,t){this.filter=e,this.items=[],this.params=t||{},this.init()};function T(e){v.apply(this,Array.prototype.slice.call(arguments));var t=this;this.name=this.$node.data("name"),this.type=this.$node.data("type"),this.$button=this.$node.find(".button-filter"),this.$balloon=this.$node.find(".js-balloon-aggregate"),this.$button.on("click",(function(){t.$balloon.removeClass("hide"),t.trigger("balloon",t)}))}Object.assign(L.prototype,{init:function(){var t=this;t.$node=t.filter.$node.find(".js-filter-modal"),t.$toggleBtn=t.filter.$node.find(".js-filter-modal-toggle"),t.activeBalloon=null,t.parentBalloon=null,t.$header=t.$node.find(".js-filter-modal-header"),t.$headerTitle=t.$header.find(".js-filter-modal-header-text"),t.defaultTitle=t.$headerTitle.text();var n=e(".js-header-mobile");t.$toggleBtn.on("click",(function(){e("body").toggleClass("oh"),n.toggleClass("hidden"),t.$node.toggleClass("hidden")})),this.filter.on("balloon",(function(e){t.activeBalloon=e,t.toggleBalloon(!0)})),t.$header.find(".js-filter-modal-back").on("click",(function(){t.activeBalloon.popupHide(),t.toggleBalloon(!1),t.parentBalloon&&(t.activeBalloon=t.parentBalloon)})),t.filter.on("apply",(function(){t.parentBalloon&&(t.activeBalloon=t.parentBalloon),t.toggleBalloon(!1)})),a.on("update",t.updateTagsCount.bind(t))},toggleBalloon:function(e){var t=this.activeBalloon.$node,n=t.parent().closest(".js-filter-item").data("name"),o=!(e||n);this.$header.find(".js-filter-modal-back").toggleClass("hide",o),this.$header.find(".js-filter-modal-close").toggleClass("hide",!o);var i=e?t.data("name"):n;this.$headerTitle.text(o?this.defaultTitle:i),e&&!n&&(this.parentBalloon=this.activeBalloon),o&&(this.activeBalloon=null,this.parentBalloon&&this.parentBalloon.$balloon&&this.parentBalloon.$balloon.addClass("hide"),this.parentBalloon=null),this.updateTagsCount()},updateTagsCount:function(){var e=a.hasItems(),t=this.$header.find(".filter-modal--header_tags");t.text(e),t.toggleClass("hide",0===e||null!==this.activeBalloon)}}),l(T,v);var A=function(e,t){this.filter=e,this.items=[],this.params=t||{},this.initObservable(),this.init()};function V(t,n){this.node=t,this.$node=e(this.node),this.items=[],this.itemSelector=".js-filter-item",this.initObservable(),n&&n.length||(n=this.$node.find(this.itemSelector)),this.on("loaded",(function(){this.items.forEach((function(e){e.trigger("loaded")}))})),this.addFilterItems(n)}function E(t,n){var o=this;o.node=t,o.$node=e(t),o.items=[],o.query={},o.mapView=null,o.points=[],o.bounds=null,o.initObservable(),o.on("apply",(function(){o.update()})),n&&this.addFilterItems(n)}return Object.assign(A.prototype,{init:function(){var t=this;this.$showMore=this.filter.$node.find(".js-showmore-block"),this.$list=this.filter.$node.find(".js-showmore-list"),this.$button=this.$showMore.find(".js-showmore-button"),this.$balloon=this.$showMore.find(".js-showmore-balloon"),this.$tagsCount=this.$showMore.find(".js-showmore-count"),this.toggler=new s(this.$button,this.$balloon),this.maxLines=this.params.maxLines||1,this.toggler.on("toggle",(function(n){t.$button.toggleClass("active dropped",n),t.showItem(null),n&&(t.updateBalloonPosition(),e(window).trigger("track-event",["filter","show_more"])),window.dispatchEvent(new CustomEvent("filterShowmoreToggle",{detail:n}))})),this.filter.on("apply",(function(){t.toggler.getVisible()&&t.toggler.setVisible(!1)})),this.filter.on("balloon",(function(e){t.toggler.getVisible()&&t.showItem(e)})),this.addButtonBack(),a.on("add remove",t.revert.bind(t)),a.on("update",t.update.bind(t)),e(window).on("resize.showmore",throttle((function(){t.update(),t.showItem(null)}),100)),this.update()},addButtonBack:function(){var t=this,n="<span>"+window.i18n.t("page.back",null)+"</span>",o=e(n).addClass("button button-silver button-back js-filter-back");t.filter.items.forEach((function(e){var t=o.clone();e.$balloon&&!e.$balloon.find(".js-filter-back").length&&e.$node.find(".balloon-footer").append(t)})),t.$list.on("click",".js-filter-back",(function(e){e.preventDefault(),t.showItem(null)}))},showItem:function(e){var t=this;e&&e.$node.closest(t.$list).length?(t.$list.find(".filter-item").addClass("hidden"),e.$node.closest(".filter-item").removeClass("hidden").addClass("active")):(t.filter.items.forEach((function(e){e.popupVisible&&e.popupHide()})),t.$list.find(".filter-item").removeClass("hidden active"))},setItems:function(e){this.items=e||[]},hasItems:function(){return this.items.length},revert:function(){var e=this;e.items.forEach((function(t){t.removeClass("hidden active").insertBefore(e.$showMore)})),e.items=[]},updateList:function(){var e=this;e.items.forEach((function(t){t.removeClass("hidden").appendTo(e.$list)}));var t=e.$list.find(".filter-item-tag").length;e.$showMore.toggleClass("hide",!e.hasItems()),e.$tagsCount.toggle(!!t).text(t),e.updateBalloonPosition()},update:function(){var e=this,t=e.filter.$node.find(a.getList()),n=t.find(".filter-item"),o=[];e.trigger("update","before"),e.$showMore.removeClass("hide"),e.$tagsCount.removeClass("hide"),e.hasItems()&&e.revert();for(var i=n.length;i--;){var s=n.eq(i);if(!s.hasClass("js-showmore-block")){var r=t.height(),l=t.css("width",1e6).height();if(t.css("width",""),!(r>l*e.maxLines))break;o.unshift(s.addClass("hidden"))}}e.setItems(o),e.updateList(),e.trigger("update","after"),window.dispatchEvent(new Event("height"))},updateBalloonPosition:p.popupUpdatePosition},t.prototype),Object.assign(V.prototype,{addFilterItems:function(t){var n=this;return t.map((function(){return n.addItem(e(this))}))},addItem:function(e){var t=this,n=c((e=e.eq(0))[0],e.data("type"));return n.on("apply",(function(){t.trigger("apply")})),n.on("cancel",(function(){t.trigger("cancel")})),n.on("balloon",(function(e){t.trigger("balloon",e)})),n.update(),t.items.push(n),n},updateItems:function(){var e=this.$node.find(this.itemSelector);this.items=[],this.addFilterItems(e)},setQuery:function(e){this.items.forEach((function(t){t.setQuery(e)}))},getQuery:function(){var e={};return this.items.forEach((function(t){t.fillQuery(e)})),e},setRange:function(e){this.items.forEach((function(t){t.setRange(e)}))}},t.prototype),Object.assign(E.prototype,{addFilterItems:function(t){var n=this;return t.map((function(){return n.addItem(e(this))}))},addItem:function(e){var t=this,n=c((e=e.eq(0))[0],e.data("type"));return n.on("apply",(function(){t.trigger("apply")})),n.on("cancel",(function(){t.trigger("cancel")})),n.on("balloon",(function(e){t.trigger("balloon",e)})),t.items.push(n),n},attachMap:function(e,t){var n=this;if(!n.mapView){var o=n.getQuery();n.mapView=e,o.center&&o.zoom?e.map.pushOnReady((function(){e.setCenterAndZoom({center:o.center,zoom:o.zoom}),e.updatePoints(n.points)})):n.bounds?e.map.pushOnReady((function(){e.setBounds(n.bounds),e.updatePoints(n.points)})):t&&e.map.pushOnReady((function(){e.map.updateBounds(n.points,t,17),e.updatePoints(n.points)}))}},detachMap:function(){var e=this;if(e.mapView){var t=e.mapView;e.mapView=null;var n=t.getQuery();Object.keys(n||{}).length>0&&e.setQuery(n)}},setQuery:function(e){var t=this;(e=["center","zoom","xxx","bounds"].reduce((function(t,n){return e[n]&&(t[n]=e[n]),t}),{})).center&&e.zoom?(e.zoom=+e.zoom,e.center=[+e.center[0],+e.center[1]],e.xxx=1):(delete e.zoom,delete e.center),t.items.forEach((function(t){t.setQuery(e)})),t.mapView?e.center&&e.zoom&&(t.mapView.setQuery({center:e.center,zoom:e.zoom}),t.mapView.boundsChanged||t.mapView.setBoundsChanged(1),t.mapView.map.pushOnReady((function(){t.mapView.setCenterAndZoom({center:e.center,zoom:e.zoom})}))):t.query=e,t.update()},updatePoints:function(e){var t=this;t.points=e,t.mapView&&t.mapView.updatePoints(t.points)},setBounds:function(e){var t=this;t.bounds=e,t.mapView&&t.mapView.setBounds(t.bounds)},update:function(){this.items.forEach((function(e){var t=e.$node;t.length&&t[e.active?"removeClass":"addClass"]("hide")}))},getQuery:function(e){var t=this,n={};if(t.items.forEach((function(e){e.fillQuery(n)})),!n.xxx)return{};var o={};return t.mapView?(o.bounds=t.mapView.getBoundsForQuery(),"url"===e&&Object.assign(o,t.mapView.getQuery())):(t.bounds&&t.bounds.length>0&&(o.bounds=t.bounds),Object.assign(o,t.query)),o}},t.prototype),{filter:V,filterMap:E,filterShowmore:A,filterModal:L}})),define("js2/MapView",["jquery","js2/Observable","./env","js2/ZATimer"],(function(e,t,n,o){var i=function(t,o){var i=o||{},a={active:!0,bounds:[],points:[],showFilter:function(){},boundsChanged:0,query:{},external:!0,mapWidth:function(){var t=e(window).width(),o="rtl"===document.dir;if(!n.is_phone){var i=o?"right":"left",a=this.map.getNode().getBoundingClientRect()[i];t=o?a:e(window).width()-a}return t},mapHeight:function(){var t=0;return n.is_phone&&(t=this.map.getNode().getBoundingClientRect().top),e(window).height()-t}};this.map=t,Object.assign(this,a,i),this.initObservable(),this.init()};return Object.assign(i.prototype,t.prototype,{init:function(){var t=this;t.map.pushOnReady((function(){if(t.points&&t.points.length&&(t.bounds=t.getBoundsByPoints(t.points)),n.is_phone||!t.external){const e=t.center?{center:t.center,zoom:12}:t.map.getCenterAndZoom();t.map.createMap(e),t.updatePoints(t.points)}t.map.initMapEvents(),e(window).on("resize.map",debounce((function(e){t.setMapSize()}),50)),t.setMapSize(),t.initZoom(),t.initAnalytics()})),t.map.on("z-boundschange",(function(e){e[0]!==e[2]&&e[1]!==e[3]&&(isEqual(t.bounds,e)||(t.setBoundsChanged(2),t.bounds=e,t.trigger("boundschange",e)))}))},initZoom:function(){var t=this;if(t.$zoom=e(".js-zoomControl"),t.$zoom.off("click.zoom").on("click.zoom",".js-zoom",(function(n){n.preventDefault();var o=t.map.getZoom()+(e(this).hasClass("js-out")?-1:1);t.setZoom(o)&&t.map.trigger("z-user-interact-begin",n)})),t.map.pushOnReady((function(){t.$zoom.show()})),!n.is_phone){var o=t.map.getNode(),i=!1,a=null,s=function(e){return e.stopPropagation(),e.preventDefault(),e.returnValue=!1,!1},r=function(){i=!0,t.map.enableScrollZoom(),t.$zoom.on("wheel",s)};o.addEventListener("mousedown",(function(){r()})),o.addEventListener("mouseleave",(function(){a=i,i=!1,t.map.disableScrollZoom(),t.$zoom.off("wheel",s)})),t.$zoom.on("mouseenter",(function(){a&&r()})),e("html, body").on("mouseenter",debounce((function(t){e(t.target).closest(o).length&&a&&r()}),50)),t.map.off("balloon.open").on("balloon.open",(function(e){e.getBalloonNode().then((function(e){e&&e.addEventListener("wheel",s)}))})),t.map.off("balloon.close").on("balloon.close",(function(e){e.getBalloonNode().then((function(e){e&&e.removeEventListener("wheel",s)}))}))}},initAnalytics:function(){var e=this;e.map.off("zoom").on("zoom",(function(e,t){window.za({ev_category:"map",ev_action:"zoom_"+(e>t?"in":"out")})})),e.map.off("move").on("move",(function(){window.za({ev_category:"map",ev_action:"move"})})),e.map.off("my_location.add").on("my_location.add",(function(){window.za({ev_category:"map",ev_action:"yellow_man"})})),e.map.off("balloon.display").on("balloon.display",(function(t,i){window.za({ev_category:"map",ev_action:"show_one",ev_label:i,ev_sourceType:"map_balloon",ev_sourceId:t.getId(),object_type:"organization",object_id:t.getSid()}),n.is_phone&&window.za({ev_category:"open",ev_action:"display",ev_label:i,ev_sourceType:"map_balloon",ev_sourceId:t.getId(),object_type:"organization",object_id:t.getSid()});var a=e.map.getNode().querySelector(".js-phone[data-za]");a&&o.trigger(a,{ev_action:"display"},{send_once:!0})})),e.map.off("balloon.click.button_open").on("balloon.click.button_open",(function(e,t){window.za({ev_category:"open",ev_action:"click",ev_label:t,ev_sourceType:"map_balloon",ev_sourceId:e.getId(),object_type:"organization",object_id:e.getSid()})})),e.map.off("balloon.click.url").on("balloon.click.url",(function(e){window.za({ev_category:"map",ev_action:"click",ev_sourceType:"map_balloon",ev_sourceId:e.getId(),object_type:"organization",object_id:e.getSid()})})),e.map.off("balloon.click.reviews").on("balloon.click.reviews",(function(e){window.za({ev_category:"comments",ev_action:"click",ev_sourceType:"map_balloon",ev_sourceId:e.getId(),object_type:"organization",object_id:e.getSid()})})),e.map.off("balloon.click.booking").on("balloon.click.booking",(function(e,t){window.za(Object.assign({ev_action:"click",ev_sourceId:e.getId()},t))})),e.map.off("balloon.display.booking").on("balloon.display.booking",(function(e,t){window.za(Object.assign({ev_action:"display",ev_sourceId:e.getId()},t))}))},setBoundsChanged:function(e){n.is_phone||(this.boundsChanged=e>this.boundsChanged?e:this.boundsChanged,e>0&&this.showFilter())},setMapSize:function(e,t){var o=this;if(o.active){var i={width:(e||o.mapWidth())+"px",height:(t||o.mapHeight())+"px"},a=o.map.getNode(),s=a.getBoundingClientRect().top;return n.is_phone&&(i.height="calc(var(--vh, 1vh) * 100 - "+s+"px)"),Object.assign(a.style,i),o.map.pushOnReady((function(){o.map.updateSizeNotCenter(i.width,i.height)})),i}},getUserCoords:function(e){var t=this;t.map.pushOnReady((function(){t.map.runLocationAuto((function(n){n&&t.trigger("boundschange"),e&&e(n)}))}))},setBounds:function(e){var t=this;e&&(4===e.length&&(e=[[e[1],e[0]],[e[3],e[2]]]),t.map.pushOnReady((function(){var n=t.map.getCenterAndZoom(e);t.map.setCenterAndZoom(n.center,n.zoom),t.bounds=t.map.getBounds()})))},setZoom:function(e){var t=this,n=t.getCenterAndZoom();return!(e<=4||e>=18)&&(n.zoom=e,t.setCenterAndZoom(n),t.trigger("boundschange"),!0)},getBoundsForQuery:function(){return this.map.getBoundsForQuery()},getCenterAndZoom:function(){return{center:this.map.getCenter(),zoom:this.map.getZoom()}},setCenterAndZoom:function(e){var t=this,n=e;t.map.setCenterAndZoom(n.center,n.zoom),t.bounds=t.map.getBounds()},getBoundsByPoints:function(e){return this.map.getBoundsByPoints(e.filter((function(e){return!(e.hasOwnProperty("recommended")&&e.recommended)})))||this.bounds},updatePoints:function(e){var t=this;t.map.pushOnReady((function(){t.points=e,t.map.updateObjects(e)}))},setQuery:function(e){var t=this;t.query={},e.center&&(t.query.center=e.center),e.zoom&&(t.query.zoom=e.zoom)},getQuery:function(){return this.query},pause:function(){return this.active=!1,this},resume:function(){return this.active=!0,this},dummy:null}),i})),define("js2/MapViewDummy",[],(function(){var e=function(){};return Object.assign(e.prototype,{points:[],bounds:null,boundsChanged:!0,getUserCoords:function(e){navigator.geolocation?navigator.geolocation.getCurrentPosition((function(t){var n=[t.coords.latitude,t.coords.longitude];window.Global.user.lat!=n[0]||window.Global.user.lon!=n[1]?fetch("/js.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},body:"area=profile&action=location&lat="+n[0]+"&lon="+n[1]}).then((function(e){return e.json()})).then((function(){e&&e(!0)})):e&&e(!0)}),(function(){e&&e(!1)}),{enableHighAccuracy:!0,timeout:3e3,maximumAge:0}):e&&e(!1)},setBoundsChanged:function(){},setBounds:function(){},setZoom:function(){},getBoundsForQuery:function(){return this.bounds},getCenterAndZoom:function(){return{}},setCenterAndZoom:function(){},getBoundsByPoints:function(){return null},updatePoints:function(){},setQuery:function(){},getQuery:function(){var e={};return this.bounds&&(e.bounds=this.bounds),e},setMapSize:function(){},pause:function(){},resume:function(){},dummy:null}),e})),define("js2/ResultsPoints",["jquery","js2/Observable","js2/ResultsLoader"],(function(e,t,n){var o=function(t){var n=t?JSON.parse(JSON.stringify(t)):{};e.extend(this,{url:"",format:"html",query:{}},n),this.initObservable(),this.init()};return o.prototype={init:function(){},setQuery:function(e){this.query={},this.query=Object.assign(JSON.parse(JSON.stringify(e)),{page:1})},_getQuery:function(){return this.query},load:function(){var t=this,o=t._getQuery(),i=e.Deferred();return n.load("points",t.url,o,(function(e){var n="json"===t.format?e.html:e,a=e.center;t.trigger("loaded",n,o,a),i.resolve()})),i}},Object.assign(o.prototype,t.prototype),o})),define("js2/CatalogController",["jquery","js2/Observable","js2/FilterNew","js2/MapView","js2/MapViewDummy","js2/ResultsPoints","js2/FilterTags","js2/Faq"],(function(e,t,n,o,i,a,s,r){"use strict";var l=n.filter,c=n.filterShowmore;function u(t,n,o,i){var s=i||{};this.initObservable(),this.updateNeeded={items:!1,points:!1};this.map=n,this.node=t,this.$node=e(t),this.filters=[],this.requestParams={},this.activeFilter=null,this.ranges=null;var r=o;o.multi&&Array.prototype.forEach.call(o.rls,(function(e){"service"==e.type&&(r=e)})),this.resultsList=o,this.resultsPoints=new a({url:r.url,format:r.format}),e.extend(this,{category:null,type:null,map_change_position:!1,map_linked_to_list:!1,map_updated:!1,bounds_query:!1,urlBase:"",urlTown:"",canChangeUrl:!0,query:{},allow_stat_collect:!1,minimap:null,filtersLineCount:0,is_near_me:!1,city:""},s),this.preload(),this.init()}return Object.assign(u.prototype,t.prototype,{init:function(){var e=this;return e.getRanges(),e.initFilters(),e.initMap(null),e.initMapEvents(),e.minimap&&e.initMiniMap(),e.loadFromUrl(),e.initResults(),e.initGeolocation(),e.is_near_me&&e.initNearMe(),e.initStat(),new r({listOffset:4}),e},initNearMe:function(){var e=this,t=e.urlBase.replace("nearme",e.city);s.on("remove",(function(n){n.kvs.forEach((function(n){"sort_field"===n.key&&"photodistance"===n.value&&(window.location.href=t+"?"+e._getStringByQuery(e.getQuery()))}))})),e.runGeolocation()},initStat:function(){var e=this;e.resultsList.on("afterLoaded",(function(t){e.updateStat(t),this.is_locked||e.sendStat()})),e.updateStat(e.getRanges()),e.sendStat()},updateStat:function(e){e&&e.cat&&window.za&&window.za(e.cat,"update.cat")},sendStat:function(){window.za&&window.za({ev_type:"stat",ev_category:"catalog_page"})},initGeolocation:function(){var t=this,n=t.$node.find(".js-geolocation");0!==n.length&&(navigator.geolocation&&navigator.permissions?navigator.permissions.query({name:"geolocation"}).then((function(e){"denied"!==e.state?(n.removeClass("hide"),t.map&&window.za({ev_category:"map",ev_action:"view_location_button"})):n.addClass("hide")})):n.addClass("hide"),e(document).on("click",".js-geolocation",debounce((function(n){n.preventDefault(),t.runGeolocation(),e(this).closest(".js-zoomControl").length?window.za({ev_category:"map",ev_action:"my_location"}):e(window).trigger("track-event",["filter","apply",window.i18n.t("catalog.near_me")])}),100)),e(document).on("click",".js-geolocation-new",(function(e){e.preventDefault(),t.runGeolocation(),window.za({ev_category:"filter",ev_action:"click_near_me"})})),e(document).on("change",".js-geolocation-checkbox",(function(e){var n=this;n.checked?t.runGeolocation((function(e){e||(n.checked=!1)})):s.remove(s.getKey("sort_field","photodistance"))})))},runGeolocation:function(e){var t=this;t.mapView.getUserCoords((function(n){if(t.$node.find(".js-geolocation").toggle(n),!n)return void(e&&e(!1));const o="sort_field",i="photodistance";t.getQuery()[o]!==i&&(s.removeItemsByKey(o),s.add(s.format(window.i18n.t("catalog.near_me"),o,i,"map")),e&&e(!0))}))},initFilters:function(){var t=this;t.baseFilter=Object.assign({search_query_form:1},t.extractBaseFilter()),t.filter=new l(t.$node.find(".js-filter-main")),t.filters.push(t.filter),t.filtersLineCount&&new c(t.filter,{maxLines:t.filtersLineCount}),t.filterGeo=new l(t.$node.find(".js-filter-geo")),t.filters.push(t.filterGeo),t.filterTown=new l(e("<div />"),t.$node.find('.js-filter-item[data-filter-type="town"]')),t.filters.push(t.filterTown),t.filters.forEach((function(e){e.on("balloon",(function(e){t.activateFilter(e)}))})),s.category=t.category,s.active=Boolean(t.category),s.type=t.type,s.add(Array.prototype.reverse.call(t.tags)),s.on("update",(function(){t.clearMap(),t.debouncedRequest()})),t.filter.on("apply",(function(){"photodistance"===t.filter.getQuery().sort_field&&t.mapView.getUserCoords((function(e){e&&t.debouncedRequest()}))})),t.filterTown.on("apply",(function(){this.items.forEach((function(e){e.remove()})),0===Object.keys(this.query||{}).length&&t.clearTown()})),t.$node.on("click",".js-filters-reset",(function(n){n.preventDefault();var o=e(this).data("clean");t.mapView.boundsChanged=!1,t.resetFilters(o)})),t.resultsPoints.on("afterLoaded",(function(e){t.map&&!(Object.keys(t.mapView.getQuery()||{}).length>0)&&t.mapView.points.length&&e&&e.length&&t.mapView.setBounds(t.mapView.getBoundsByPoints(e))})),t.filters.forEach((function(n){n.items.forEach((function(n){var o=n.$node.data("name");o&&(n.on("balloon",(function(e){e&&t.track(o,"open")})),n.on("state-change",(function(e,n){var i;e&&(i=n?[n.data("caption"),"select"]:[o,"select"],t.track.apply(t,i))})),n.on("apply",(function(n){if("clear"===n);else{var i=[];if(this.checkboxes)Array.prototype.forEach.call(this.checkboxes,(function(t){t.checked&&i.push(e(t).data("caption"))}));else if(this.query)for(var a in this.query)!1!==this.query[a]&&i.push(this.query[a]);i.length?t.track(o,"apply",{checked:i.join(",")}):t.track(o,"cancel")}})))}))}))},resetFilters:function(e){var t=this;0===(e=e||[]).length?(t.mapView.setQuery({}),s.reset()):(-1!==e.indexOf("geo")&&t.clearGeo(-1!==e.indexOf("map")),-1!==e.indexOf("town")&&t.clearTown(-1!==e.indexOf("map")),-1!==e.indexOf("map")&&(s.removeType("map"),t.mapView.setQuery({})),-1!==e.indexOf("common")&&s.removeType("other")),t.debouncedRequest()},initMap:function(t,n){var a=this;if(!a.map)return void(a.mapView=new i);a.map.setQuery(a.getQuery());const s=a.getRanges();let r={points:a.smartPoints(a.getPoints()),bounds:s.bounds&&s.bounds.length?s.bounds:t};a.minimap&&(r.center=a.minimap.options.center);const l=Object.assign(r,n||{});function c(){a.map&&a.map.off("z-user-interact-begin",u),e(window).off("scroll",{passive:!0},d)}function u(){c(),setTimeout((function(){a.resultsList&&a.resultsList.scrollToResults("down")}))}function d(){e(window).scrollTop()>0&&c()}a.mapWidth&&(l.mapWidth=a.mapWidth),a.mapHeight&&(l.mapHeight=a.mapHeight),a.mapView=new o(a.map,l),a.mapView.on("boundschange",debounce((function(){a.clearGeo()}),200)),a.map.on("z-user-interact-begin",u),a.map.on("balloon.open",(function(){a.resultsList.scrollToResults("down")})),e(window).on("scroll",{passive:!0},d),d()},initMiniMap:function(){var t=this,n=!1;t.resultsPoints.on("afterLoaded",(function(e,o){t.minimap.updateBounds(e),t.minimap.updateObjects(e),n=!0})),t.$node.find(".js-map-layer").on("click",(function(o){o.preventDefault(),e(window).trigger("track-event",["masterprice","open_map"]),create_layer("masterprice_map",{afterShow:function(){var n=this;e(".js-title",n.node).text(e(".page-title-block h1").text());var o=t.filter.$node.clone();o.removeClass("js-filter-main"),o.appendTo(e(".js-filter-tags",n.node)),o.find(".select.customized").removeClass("customized"),new c(new l(o)),s.init(n.node),zrequire(["build/map/js/catalog",window.mapDriverBuild],(function(e){var n=t._getQueryFromString(window.location.search.substring(1));t.map=new e("ymaps-map",{category:t.category,masterprice:!0}),t.initMap(null,{external:!1}),t.mapView.setBounds(n.bounds)}))},beforeShow:function(){t.resultsList.setLocked(!0),n=!1},beforeClose:function(){t.mapView.pause(),t.map&&t.map.destroyMap(),t.map=null,t.initMap(null)},afterClose:function(){t.resultsList.setLocked(!1),n&&t.sendStat()}})}))},initMapEvents:function(){var t=this;t.resultsPoints.on("query.refresh",(function(){this.setQuery(t.getQuery("points")),t.map&&t.map.setQuery(t.getQuery())})),t.resultsPoints.on("loaded",(function(n,o){var i=e("<div>"+n+"</div>"),a=t.getPoints(i),s=t.getRanges(i);t.hasGeo()&&(a&&a.length?t.mapView.setBounds(t.mapView.getBoundsByPoints(a)):s.bounds&&t.mapView.setBounds(s.bounds)),t.resultsPoints.trigger("afterLoaded",a,s),a&&1===o.page?t.mapView.updatePoints(t.smartPoints(a)):o.page>1&&t.mapView.updatePoints(t.smartPoints(t.mapView.points))}))},initResults:function(){var t=this;t.map&&(t.map.on("placemark.enter",(function(e){t.resultsList.highlightItem(e.getId(),!0)})).on("placemark.leave",(function(e){t.resultsList.highlightItem(e.getId(),!1)})),t.resultsList.on("highlight",(function(e,n){t.map.pushOnReady((function(){t.map.getPlacemark(e)&&t.map.setActive(t.map.getPlacemark(e),n)}))}))),t.resultsList.on("content.update",(function(n){var o=this;n.page>1&&(o.needScroll=!1),t._contentNeedsChange()&&(t.updateContent((function(e){e&&o.scrollToResults()})),e(".js-landing-list",t.node).closest(".js-catalog-wrapper").remove())})),t.resultsList.on("query.refresh",(function(){var e=t.getQuery("list");this.setQuery(e)})),t.resultsList.on("loaded",(function(n){var o=e("<div>"+n+"</div>"),i=t.getRanges(o);i.count_txt&&t.resultsList.updateResultsCount(i.count_txt),t._contentNeedsChange()||t.resultsList.scrollToResults(),t.filter&&t.filter.setRange(i.range),t.resultsList.trigger("afterLoaded",i)})),t.resultsList.trigger("query.refresh")},loadFromUrl:function(){var t,n=this,o=n._getQueryFromString(window.location.search.substring(1));n._getStringByQuery(o)&&(t=e.Deferred(),n.map&&n.map.pushOnReady((function(){o.center&&o.zoom&&(o.zoom=+o.zoom,o.center=[+o.center[0],+o.center[1]],n.mapView.setQuery({center:o.center,zoom:o.zoom}),n.mapView.boundsChanged=!0,n.mapView.setCenterAndZoom({center:o.center,zoom:o.zoom}),t.resolve())})),t.done((function(){n.resultsList.needScroll=!1,n.debouncedRequest()})))},preload:function(t){var n=this;e(".js-server-fake-filter",n.node).remove(),e(".filter-items-preload .filter-items-list",n.node).each((function(t){var o=e(this).data("filter");e(".filter-items-placeholder",n.node).filter(".js-filter-"+o+"-placeholder").append(this)})),t&&t.call(n),window.dispatchEvent(new Event("height"))},getQuery:function(e){var t=this,n=Object.assign({},t.baseFilter);Object.assign(n,s.getQuery());var o={};for(var i in n)!1!==n[i]&&(o[i]=n[i]);return e&&(Object.assign(o,t.getBoundsForQuery(e)),t.map&&Object.assign(o,t.mapView.getCenterAndZoom())),o},getBoundsForQuery:function(e){var t=this;if("list"===e){if(!t.hasGeo()&&t.mapView.boundsChanged&&t.map_linked_to_list)return{bounds:t.mapView.getBoundsForQuery()}}else if("points"===e&&!t.hasGeo()&&t.mapView.boundsChanged&&t.map_updated)return{bounds:t.mapView.getBoundsForQuery()};return{}},_getBaseUrl:function(){var e=this.urlBase;return this.filterTown&&this.filterTown.getQuery().town_id&&this.urlTown||e},_urlNeedsChange:function(){var e=this,t=e._getBaseUrl();return e.canChangeUrl&&t&&t!=location.protocol+"//"+location.host+location.pathname},_getStringByQuery:function(t){var n=0;for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&"search_query_form"!=o&&(""+t[o]).length&&n++;return n?e.param(t):""},_contentNeedsChange:function(){return this._urlNeedsChange()},_updateUrl:function(){var e=this,t=e._getBaseUrl(),n=Object.assign({},e.getQuery("url"),e.mapView.getQuery());e._urlNeedsChange()&&history.replaceState("",document.title,t),e.bounds_query&&e.mapView.boundsChanged&&n.center&&n.zoom&&Object.assign(n,{bounds:e.mapView.getBoundsForQuery()});var o=e._getStringByQuery(n);history.replaceState(null,null,"?"+o)},_getQueryFromString:function(e){var t={},n=decodeURIComponent(e.replace(/\+/g,"%20")).split("&");return n.length>1&&n.forEach((function(e){var n=e.split("="),o=n[0],i=isNaN(n[1])?0:n[1];~o.indexOf("[]")?(o=o.replace("[]",""),t.hasOwnProperty(o)||(t[o]=[]),t[o].push(i)):t[o]=i})),t},sendRequest:function(e){var t=this;return t.trigger("sendRequest",e),e.items&&(t.resultsList.trigger("query.refresh"),t.resultsList.load().done(t.RequestDone.bind(t))),e.points&&(t.resultsPoints.trigger("query.refresh"),t.resultsPoints.load().done(t.RequestDone.bind(t))),t},RequestDone:function(){this.filters.forEach((function(e){e.trigger("loaded")}))},hasGeo:function(){var e=0;for(var t in s.items){var n=s.items[t];"geo"===n.type&&'["town_id"]'!=JSON.stringify(n.kvs.map((function(e){return e.key})))&&e++}return e},clearGeo:function(e){var t=this;for(var n in(e=e||!1)||(t.mapView.boundsChanged=!0),s.items){var o=s.items[n];"geo"===o.type&&'["town_id"]'!=JSON.stringify(o.kvs.map((function(e){return e.key})))&&s.remove(n)}return e||t.mapView.setQuery(t.mapView.getCenterAndZoom()),t.debouncedRequest({items:!!t.map_linked_to_list,points:!0}),t},clearMap:function(){this.hasGeo()&&this.mapView.setQuery({})},clearTown:function(){s.removeType("geo"),this.urlContent=this._getBaseUrl()+"?action=content",this.debouncedRequest({items:!!this.map_linked_to_list,points:!0})},smartPoints:function(t){var n=this,o=n.$node.find(".js-results-item").map((function(){return e(this).data("id")})).toArray();return n.map&&n.map.setItems(o),t},extractBaseFilter:function(){var t=this,n=[],o=["city","category","distance_to","sort_order"],i={};for(var a in t.$node.find("[data-field]").each((function(){n.push(e(this).data("field"))})),t.$node.find("input[name], select[name]").each((function(){n.push(this.name)})),n.forEach((function(e){for(var n in t.query)(e==n||0==n.indexOf(e)&&"["==n.substr(e.length,1))&&o.push(n)})),t.query)-1===o.indexOf(a)&&(i[a]=t.query[a]);return i},updateContent:function(t){var n=this;n.urlContent?e.post(n.urlContent,n.getQuery(),(function(o){n.$node.find(".js-page-title").html(o.h1),n.$node.find(".js-content").html(o.content),o.headerCity&&e("#header").find(".js-header-city").html(o.headerCity),document.title=o.title,t&&t(o)})):t&&t()},activateFilter:function(e){var t=this;if(t.activeFilter){if(e===t.activeFilter)return;t.activeFilter.popupHide(),t.off("sendRequest",t.activeFilter["[[update]]"]),t.activeFilter.off("state-change",t.activeFilter["[[update]]"]),delete t.activeFilter["[[update]]"],t.activeFilter.trigger("cancel"),t.activeFilter.onCancel()}function n(n){if(e&&e.checkAvail&&e.popupLoaded){var o=t.resultsList.url;e.checkAvail({url:o,data:Object.assign({},t.getQuery("points")),reorderPassthrough:n||!1})}}t.activeFilter=e,e&&(e["[[update]]"]=n,t.on("sendRequest",n),e.on("state-change",(function(e,t){n("object"==typeof t&&t.is(":checkbox"))})),e.popupShadeList&&e.popupShadeList(),n(),e.popupUnShadeList&&e.popupUnShadeList())},debouncedRequest:function(e){e=e||{items:!0,points:!!this.map||!!this.minimap},this.requestParams.items=e.items||this.requestParams.items||!1,this.requestParams.points=e.points||this.requestParams.points||!1,this._debouncedRequest()},_debouncedRequest:debounce((function(){this.updateNeeded.items=!this.requestParams.items,this.updateNeeded.points=!this.requestParams.points,this.sendRequest(this.requestParams),this._updateUrl(),this.requestParams={}}),100),getPoints:function(t){var n=this,o=e("script.points",t);return o.length?(n.points=e.parseJSON(o.html()),o.remove(),n.points):n.points&&n.points.length>0?n.points:[]},getRanges:function(t){var n=this,o=e("script.ranges",t);return o.length?(n.ranges=e.parseJSON(o.html()),o.remove(),n.ranges):n.ranges&&n.ranges.length>0?n.ranges:[]},track:function(t,n,o){if(this.allow_stat_collect){var i=["filter",n,t];void 0!==o&&i.push(o),e(window).trigger("track-event",i)}}}),u}));