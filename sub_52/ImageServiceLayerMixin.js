//>>built
define("esri/layers/ImageServiceLayerMixin","dojo/_base/declare dojo/_base/lang dojo/_base/Deferred dojo/_base/array dojo/_base/json dojo/_base/config dojo/_base/connect dojo/has dojo/io-query dojo/DeferredList dojo/debounce ../kernel ../config ../lang ../request ../deferredUtils ../urlUtils ../geometry/Extent ../geometry/Point ../geometry/Polygon ../renderers/colorRampUtils ./MosaicRule ./RasterFunction ./DimensionalDefinition ./Raster ./PixelBlock ./pixelFilters/VectorFieldPixelFilter ./rasterFormats/ImageCanvasDecoder ./TimeInfo ./Field ../graphic ../tasks/ImageServiceIdentifyTask ../tasks/ImageServiceIdentifyParameters".split(" "),
function(T,k,C,q,F,O,ja,Da,pa,Ea,qa,ra,sa,K,H,A,Z,U,ta,ua,va,L,I,ka,wa,aa,la,xa,ya,za,Aa,Ba,Ca){T=T(null,{declaredClass:"esri.layers.ImageServiceLayerMixin",_rasterFieldPrefix:"Raster.",_renderingRuleFieldSubPrefix:"ServicePixelValue.",_rasterFunctionServiceInfoProps:"bandCount pixelType hasRasterAttributeTable hasColormap hasHistograms minValues maxValues meanValues stdvValues serviceDataType".split(" "),_pixelTypeRanges:{U1:[0,1],U2:[0,3],U4:[0,15],U8:[0,255],S8:[-128,127],U16:[0,65535],S16:[-32768,
32767]},_eventMap:{"rendering-change":!0,"mosaic-rule-change":!0,"spatial-reference-change":!0,"renderer-change":!0},_cachedVariableStats:{},_cachedVariableHistogram:{},constructor:function(a,b){this.useMapTime=b&&b.hasOwnProperty("useMapTime")?!!b.useMapTime:!0},_initialize:function(a,b){this._url=Z.urlToObject(a);this.raster=new wa(this._url.path);this._rasterFunctionTemplateInfos={};this._rasterFunctionTemplatePromise={};this._customRenderingRuleId={};this.infoTemplate=b&&b.infoTemplate;var c=
b&&b.imageServiceParameters;this.format=c&&c.format;this.compressionTolerance=c&&c.compressionTolerance?c.compressionTolerance:.01;this.interpolation=c?c.interpolation:null;this.compressionQuality=c?c.compressionQuality:null;this.bandIds=c?c.bandIds:null;this.mosaicRule=c?c.mosaicRule:null;this.renderingRule=c?c.renderingRule:null;this.renderer=c?c.renderer:null;this.useMapDimensionValue=b&&b.hasOwnProperty("useMapDimensionValue")?!!b.useMapDimensionValue:!0;this.hasImageFilter=b&&b.hasImageFilter;
this.activeMapDimensions=b&&b.activeMapDimensions;this._params=k.mixin({},this._url.query,{f:"image",interpolation:this.interpolation,format:this.format,compressionQuality:this.compressionQuality,bandIds:this.bandIds?this.bandIds.join(","):null},c?c.toJson():{});this.pixelFilter=b&&b.pixelFilter;this.originalPixelData=this.pixelData=null;this.hasDataChanged=!0;this._requestDataHandler=k.hitch(this,this._requestDataHandler);this._requestDataErrorHandler=k.hitch(this,this._requestDataErrorHandler);
this._rasterReadPromise=null;this._initLayer=k.hitch(this,this._initLayer);this._queryVisibleRastersHandler=k.hitch(this,this._queryVisibleRastersHandler);this._visibleRasters=[];this._rasterAttributeTableFields=[];this._rasterAttributeTableFeatures=[];this._renderingRuleAttributeTable={};this._renderingRuleColormap={};this._useRenderingRuleAttributeTable=!1;this._loadCallback=b&&b.loadCallback;c&&c.renderer&&(c.renderer.outputUnit||c.renderer.inputUnit)&&(this.vectorFieldPixelFilter=new la,this.vectorFieldPixelFilter.setUnits(c.renderer.inputUnit,
c.renderer.outputUnit));(c=b&&b.resourceInfo)?this._initLayer(c):H({url:this._url.path,content:k.mixin({f:"json"},this._url.query),callbackParamName:"callback",load:this._initLayer,error:this._errorHandler});this.registerConnectEvents()},disableClientCaching:!1,_initLayer:function(a,b){if(null!==a&&void 0!==a){this._findCredential();(this.credential&&this.credential.ssl||a&&a._ssl)&&this._useSSL();var c=this.minScale,d=this.maxScale;k.mixin(this,a);this.minScale=c;this.maxScale=d;this.initialExtent=
this.fullExtent=this.extent=new U(a.extent);this.spatialReference=this.initialExtent.spatialReference;this.pixelSizeX=parseFloat(this.pixelSizeX);this.pixelSizeY=parseFloat(this.pixelSizeY);var e=this.minValues,g=this.maxValues,f=this.meanValues,l=this.stdvValues,h=this.bands=[];c=0;for(d=this.bandCount;c<d;c++)h[c]={min:e[c],max:g[c],mean:f[c],stddev:l[c]};this.timeInfo=(c=this.timeInfo)&&c.timeExtent?new ya(c):null;d=this.fields=[];if(e=a.fields)for(c=0;c<e.length;c++)d.push(new za(e[c]));this._updateInfoTemplateFields(this.fields);
this.version=a.currentVersion;this.version||(this.version="fields"in a||"objectIdField"in a||"timeInfo"in a?10:9.3);K.isDefined(a.minScale)&&!this._hasMin&&"Raster"!==a.cacheType&&this.setMinScale(a.minScale);K.isDefined(a.maxScale)&&!this._hasMax&&"Raster"!==a.cacheType&&this.setMaxScale(a.maxScale);c={};a.defaultMosaicMethod?(c.method=a.defaultMosaicMethod,c.operation=a.mosaicOperator,c.sortField=a.sortField,c.sortValue=a.sortValue):c.method=L.METHOD_NONE;this.defaultMosaicRule=new L(c);this.defaultMosaicRule.ascending=
!0;this._useRenderingRuleAttributeTable=10<this.version&&"esriImageServiceDataTypeThematic"===this.serviceDataType;this._setDefaultRenderingRule(!0);this._getRenderingRuleAttributeTableAndColormap();this._isScientificData()&&(!this.mosaicRule||this.mosaicRule&&!this.mosaicRule.multidimensionalDefinition)&&this._setDefaultMultidimensionalDefinition(!0);10<this.version&&this.hasRasterAttributeTable&&this.getRasterAttributeTable().then(k.hitch(this,function(m){m&&(m.features&&m.fields&&(this.rasterAttributeTable=
k.clone(m)),m.features&&0<m.features.length&&(this._rasterAttributeTableFeatures=k.clone(m.features)),m.fields&&0<m.fields.length&&(this._rasterAttributeTableFields=k.clone(m.fields)),this.renderingRule||!this.renderer||"esri.renderer.ClassBreaksRenderer"!==this.renderer.declaredClass&&"esri.renderer.UniqueValueRenderer"!==this.renderer.declaredClass||this.refresh())}));this._initVectorPixelFilter();this.bandIds||2!==this.bandCount||this.renderingRule||"esri.layers.ArcGISImageServiceLayer"!==this.declaredClass||
this.setBandIds([0,0,0],!0);!(10.3<=this.version&&this.rasterFunctionInfos&&this.rasterFunctionInfos.length)||this._url.query&&this._url.query.raster||this.getRasterFunctionInfos().then(k.hitch(this,function(m){if(m&&m.length){this.rasterFunctionInfos=m;var u=[],r;q.forEach(m,function(n){if(n){var t=n.functionType;r=r||1===t||2===t;u.push(n.name)}},this);this._hasItemLevelRFT=r;this._rasterFunctionNames=u;r&&(this._initVectorPixelFilter(),this.refresh())}}));this.loaded=!0;this._setDefaultFilter();
this.onLoad(this);if(c=this._loadCallback)delete this._loadCallback,c(this)}},_updateInfoTemplateFields:function(a){if(a&&!(1>a.length)&&this.infoTemplate&&this.infoTemplate.info&&this.infoTemplate.info.fieldInfos&&!(1>this.infoTemplate.info.fieldInfos.length)){var b,c;var d=this.infoTemplate.info.fieldInfos;for(b=0;b<a.length;b++){var e=a[b];for(c=0;c<d.length;c++)if(d[c].fieldName.toLowerCase()===e.name.toLowerCase()&&d[c].fieldName!==e.name){d[c].fieldName=e.name;break}}}},getKeyProperties:function(a){var b=
this._url.path+"/keyProperties",c=new C(A._dfdCanceller),d={f:"json"};a&&a.renderingRule&&(d.renderingRule=F.toJson(a.renderingRule.toJson()));10<this.version?(c._pendingDfd=H({url:b,content:d,handleAs:"json",callbackParamName:"callback"}),c._pendingDfd.then(function(e){c.callback(e)},function(e){c.errback(e)})):(a=Error("Layer does not have key properties"),a.log=!!O.isDebug,c.errback(a));return c},getRasterAttributeTable:function(a){var b=this._url.path+"/rasterAttributeTable",c=new C(A._dfdCanceller),
d={f:"json"},e=this.hasRasterAttributeTable;a&&a.renderingRule&&(d.renderingRule=F.toJson(a.renderingRule.toJson()),e=!0);!this.loaded||10<this.version&&e?(c._pendingDfd=H({url:b,content:d,handleAs:"json",callbackParamName:"callback"}),c._pendingDfd.then(function(g){c.callback(g)},function(g){c.errback(g)})):(a=Error("Layer does not support raster attribute table"),a.log=!!O.isDebug,c.errback(a));return c},getRenderingRuleAttributeTable:function(a){var b=new C(A._dfdCanceller);if(!a||!a.renderingRule)return b.errback(Error("Rendering rule is not specified")),
b;a=a.renderingRule;var c=this._getRenderingRuleId(a);this._renderingRuleAttributeTable&&c&&this._renderingRuleAttributeTable.hasOwnProperty(c)?b.resolve(this._renderingRuleAttributeTable[c]):b=this.getRasterAttributeTable({renderingRule:a}).then(k.hitch(this,function(d){if(d&&d.features&&d.features.length&&d.fields&&d.fields.length){var e={features:k.clone(d.features),fields:k.clone(d.fields)};c&&(this._renderingRuleAttributeTable[c]=e)}return e}));return b},_initVectorPixelFilter:function(){var a;
this._hasItemLevelRFT&&this.renderingRule&&(a=this._getItemLevelRenderingRule(this.renderingRule));if(a=a||this.renderingRule)return this.getRenderingRuleServiceInfo(a).then(k.hitch(this,function(b){!b||!this._isVectorData(b)&&"esri.layers.ArcGISImageServiceVectorLayer"!==this.declaredClass||K.isDefined(this.pixelFilter)||(this.vectorFieldPixelFilter=this.vectorFieldPixelFilter||new la,this.vectorFieldPixelFilter.isDataUV="esriImageServiceDataTypeVector-UV"===b.serviceDataType,this.pixelFilter=this.vectorFieldPixelFilter.computeMagnitudeAndDirection,
this.getKeyProperties().then(k.hitch(this,this._setFlowRepresentation)),this._applyVectorResamplingType(b.serviceDataType))}))},_applyVectorResamplingType:function(a){if(a){var b=this.renderingRule;b&&"Resample"===b.functionName&&((b.functionArguments||{}).ResamplingType="esriImageServiceDataTypeVector-UV"===a?7:10,this.setRenderingRule(new I(b.toJson())))}},_getRasterAttributeTableFeatures:function(){var a=new C;if(this._rasterAttributeTableFeatures&&0<this._rasterAttributeTableFeatures.length)return a.resolve(this._rasterAttributeTableFeatures),
a;if(10<this.version&&this.hasRasterAttributeTable)return a=this.getRasterAttributeTable(),a.then(k.hitch(this,function(b){b&&b.features&&0<b.features.length&&(this._rasterAttributeTableFeatures=k.clone(b.features))})),a;a.resolve(this._rasterAttributeTableFeatures);return a},_getRenderingRuleAttributeTableFeatures:function(a){a=a&&a.renderingRule;return a?this.getRenderingRuleAttributeTable({renderingRule:a}).then(function(b){return b&&b.features}):(a=new C,a.errback(Error("Rendering rule is not specified")),
a)},_getRenderingRuleAttributeTableAndColormap:function(){this.renderingRule&&this.getRenderingRuleServiceInfo(this.renderingRule).then(k.hitch(this,function(a){a.hasRasterAttributeTable&&this.getRenderingRuleAttributeTable({renderingRule:this.renderingRule}).then(k.hitch(this,function(){!this.renderer||"esri.renderer.ClassBreaksRenderer"!==this.renderer.declaredClass&&"esri.renderer.UniqueValueRenderer"!==this.renderer.declaredClass||this.refresh()}));a.hasColormap&&this.getRenderingRuleColormap({renderingRule:this.renderingRule}).then(k.hitch(this,
function(){this.renderer&&"esri.renderer.ColormapRenderer"===this.renderer.declaredClass&&this.refresh()}))}))},getCustomRasterFields:function(a){var b=a?a.rasterAttributeTableFieldPrefix:this._rasterFieldPrefix;a=10.3<=this.version?"esriFieldTypeDouble":"esriFieldTypeString";var c={name:this._rasterFieldPrefix+"ItemPixelValue",alias:"Item Pixel Value",domain:null,editable:!1,length:50,type:a},d={name:this._rasterFieldPrefix+"ServicePixelValue",alias:"Service Pixel Value",domain:null,editable:!1,
length:50,type:a},e={name:this._rasterFieldPrefix+"ServicePixelValue.Raw",alias:"Raw Service Pixel Value",domain:null,editable:!1,length:50,type:"esriFieldTypeDouble"},g=this.fields?k.clone(this.fields):[];a=g.length;g[a]=d;10.4<=this.version&&"esri.layers.ArcGISImageServiceLayer"===this.declaredClass&&(!this.rasterFunctionInfos||!this.rasterFunctionInfos.length||this._isRenderingRuleAProcessingTemplate({functionName:"none"}))&&(a++,g[a]=e);if(this.capabilities&&-1<this.capabilities.toLowerCase().indexOf("catalog")||
this.fields&&0<this.fields.length)a++,g[a]=c;!K.isDefined(this.pixelFilter)||"esriImageServiceDataTypeVector-UV"!==this.serviceDataType&&"esriImageServiceDataTypeVector-MagDir"!==this.serviceDataType||(c={name:this._rasterFieldPrefix+"Magnitude",alias:"Magnitude",domain:null,editable:!1,type:"esriFieldTypeDouble"},d={name:this._rasterFieldPrefix+"Direction",alias:"Direction",domain:null,editable:!1,type:"esriFieldTypeDouble"},a++,g[a]=c,a++,g[a]=d);a=this._rasterAttributeTableFields;(c=this.renderingRule&&
this._getRenderingRuleId(this.renderingRule))&&this._renderingRuleAttributeTable&&this._renderingRuleAttributeTable.hasOwnProperty(c)&&(a=this._renderingRuleAttributeTable[c].fields);a&&0<a.length&&(a=q.filter(a,function(l){return"esriFieldTypeOID"!==l.type&&"value"!==l.name.toLowerCase()}),a=q.map(a,function(l){var h=k.clone(l);h.name=b+l.name;return h}),g=g.concat(a));var f=this._rasterFieldPrefix+this._renderingRuleFieldSubPrefix;10.4<=this.version&&this.rasterFunctionInfos&&q.forEach(this.rasterFunctionInfos,
function(l){l&&l.name&&"none"!==l.name.toLowerCase()&&(l={name:f+l.name.replace(/ /gi,"_"),alias:l.name,domain:null,editable:!1,type:"esriFieldTypeDouble"},g.push(l))});return g},_applyTimeToMultidimensionalCRF:function(a,b){var c=this._isTimeSupportedOnCRF();if(c&&(!a||!a.multidimensionalDefinition))return a;var d=this.timeInfo&&this.timeInfo.startTimeField;if((b=b||this._params.time)&&d&&this._isMultidimensionalCRF()){a=k.clone(a||this.defaultMosaicRule)||new L;a.multidimensionalDefinition=a.multidimensionalDefinition||
[];var e=a.multidimensionalDefinition.filter(function(f){return f.dimensionName===d}),g=b.split(",").map(function(f){return parseInt(f,10)});2===g.length&&g[0]===g[1]&&(g.length=1);0<e.length?c?a.multidimensionalDefinition.forEach(function(f){f.dimensionName===d&&(f.dimensionName=null,f.isSlice=null,f.values=null)}):a.multidimensionalDefinition.forEach(function(f){f.dimensionName===d&&(f.isSlice=1===g.length,f.values=1===g.length?g:[g])}):c||(a.multidimensionalDefinition.some(function(f){return null!=
f.variableName&&null==f.dimensionName})?a.multidimensionalDefinition.forEach(function(f){null!=f.variableName&&null==f.dimensionName&&(f.dimensionName=d,f.isSlice=1===g.length,f.values=1===g.length?g:[g])}):a.multidimensionalDefinition.push(new ka({variableName:"",dimensionName:d,isSlice:1===g.length,values:1===g.length?g:[g]})));this._cleanupMultidimensionalDefinition(a)}return a},_prepareGetImageParameters:function(a,b,c,d){d=K.isDefined(d)?d:this._params;if(this.renderer||this._hasItemLevelRFT&&
this.renderingRule){var e=this.getExportImageRenderingRule();d.renderingRule=e?F.toJson(e.toJson()):null}e=this.getExportImageMosaicRule(d);d.mosaicRule=e?F.toJson(e.toJson()):null;e=a.spatialReference.wkid||F.toJson(a.spatialReference.toJson(!1));delete d._ts;k.mixin(d,{bbox:a.xmin+","+a.ymin+","+a.xmax+","+a.ymax,imageSR:e,bboxSR:e,size:b+","+c},this.disableClientCaching?{_ts:(new Date).getTime()}:{});delete d.compressionTolerance;d.format&&"LERC"===d.format.toUpperCase()&&(d.compressionTolerance=
this.compressionTolerance);d.token=this._getToken()},getImageUrl:function(a,b,c,d,e){e=K.isDefined(e)?e:this._params;this._prepareGetImageParameters(a,b,c,e);a=k.clone(e);this._cleanupRequestParams(a);b=this._url.path+"/exportImage?";c=Z.addProxy(b+pa.objectToQuery(k.mixin(a,{f:"image"})));var g=a.token;c.length>sa.defaults.io.postLength||this.useMapImage?this._jsonRequest=H({url:b,content:k.mixin(a,{f:"json"}),callbackParamName:"callback",load:function(f,l){var h=f.href;g&&(h+=-1===h.indexOf("?")?
"?token\x3d"+g:"\x26token\x3d"+g);d(Z.addProxy(h))},error:this._errorHandler}):d(c)},onRenderingChange:function(){},onMosaicRuleChange:function(){},onRendererChange:function(){},setInterpolation:function(a,b){this.interpolation=this._params.interpolation=a;b||this.refresh(!0)},setCompressionQuality:function(a,b){this.compressionQuality=this._params.compressionQuality=a;b||this.refresh(!0)},setCompressionTolerance:function(a,b){this.compressionTolerance=a;b||this.refresh(!0)},setBandIds:function(a,
b){var c=!1;this.bandIds!==a&&(c=!0);this.bandIds=a;this._params.bandIds=a?a.join(","):null;if(c&&!b)this.onRenderingChange();b||this.refresh(!0)},setDefaultBandIds:function(a){this.bandIds=this._params.bandIds=null;a||this.refresh(!0)},setDisableClientCaching:function(a){this.disableClientCaching=a},setMosaicRule:function(a,b){var c=!1;this.mosaicRule!==a&&(c=!0);this.mosaicRule=a;this._params.mosaicRule=F.toJson(a.toJson());if(c&&!b)this.onMosaicRuleChange();b||this.refresh(!0)},getRasterFunctionInfos:function(){if(!(10.3>
this.version)&&this.rasterFunctionInfos&&this.rasterFunctionInfos.length)return H({url:this._url.path+"/rasterFunctionInfos",content:{f:"json"},handleAs:"json",load:function(a){return a&&a.rasterFunctionInfos}})},setRenderingRule:function(a,b){var c=!1;this.renderingRule!==a&&(c=!0);this.renderingRule=a;this._params.renderingRule=a?F.toJson(a.toJson()):null;this._useRenderingRuleAttributeTable?this.getRenderingRuleAttributeTable({renderingRule:a}):"esri.layers.RasterXLayer"!==this.declaredClass&&
this._getRenderingRuleAttributeTableAndColormap();if(c)this.onRenderingChange();this._setDefaultFilter();b||this.refresh(!0)},setImageFormat:function(a,b){this.format=this._params.format=a;this._setDefaultFilter();b||this.refresh(!0)},setInfoTemplate:function(a){this.infoTemplate=a;this._updateInfoTemplateFields(this.fields)},setDefinitionExpression:function(a,b){var c=this.mosaicRule?this.mosaicRule.toJson():{};this.mosaicRule||(this.defaultMosaicRule?c=this.defaultMosaicRule.toJson():c.method=L.METHOD_NONE);
c.where=a;c=new L(c);this.setMosaicRule(c,b);return this},getDefinitionExpression:function(){return this.mosaicRule?this.mosaicRule.where:null},setPixelFilter:function(a){this.pixelFilter=a;this._isDefaultPixelFilter=!1},getPixelData:function(a){return a?(this._useBrowserDecoding()&&(this.originalPixelData={pixelBlock:this._getPixelBlockFromCanvas(this._context,this._map.width,this._map.height),extent:this._map.extent}),this.originalPixelData):this.pixelData},getExportImageRenderingRule:function(){var a;
this._hasItemLevelRFT&&this.renderingRule&&(a=this._getServiceLevelRenderingRule(this.renderingRule));a=a||this.renderingRule;this._isItemLevelRasterFunction(this.renderingRule)&&(a=void 0);return this._combineRenderingRule(this._convertRendererToRenderingRule(this.renderer),a)},getExportImageMosaicRule:function(){var a=this.mosaicRule,b;this._hasItemLevelRFT&&this.renderingRule&&(b=this._getItemLevelRenderingRule(this.renderingRule));b&&(a=a||this.defaultMosaicRule||new L,a.itemRenderingRule=b);
return a=this._applyTimeToMultidimensionalCRF(a)},redraw:function(){this.hasDataChanged=!1;this._setPixelData(this.originalPixelData)},getHistograms:function(a){var b=a.variableName,c=(a=(a=a.renderingRule||this.renderingRule||this.defaultRenderingRule)&&"none"!==a.functionName.toLowerCase()?a.toJson():null)?a.functionName:"",d=new C(A._dfdCanceller);if((b||""===b)&&this._cachedVariableHistogram[b]&&this._cachedVariableHistogram[b][c])return d.resolve(this._cachedVariableHistogram[b][c]),d;if(this.hasHistograms){var e=
{f:"json"};b&&(e.variable=b);a&&10.9<this.version&&(e.renderingRule=JSON.stringify(a));d._pendingDfd=H({url:this._url.path+"/histograms",content:e,handleAs:"json",callbackParamName:"callback"});d._pendingDfd.then(k.hitch(this,function(g){if(b||""===b)this._cachedVariableHistogram[b]=this._cachedVariableHistogram[b]||{},this._cachedVariableHistogram[b][c]=g;d.callback(g)}),function(g){d.errback(g)})}else a=Error("Layer does not have histograms."),a.log=!!O.isDebug,d.errback(a);return d},computeHistograms:function(a){var b=
new C(A._dfdCanceller);if(10.1<=this.currentVersion){a=a||{};var c=a.geometry||this.fullExtent,d=(a.geometry||this.fullExtent).toJson();c="extent"===c.type?"esriGeometryEnvelope":"esriGeometryPolygon";var e=a.renderingRule||this.renderingRule||this.defaultRenderingRule;e=e?e.toJson():null;var g=a.mosaicRule||this.mosaicRule||this.defaultMosaicRule;g=g?g.toJson():null;a=a.pixelSize||{x:this.pixelSizeX,y:this.pixelSizeY};b._pendingDfd=H({url:this._url.path+"/computeHistograms",content:k.mixin({f:"json",
geometry:JSON.stringify(d),geometryType:c,renderingRule:JSON.stringify(e),mosaicRule:JSON.stringify(g),pixelSize:JSON.stringify(a),callbackParamName:"callback"}),handleAs:"json"});b._pendingDfd.then(function(f){b.callback(f)},function(f){b.errback(f)})}else d=Error("Layer doesn't support computeHistograms."),d.log=!!O.isDebug,b.errback(d);return b},getRenderingRuleServiceInfo:function(a,b){function c(g){return g.name&&g.arguments&&g["function"]&&g.hasOwnProperty("functionType")}var d=new A._fixDfd(new C(A._dfdCanceller));
if(!a)return d.errback(Error("Rendering rule is not specified")),d;if(c(a))"ClipFunction"===a["function"].type&&(a=this._handleClipFunctionInRenderingRule(a));else{var e=this._getRenderingRuleId(a);if(e){if(this._rasterFunctionTemplateInfos[e])return d.resolve(this._rasterFunctionTemplateInfos[e]),d;if(this._rasterFunctionTemplatePromise[e])return d=this._rasterFunctionTemplatePromise[e]}}d=H({url:this._url.path,content:k.mixin(k.mixin({f:"json",renderingRule:JSON.stringify(a.toJson())},this._url.query)),
callbackParamName:"callback",load:k.hitch(this,function(g){var f={};q.forEach(this._rasterFunctionServiceInfoProps,function(l){f[l]=g[l]});c(a)||(this._rasterFunctionTemplateInfos[e]=f);return f}),error:b||this._errorHandler});e&&!this._rasterFunctionTemplatePromise[e]&&(this._rasterFunctionTemplatePromise[e]=d);return d},queryVisibleRasters:function(a,b,c,d){var e=this._map,g=A._fixDfd(new C(A._dfdCanceller));this._visibleRasters=[];var f,l,h=!0,m=!0,u=null,r=this.infoTemplate?this.infoTemplate.info:
null,n=r?k.clone(this.infoTemplate.info.fieldInfos):null;b=b||{};if(r&&this.infoTemplate.info.mediaInfos&&this.infoTemplate.info.mediaInfos.length){var t=[];q.forEach(this.infoTemplate.info.mediaInfos,function(p){t=t.concat(p&&p.value&&p.value.fields||[])});t.length&&q.forEach(n,function(p){p&&-1<t.indexOf(p.fieldName)&&(p.visible=!0)})}var B=function(p){var J=r&&r.title&&-1<r.title.toLowerCase().indexOf(p.toLowerCase());p=r&&r.description&&-1<r.description.toLowerCase().indexOf(p.toLowerCase());
return J||p};if(n&&0<n.length)for(h=!1,f=0;f<n.length;f++)if((l=n[f])&&l.fieldName.toLowerCase()!==this._rasterFieldPrefix.toLowerCase()+"servicepixelvalue"&&(l.visible||B(l.fieldName))){h=!0;break}this.infoTemplate&&this.infoTemplate.info&&this.infoTemplate.info.layerOptions&&this.infoTemplate.info.layerOptions.hasOwnProperty("returnTopmostRaster")&&(u=this.infoTemplate.info.layerOptions.returnTopmostRaster?1:null);n&&0<n.length&&(m=!1,q.some(n,function(p){if(p&&p.fieldName.toLowerCase()===this._rasterFieldPrefix.toLowerCase()+
"itempixelvalue"&&p.visible)return m=!0},this),B(this._rasterFieldPrefix.toLowerCase()+"itempixelvalue")&&(m=!0));var D=(l=this._removeVisualizationStretchFunction(this.renderingRule))&&l.functionName,E=[];if(10.4<=this.version){var w=!1;if(this.rasterFunctionInfos&&n){var G=this._rasterFieldPrefix+this._renderingRuleFieldSubPrefix;q.forEach(this.rasterFunctionInfos,function(p){var J=G+p.name.replace(/ /gi,"_");q.some(n,function(V){return V.visible&&V.fieldName===J})&&(w=w||D&&D===p.name,E.push(new I({rasterFunction:p.name})))})}l&&
!w&&E.push(l)}f=new Ca;f.geometry=a.geometry;f.returnGeometry=this._map.spatialReference.equals(this.spatialReference);f.returnCatalogItems=h;f.timeExtent=this.timeInfo?a.timeExtent:null;f.returnPixelValues=m;f.maxItemCount=u||a.maxItemCount;this._params.time&&this.mosaicRule?(a=k.clone(this.mosaicRule),a=this._filterOutTimeDimension(a),f.mosaicRule=a):f.mosaicRule=this.mosaicRule||null;this._isMultidimensionalCRF()&&f.timeExtent&&(f.mosaicRule=this._applyTimeToMultidimensionalCRF(f.mosaicRule,f.timeExtent.toJson().join(",")),
this._isTimeSupportedOnCRF()||delete f.timeExtent);f.renderingRule=10.4>this.version&&l||null;f.renderingRules=E||null;10.8>this.version&&(f.returnPixelValues=void 0,f.maxItemCount=void 0);e&&(e=new ta((e.extent.xmax-e.extent.xmin)/e.width,(e.extent.ymax-e.extent.ymin)/e.height,e.extent.spatialReference),f.pixelSize=e);b.requestParams=f;var v=this;e=new Ba(this.url);(g._pendingDfd=e.execute(f)).addCallbacks(function(p){v._queryVisibleRastersHandler(p,b,c,d,g)},function(p){v._resolve([p],null,d,g,
!0)});return g},_queryVisibleRastersHandler:function(a,b,c,d,e){function g(){var x=this.getCustomRasterFields(b),P=this._getDomainFields(x),ba=b?b.returnDomainValues:!1,ma=b&&b.rasterAttributeTableFieldPrefix,M,ca,W,da,N,X,na,ea,fa,ha;x=(x=this._getRenderingRuleId(this.renderingRule))&&this._rasterFunctionTemplateInfos[x];this.renderingRule&&(this._useRenderingRuleAttributeTable||x)?(x=this._getRenderingRuleAttributeTableFeatures({renderingRule:this.renderingRule}),this.hasRasterAttributeTable||(ha=
f)):x=this._getRasterAttributeTableFeatures();x.then(k.hitch(this,function(ia){for(M=0;M<v.length;M++){z=v[M];z.setInfoTemplate(this.infoTemplate);z._layer=this;if(f){fa=f.replace(/ /gi,"").split(",");ca=f;W=fa;p&&p.length>=M&&(ca=p[M].replace(/ /gi,", "),W=p[M].split(" "));z.attributes[this._rasterFieldPrefix+"ItemPixelValue"]=W;z.attributes[this._rasterFieldPrefix+"ServicePixelValue"]=fa;l&&(z.attributes[this._rasterFieldPrefix+"ServicePixelValue.Raw"]=l.replace(/ /gi,"").split(","));if(this.pixelFilter){var Y=
new aa({height:1,width:1,pixelType:"F32",pixels:[],statistics:[]});q.forEach(W,function(y){Y.addData({pixels:[y],statistics:{minValue:y,maxValue:y,noDataValue:null}})});this.pixelFilter({pixelBlock:Y,extent:new U(0,0,0,0,this._map.spatialReference)});if("esriImageServiceDataTypeVector-UV"===this.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===this.serviceDataType)z.attributes[this._rasterFieldPrefix+"Magnitude"]=Y.pixels[0][0],z.attributes[this._rasterFieldPrefix+"Direction"]=Y.pixels[1][0]}q.forEach(n,
function(y){z.attributes[y.name]=y.value});var oa=0<this.fields.length?ha||ca:ha||l;if(ia&&0<ia.length&&(da=q.filter(ia,function(y){if(y&&y.attributes)return y.attributes.hasOwnProperty("Value")?y.attributes.Value==oa:y.attributes.VALUE==oa}),0<da.length&&(N=k.clone(da[0]),ma&&N))){ea={};for(X in N.attributes)N.attributes.hasOwnProperty(X)&&(na=ma+X,ea[na]=N.attributes[X]);N.attributes=ea;z.attributes=k.mixin(z.attributes,N.attributes)}}ba&&P&&0<P.length&&q.forEach(P,function(y){if(y){var Q=z.attributes[y.name];
K.isDefined(Q)&&(Q=this._getDomainValue(y.domain,Q),K.isDefined(Q)&&(z.attributes[y.name]=Q))}},this);R.push(z);this._visibleRasters.push(z)}this._resolve([R,null,!0],null,c,e)}))}var f=a.value,l=a.value,h=0,m=0,u=this,r=this.objectIdField,n=[];d=b.requestParams.renderingRules;var t=a.processedValues,B=this.renderingRule&&F.toJson(this._removeVisualizationStretchFunction(this.renderingRule).toJson());if(d&&t&&d.length===t.length){var D=this._rasterFieldPrefix+this._renderingRuleFieldSubPrefix;q.forEach(d,
function(x,P){if(x.functionName){var ba={name:D+x.functionName.replace(/ /gi,"_"),value:t[P].replace(/ /gi,"").split(",")};n.push(ba);B&&B===F.toJson(x.toJson())&&(f=t[P])}})}d=this.infoTemplate&&this.infoTemplate.info&&this.infoTemplate.info.layerOptions&&this.infoTemplate.info.layerOptions.hasOwnProperty("showNoDataRecords")?this.infoTemplate.info.layerOptions.showNoDataRecords:!0;if(a.catalogItems){var E=0,w=a.catalogItems.features.length;var G=0;var v=Array(w);var p=Array(w);var J=Array(w);if(a.properties&&
a.properties.Values){w=a.properties.Values.length;for(h=0;h<w;h++)-1<a.properties.Values[h].toLowerCase().indexOf("nodata")&&G++;var V=w-G;for(h=0;h<w;h++){G=!0;if(-1<a.properties.Values[h].toLowerCase().indexOf("nodata")){var S=V++;d||(G=!1,v.length--,p.length--,J.length--)}else S=E++;G&&(v[S]=a.catalogItems.features[h],p[S]=a.properties.Values[h],J[S]=v[S].attributes[r])}}else{for(h=0;h<w;h++)v[h]=a.catalogItems.features[h],J[h]=v[h].attributes[r];p=null}}this._visibleRasters=[];(a=-1<f.toLowerCase().indexOf("nodata"))&&
!d&&(v=[],p=[],J=[]);if(f&&!v&&!a){r="ObjectId";v=[];var z=new Aa(new U(this.fullExtent),null,{ObjectId:0});v.push(z)}var R=[];v?!this._map.spatialReference.equals(this.spatialReference)&&J&&0<J.length?H({url:this._url.path+"/query",content:{f:"json",objectIds:J.join(","),returnGeometry:!0,outSR:F.toJson(u._map.spatialReference.toJson()),outFields:r},handleAs:"json",callbackParamName:"callback",load:function(x){if(0===x.features.length)u._resolve([R,null,null],null,c,e);else{for(h=0;h<x.features.length;h++)for(m=
0;m<v.length;m++)v[m].attributes[r]==x.features[h].attributes[r]&&(v[m].geometry=new ua(x.features[h].geometry),v[m].geometry.setSpatialReference(u._map.spatialReference));g.call(u)}},error:function(x){u._resolve([R,null,null],null,c,e)}}):g.call(this):this._resolve([R,null,null],null,c,e)},getVisibleRasters:function(){var a=this._visibleRasters,b=[],c;for(c in a)a.hasOwnProperty(c)&&b.push(a[c]);return b},_getDomainFields:function(a){if(a){var b=[];q.forEach(a,function(c){if(c.domain){var d={};d.name=
c.name;d.domain=c.domain;b.push(d)}});return b}},_getDomainValue:function(a,b){if(a&&a.codedValues){var c;q.some(a.codedValues,function(d){return d.code===b?(c=d.name,!0):!1});return c}},_requestData:function(a,b,c){this._rasterReadPromise&&this._rasterReadPromise.cancel();a=k.clone(a);var d=a._normalize(!0);this._prepareGetImageParameters(d,b,c);b=k.clone(this._params);this._cleanupRequestParams(b);b.extent=a;b.format=b.format||(10.3<=this.version?"lerc":"jpgpng");"lerc"===b.format.toLowerCase()&&
!b.lercVersion&&10.5<=this.version&&(b.lercVersion=2);this._params.time&&this._isMultidimensionalCRF()&&!this._isTimeSupportedOnCRF()&&delete b.time;c=null;this._useBrowserDecoding()&&(c=new xa({ctx:this._context}));b={imageServiceParameters:b,nBands:Math.min(this.bandCount,3),pixelType:this.pixelType,decodeFunc:c?k.hitch(c,"decode"):null};this._rasterReadPromise=this.raster.read(b,this._requestDataHandler,this._requestDataErrorHandler)},_requestDataHandler:function(a){this._rasterReadPromise&&this._rasterReadPromise.isCanceled()||
(this.originalPixelData=a,this.hasDataChanged=!0,this._setPixelData(a))},_setPixelData:function(a){a=this._clonePixelData(a);this.pixelFilter&&this.pixelFilter(a);this.pixelData=a;this._rasterReadPromise&&this._rasterReadPromise.isCanceled()||(this._drawPixelData(),this._rasterReadPromise=null)},_clonePixelData:function(a){if(null===a||void 0===a)return a;var b={};a.extent&&(b.extent=k.clone(a.extent));a=a.pixelBlock;if(null===a||void 0===a)return b;b.pixelBlock=a.clone();return b},_setDefaultFilter:function(){},
_getPixelBlockFromCanvas:function(a,b,c){a=a.getImageData(0,0,b,c).data;var d=b*c,e=0,g=0,f=new Uint8Array(d),l=new Uint8Array(d),h=new Uint8Array(d),m=new Uint8Array(d),u=Infinity,r=Infinity,n=Infinity,t=-Infinity,B=-Infinity,D=-Infinity;for(e=0;e<d;e++){var E=a[g++];var w=a[g++];var G=a[g++];u=u<E?u:E;t=t>E?t:E;r=r<w?r:w;B=B>w?B:w;n=n<G?n:G;D=D>G?D:G;f[e]=E;l[e]=w;h[e]=G;m[e]=a[g++]&1}return new aa({width:b,height:c,pixels:[f,l,h],pixelType:"U8",mask:m,statistics:[{minValue:u,maxValue:t},{minValue:r,
maxValue:B},{minValue:n,maxValue:D}]})},_useBrowserDecoding:function(){return(void 0===this.pixelFilter||null===this.pixelFilter)&&("jpeg"===this.format.toLowerCase()||"jpg"===this.format.toLowerCase()||-1<this.format.toLowerCase().indexOf("png"))},getMultidimensionalInfo:function(){var a=this._url.path+"/multiDimensionalInfo",b=new C(A._dfdCanceller);if(this._multidimensionalInfo)return b.resolve(this._multidimensionalInfo),b;!this.loaded||10.3<=this.version&&this.hasMultidimensions?(b._pendingDfd=
H({url:a,content:{f:"json"},handleAs:"json",callbackParamName:"callback"}),b._pendingDfd.then(k.hitch(this,function(c){this._multidimensionalInfo=c.multidimensionalInfo;b.callback(c.multidimensionalInfo)}),function(c){b.errback(c)})):(a=Error("Layer does not support multidimensional info"),a.log=!!O.isDebug,b.errback(a));return b},getStatistics:function(a){var b=new C(A._dfdCanceller);if(a&&this._cachedVariableStats[a])b.resolve(this._cachedVariableStats[a]);else{var c={f:"json"};a&&(c.variable=a);
b._pendingDfd=H({url:this._url.path+"/statistics",content:c,handleAs:"json",callbackParamName:"callback"});b._pendingDfd.then(k.hitch(this,function(d){d=d.statistics||d.statitsics;var e=[];d&&d[0]&&null!=d[0].min?d.forEach(function(g){e.push([g.min,g.max,g.mean,g.standardDeviation])}):e=this.minValues&&this.minValues.length?this.minValues.map(function(g,f){return[g,this.maxValues[f],this.meanValues[f],this.stdvValues[f]]}.bind(this)):d;a&&(this._cachedVariableStats[a]=e);b.callback(e)}),function(d){b.errback(d)})}return b},
getDefaultMultidimensionalDefinition:function(){var a=new C(A._dfdCanceller);if(this._defaultMultidimensionalDefinition)return a.resolve(k.clone(this._defaultMultidimensionalDefinition)),a;a._pendingDfd=this.getMultidimensionalInfo();a._pendingDfd.then(k.hitch(this,function(b){b=this._getDefaultMultidimensionalDefinition(b);a.callback(b)}),function(b){a.errback(b)});return a},_getDefaultMultidimensionalDefinition:function(a,b,c){var d,e=[],g=this.defaultVariable||this.raster&&this.raster.defaultVariable;
variableName=g||"";dimensions=variableName.length?a.variables.filter(function(f){return f.name===variableName})[0].dimensions:a.variables[0].dimensions;c&&(variableName=g||a.variables[0].name);for(d in dimensions)dimensions.hasOwnProperty(d)&&(b||"StdTime"!==dimensions[d].name)&&(a=dimensions[d],e.push(new ka({variableName:variableName,dimensionName:a.name,isSlice:!a.hasRanges,values:[this._getDefaultDimensionValue(a)]})));this._defaultMultidimensionalDefinition=e;return k.clone(e)},_getDefaultDimensionValue:function(a){if(a&&
a.values&&a.values.length){var b=Infinity,c;if(a.hasRanges)return a.values[0];if(a.name&&"stdz"===a.name.toLowerCase()){for(c=0;c<a.values.length;c++){var d=a.values[c];var e=Math.abs(d-0);if(e<b){b=e;var g=d}if(0===e)break}return g}return a.extent[0]}},_setDefaultMultidimensionalDefinition:function(a){var b,c={};this.getDefaultMultidimensionalDefinition().then(k.hitch(this,function(d){b=d;0<b.length&&(this.mosaicRule?(c=k.clone(this.mosaicRule),c.multidimensionalDefinition=b):this.defaultMosaicRule?
(c=k.clone(this.defaultMosaicRule),c.multidimensionalDefinition=b):c=new L({multidimensionalDefinition:b}),this.setMosaicRule(c,a))}))},_setDefaultRenderingRule:function(a){var b={},c=this.renderingRule;if(!c&&"esri.layers.ArcGISImageServiceVectorLayer"!==this.declaredClass&&!this.bandIds&&this.rasterFunctionInfos&&this.rasterFunctionInfos.length&&"none"!==this.rasterFunctionInfos[0].name.toLowerCase())b.rasterFunction=this.rasterFunctionInfos[0].name;else if("esri.layers.ArcGISImageServiceVectorLayer"===
this.declaredClass&&10.3<this.version&&(!c||"Resample"!==c.functionName)){var d="esriImageServiceDataTypeVector-UV"===this.serviceDataType?7:10;b.rasterFunction="Resample";b.rasterFunctionArguments={ResamplingType:d,InputCellSize:{x:this.pixelSizeX,y:this.pixelSizeY}};c&&(b.rasterFunctionArguments.Raster=c.toJson())}b.hasOwnProperty("rasterFunction")&&(this.defaultRenderingRule=new I(b),this.setRenderingRule(this.defaultRenderingRule,a))},_cleanupRequestParams:function(a){if(!a)return a;if(a.time&&
a.mosaicRule){var b=new L(F.fromJson(a.mosaicRule));b=this._filterOutTimeDimension(b);a.mosaicRule=F.toJson(b.toJson())}b="displayOnPan drawMode styling id opacity visible resourceInfo useMapDimensionValue extent renderer".split(" ");for(var c in b)a.hasOwnProperty(b[c])&&delete a[b[c]];return a},_filterOutTimeDimension:function(a){if(this._isMultidimensionalCRF())return a;if(a&&a.multidimensionalDefinition&&0<a.multidimensionalDefinition.length){var b=q.filter(a.multidimensionalDefinition,function(c){return"StdTime"!==
c.dimensionName});a.multidimensionalDefinition=b}return a},_removeVisualizationStretchFunction:function(a){var b=a&&a.functionName;if(!b||"stretch"!==b.toLowerCase())return a;var c=a.functionArguments.Raster;return c&&c.functionName&&q.some(this.rasterFunctionInfos,function(d){return c.functionName===d.name})?c:a},_isMultidimensionalCRF:function(){return 10.71<=this.version&&this.hasMultidimensions&&this.timeInfo&&!(this.objectIdField&&this.fields&&1<this.fields.length)},_isTimeSupportedOnCRF:function(){return 10.8<=
this.version},_cleanupMultidimensionalDefinition:function(a){a&&a.multidimensionalDefinition&&(a.multidimensionalDefinition=a.multidimensionalDefinition.filter(function(b){return!(!b.variableName&&!b.dimensionName)}),0===a.multidimensionalDefinition.length&&(a.multidimensionalDefinition=null))},_isScientificData:function(){return"esriImageServiceDataTypeVector-UV"===this.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===this.serviceDataType||"esriImageServiceDataTypeScientific"===this.serviceDataType||
this.hasMultidimensions},_isVectorData:function(a){a=(a=a||this)&&a.serviceDataType;return"esriImageServiceDataTypeVector-UV"===a||"esriImageServiceDataTypeVector-MagDir"===a},_isRenderingRuleAProcessingTemplate:function(a){var b=a&&a.functionName;return!b||a.functionArguments?!1:q.some(b&&(this.rasterFunctionInfos||[]),function(c){return c&&c.name&&c.name.toLowerCase()===b.toLowerCase()})},_getRenderingRuleId:function(a){var b=a&&a.functionName;if(b){if(this._isRenderingRuleAProcessingTemplate(a))return b;
var c=this._customRenderingRuleId[b];if(c){if(c!==a){for(var d in this._customRenderingRuleId)if(this._customRenderingRuleId[d]===a)return d;for(c=0;this._customRenderingRuleId[e];)c+=1;var e;this._customRenderingRuleId[b+c]=a}}else this._customRenderingRuleId[b]=a;return b}},_createPixelData:function(a){a=new aa({width:2,height:2,pixels:a,pixelType:this.pixelType,statistics:a});var b=this.fullExtent.getCenter();b=new U(b.x,b.y,b.x+this.pixelSizeX,b.y+this.pixelSizeY,this.spatialReference);return{pixelBlock:a,
extent:b}},_convertRendererToRenderingRule:function(a){var b=a&&a.declaredClass;if(!b||"esri.renderer.UniqueValueRenderer"!==b&&"esri.renderer.ClassBreaksRenderer"!==b&&"esri.renderer.StretchRenderer"!==b&&"esri.renderer.ShadedReliefRenderer"!==b&&"esri.renderer.ColormapRenderer"!==b)return null;var c=null;"esri.renderer.StretchRenderer"===b?c=a.toRenderingRule({convertToColormap:10.6>this.version}):"esri.renderer.ClassBreaksRenderer"===b?c=this._convertClassifyRenderer(a):"esri.renderer.UniqueValueRenderer"===
b?c=this._convertUniqueValueRenderer(a):"esri.renderer.ShadedReliefRenderer"===b?c=this._convertShadedReliefRenderer(a):"esri.renderer.ColormapRenderer"===b&&(c=this._convertColormapRenderer(a));return c},_getValueField:function(a){if(a&&a.length){var b,c;q.some(a,function(d){if((c=d.name)&&"value"===c.toLowerCase())return b=c,!0});return b}},_convertColormapRenderer:function(a){var b=new I;b.functionName="Colormap";b.functionArguments={};a=a.colormapInfos.map(function(c){return[c.value].concat(c.color)});
b.functionArguments.Colormap=a;return b},_convertShadedReliefRenderer:function(a){var b=new I;b.functionName="Hillshade";var c="traditional"===a.hillshadeType?0:1,d="none"===a.scalingType?1:3,e={HillshadeType:c,SlopeType:d,ZFactor:a.zFactor};0===c&&(e.Azimuth=a.azimuth,e.Altitude=a.altitude);3===d&&(e.PSPower=a.pixelSizePower,e.PSZFactor=a.pixelSizeFactor);b.functionArguments=e;b.variableName="Raster";a.colorRamp&&(b.functionName="ShadedRelief",e.Colormap=va.convertColorRampToColormap(a.colorRamp,
256));return b},_convertClassifyRenderer:function(a){var b=[],c=[],d=[],e=[],g;var f=this.renderingRule&&this._getRenderingRuleId(this.renderingRule);var l=this.hasRasterAttributeTable;if(f){l=this._rasterFunctionTemplateInfos[f]?this._rasterFunctionTemplateInfos[f].hasRasterAttributeTable:this.hasRasterAttributeTable;var h=this._renderingRuleAttributeTable[f];var m=this._rasterFunctionTemplateInfos[f]}var u=h&&h.features?h.features:this._rasterAttributeTableFeatures;var r=this._getValueField(h&&
h.fields?h.fields:this._rasterAttributeTableFields);l&&u?(q.forEach(a.infos,function(n,t){var B,D=n.symbol.color;D.a&&q.forEach(u,function(E){B=E.attributes[a.attributeField];(B>=n.minValue&&B<n.maxValue||t===a.infos.length-1&&B>=n.minValue)&&e.push([E.attributes[r],D.r,D.g,D.b])},this)},this),f=m&&m.pixelType||this.pixelType,this._adjustColormapToPixelTypeRange(e,f),f=new I,f.functionName="Colormap",f.functionArguments={},f.functionArguments.Colormap=e,f.variableName="Raster"):(q.forEach(a.infos,
function(n,t){g=n.symbol&&n.symbol.color;g.a?(0===t?b.push.call(b,n.minValue,n.maxValue+1E-4):b.push.call(b,n.minValue+1E-4,n.maxValue+1E-4),c.push(t),e.push([t,g.r,g.g,g.b])):d.push(n.minValue,n.maxValue)}),f=m&&m.pixelType||this.pixelType,this._adjustColormapToPixelTypeRange(e,f),f=new I,f.functionName="Remap",f.functionArguments={InputRanges:b,OutputValues:c,NoDataRanges:d},f.variableName="Raster",h=new I,h.functionName="Colormap",h.functionArguments={Colormap:e,Raster:f},f=h);return f},_convertUniqueValueRenderer:function(a){var b=
[],c=this.renderingRule&&this._getRenderingRuleId(this.renderingRule);if(c){var d=this._renderingRuleAttributeTable[c];var e=this._rasterFunctionTemplateInfos[c]}var g=d&&d.features?d.features:this._rasterAttributeTableFeatures;var f=(c=d&&d.fields?d.fields:this._rasterAttributeTableFields)&&c.length?this._getValueField(c):"Value";q.forEach(a.infos,function(l){var h=l.symbol.color;h.a&&(a.attributeField!==f&&g?q.forEach(g,function(m){m.attributes[a.attributeField]==l.value&&b.push([m.attributes[f],
h.r,h.g,h.b])},this):b.push([l.value,h.r,h.g,h.b]))},this);this._adjustColormapToPixelTypeRange(b,e&&e.pixelType||this.pixelType);e=new I;e.functionName="Colormap";e.functionArguments={};e.functionArguments.Colormap=b;e.variableName="Raster";return e},_adjustColormapToPixelTypeRange:function(a,b){var c=this._pixelTypeRanges[b];c&&a.push([Math.floor(c[0]-1),0,0,0],[Math.ceil(c[1]+1),0,0,0]);return a},_combineRenderingRule:function(a,b){if(!a||!b)return a||b;var c=function(e){var g=e.Raster;return g=
g&&"esri.layers.RasterFunction"===g.declaredClass?c(g.functionArguments):e},d=k.clone(a);"none"!==b.functionName.toLocaleLowerCase()&&(c(d.functionArguments).Raster=b);return d},_isItemLevelRasterFunction:function(a){var b=a&&a.functionName;if(!b||!this._hasItemLevelRFT)return!1;var c=!1;q.some(this.rasterFunctionInfos,function(d){if(d&&d.name===b){if(1===d.functionType||2===d.functionType)c=!0;return!0}});return c},_getServiceLevelRenderingRule:function(a){if(!this._hasItemLevelRFT||!a)return a;
a=new I(a.toJson());var b=a.functionArguments;for(var c;;)if((c=b&&b.Raster)&&c.functionArguments&&c.functionArguments.Raster)b=c,b=b.functionArguments;else{this._isItemLevelRasterFunction(c)&&delete b.Raster;break}return a},_getItemLevelRenderingRule:function(a){if(!this._hasItemLevelRFT||!a)return null;if(this._isItemLevelRasterFunction(a))return a;a=new I(a.toJson());for(a=a.functionArguments;;)if((a=a&&a.Raster)&&a.functionArguments&&a.functionArguments.Raster)a=a.functionArguments;else{if(this._isItemLevelRasterFunction(a))return a;
break}},_resolve:function(a,b,c,d,e){b&&this[b].apply(this,a);c&&c.apply(null,a);d&&A._resDfd(d,a,e)},_toggleTime:function(){var a=this._map;this.timeInfo&&this.useMapTime&&a&&!this.suspended?(this._timeConnect||(this._timeConnect=ja.connect(a,"onTimeExtentChange",this,this._onTimeExtentChangeHandler)),this._setTime(a.timeExtent)):(ja.disconnect(this._timeConnect),this._timeConnect=null,this._setTime(null))},setUseMapTime:function(a,b){this.useMapTime=a;this._toggleTime();!b&&this._map&&this.refresh(!0)},
_setTime:function(a){this._params&&(this._params.time=a?a.toJson().join(","):null)},onResume:function(){if(this._isScientificData()||this.timeInfo)this._originalGetImageUrl=this._originalGetImageUrl||this.getImageUrl.bind(this),this.getImageUrl=qa(this._originalGetImageUrl,200),this._debounceGetImageTimer&&clearTimeout(this._debounceGetImageTimer),this._debounceGetImageTimer=setTimeout(function(){this.getImageUrl=this._originalGetImageUrl}.bind(this),5E3);this.inherited(arguments)},_onTimeExtentChangeHandler:function(a){this.suspended||
(this._setTime(a),this.refresh(!0))},handleSpatialReferenceChange:function(){this.onSpatialReferenceChange()},getColormap:function(a){var b=this._url.path+"/colormap",c=new C(A._dfdCanceller),d={f:"json"};a&&a.renderingRule&&(d.renderingRule=F.toJson(a.renderingRule.toJson()));this.hasColormap?(c._pendingDfd=H({url:b,content:d,handleAs:"json",callbackParamName:"callback"}),c._pendingDfd.then(function(e){c.callback(e)},function(e){c.errback(e)})):(a=Error("Layer does not support colormap"),a.log=!!O.isDebug,
c.errback(a));return c},getRenderingRuleColormap:function(a){var b=new C(A._dfdCanceller);if(!a||!a.renderingRule)return b.errback(Error("Rendering rule is not specified")),b;a=a.renderingRule;var c=this._getRenderingRuleId(a);this._renderingRuleColormap&&c&&this._renderingRuleColormap.hasOwnProperty(c)?b.resolve(this._renderingRuleColormap[c]):b=this.getColormap({renderingRule:a}).then(k.hitch(this,function(d){d=d&&d.colormap;c&&(this._renderingRuleColormap[c]=d);return d}));return b},_handleClipFunctionInRenderingRule:function(a){a=
k.clone(a);var b=a.arguments,c=b.ClippingGeometry&&b.ClippingGeometry.value,d=b.Extent&&b.Extent.value;b.ClippingRaster&&b.ClippingRaster.value||c||d||(b=this._map.extent.toJson(),a.arguments.Extent.value=b,a.functionArguments.Extent.value=b,a._isTemplate&&(a._templateJson.arguments.Extent.value=b));return a}});k.setObject("layers.ImageServiceLayerMixin",T,ra);return T});