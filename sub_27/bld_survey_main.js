export default class BldSurvey{constructor(e){this.surveys=e,document.onreadystatechange=(()=>{this.start()})}start(){const e=this.checkToForceByUrlParam();if(this.checkToTestConditionalCookieParam(),!(e>-1&&e<this.surveys.length))return this.checkSurveyData()?(this.checkToSetSettingByUrlParam("bld-survey-randomizer","randomizer"),this.checkToSetSettingByUrlParam("bld-survey-prio","prioOrder"),this.filterSurveys(),void this.checkToDisplay()):(console.error("BldSurvey: Not all required parameters for class BldSurvey were found"),!1);this.showIntercept(this.surveys[e])}filterSurveys(){this.surveys.forEach((e,t,r)=>{let o=!0;e.startsAt&&NaN!==Date.parse(e.startsAt)&&Date.now()<Date.parse(e.startsAt)&&(o=!1),!0===o&&e.endsAt&&NaN!==Date.parse(e.endsAt)&&Date.now()>=Date.parse(e.endsAt)&&(o=!1),!1===o&&r.splice(t,1)})}checkSurveyData(){const e=["randomizer","timeOut","prioOrder","cookieExpiresAfter"],t=["surveyId","surveyUrl","cookieTitle","metrixCategory","metrixCategory"],r=[{modalText:["title","content","no","yes","textBelowButtons","footer"]}];let o=[];if(this.surveys&&Array.isArray(this.surveys)&&this.surveys.length>0){for(let s=0;s<this.surveys.length;s++){const n=this.surveys[s];let i,a,l;i=e.every((t,r)=>!(!n.hasOwnProperty(e[r])||"number"!=typeof n[e[r]])),a=t.every((e,r)=>!!(n.hasOwnProperty(t[r])&&"string"==typeof n[t[r]]&&n[t[r]].length>0)),l=r.every((e,t)=>{if(n[Object.keys(r[t])[0]]&&"object"==typeof n[Object.keys(r[t])[0]]){let e=Object.keys(r[t])[0],o=r[t][e];return o.every((t,r)=>!0===n[e].hasOwnProperty(o[r])&&"string"==typeof n[e][o[r]])}return!1}),o.push(i,a,l)}return!o.some(e=>!1===e)}return console.error("BldSurvey: No surveys found"),!1}async checkToDisplay(){if(!document.querySelector("div#bld-modal")){if((window.location.href.indexOf("www.belastingdienst.nl")>-1||window.location.href.indexOf("/belastingdienst.nl")>-1)&&!1===this.checkToShowOnWwwOnInternalWorkstationUrlParam())try{return void await this.isInternalWorkstation("https://www-o.belastingdienst.nl/check_internal/check_internal.png",new Image)}catch(e){}if(this.analyzeAllSurveys(),this.surveys.selectedSurveys.length>0){const e=this.surveys[this.surveys.selectedSurveys[0].key];setTimeout(()=>{sessionStorage.setItem(e.cookieTitle,!0),this.showIntercept(e)},e.timeOut)}}}checkToForceByUrlParam(){const e=new URLSearchParams(window.location.search).get("bld-survey-force");return null!==e&&"string"==typeof e&&!0==!isNaN(e)&&parseInt(e)>=0?parseInt(e-1):-1}checkToShowOnWwwOnInternalWorkstationUrlParam(){const e=new URLSearchParams(window.location.search).get("bld-survey-www");return null!==e&&"true"===e}checkToTestConditionalCookieParam(){const e=new URLSearchParams(window.location.search).get("bld-survey-test-cc");if(null!==e&&"string"==typeof e&&e.length>0){e.split("|").forEach(e=>{if(!isNaN(e)&&this.surveys[parseInt(e-1)]){const r=this.surveys[parseInt(e-1)];if(r.conditionalCookies&&Array.isArray(r.conditionalCookies))for(var t=0;t<r.conditionalCookies.length;t++){const o=r.conditionalCookies[t];o.length>0&&(console.log(`Set conditional cookie (${o}) for testing purposes for survey ${e}`),RO.cookies.create(o,"shown",1))}}})}}checkToSetSettingByUrlParam(e,t){const r=new URLSearchParams(window.location.search).get(e);if(null!==r&&"string"==typeof r&&r.length>=3){const e=r.split("|");if(e.length>0){let r=[];for(let o=0;o<e.length;o++)2===(r=e[o].split("=")).length&&!0==!isNaN(r[0])&&parseInt(r[0])>=0&&parseInt(r[0])<=this.surveys.length&&!0==!isNaN(r[1])&&parseInt(r[1])>=0&&(this.surveys[parseInt(r[0])-1][t]=parseInt(r[1]))}}}async isInternalWorkstation(e,t){return new Promise((r,o)=>{t.onload=(()=>r(t)),t.onerror=o,t.src=e})}checkCookies(e){return null!==RO.cookies.read(e)}checkSessionStorage(e){return!!sessionStorage[e]}analyzeAllSurveys(){this.surveys.selectedSurveys=[];for(let[e,t]of Object.entries(this.surveys))!0===this.checkReferrer(t)&&!0===this.checkConditionalCookie(t)&&!1===this.checkSessionStorage(t.cookieTitle)&&!0===this.randomize(t.randomizer)&&!1===this.checkCookies(t.cookieTitle)&&this.surveys.selectedSurveys.push({key:e,prioOrder:t.prioOrder});this.surveys.selectedSurveys.sort((e,t)=>e.prioOrder-t.prioOrder)}checkReferrer({referrer:e}){let t=[];return!(Array.isArray(e)&&e.length>0)||(e.forEach(e=>{if("object"==typeof e&&e.url){const{condition:r,url:o}=e;r&&""!==r&&"equal"!==r?"contains"===r&&t.push(document.referrer.includes(o)):t.push(document.referrer===o)}}),t.some(e=>!0===e))}checkConditionalCookie(e){let t=!0;if(e.conditionalCookies&&Array.isArray(e.conditionalCookies)&&e.conditionalCookies.length>0)for(let r=0;r<e.conditionalCookies.length;r++){const o=e.conditionalCookies[r];if("string"==typeof o&&o.length>0&&!1===this.checkCookies(o)){t=!1;break}}return t}randomize(e){return 0===e||1===Math.floor(Math.random()*e)}getBootstrapVersion(){let e=3;const{bootstrap:t}=window;return t&&void 0!==t&&t.Tooltip&&t.Tooltip.VERSION&&t.Tooltip.VERSION.length>0&&(e=parseInt(t.Tooltip.VERSION.split(".")[0])),e}showIntercept(e){const t=this.getBootstrapVersion();let r="";const o=e.modalText.title;r=t>=4?`<div class="bld_center">\n          <p>${e.modalText.content}</p>\n          </div>\n          <div class="modal-buttons">\n          <p><a class="bld-survey-knop bld-knop-algemeen" id="bld_modal_${e.surveyId}_ja" href="${e.surveyUrl}" target="_blank">${e.modalText.yes}</a></p>\n          <p><a class="bld-survey-knop bld-knop-secundair" id="bld_modal_${e.surveyId}_nee" href="javascript:void(0);">${e.modalText.no}</a></p>\n          </div>\n          <p>${e.modalText.textBelowButtons}</p>`:`<div class="bld_center">\n          <p>${e.modalText.content}</p>\n          </div>\n          <div class="row"><div class="col-sm-6">\n          <p><a class="bld-survey-knop bld-knop-algemeen" id="bld_modal_${e.surveyId}_ja" href="${e.surveyUrl}" target="_blank">${e.modalText.yes}</a></p>\n          </div><div class="col-sm-6">\n          <p><a class="bld-survey-knop bld-knop-secundair" id="bld_modal_${e.surveyId}_nee" href="javascript:void(0);">${e.modalText.no}</a></p>\n          </div></div>\n          <p>${e.modalText.textBelowButtons}</p>`;const s=e.modalText.footer;bld_modal(o,r,s,!0,`bld_modal_${e.surveyId}`),$("#bld-modal").modal("show"),document.querySelectorAll("a.bld-survey-knop").forEach(t=>{t.addEventListener("click",t=>{RO.cookies.create(e.cookieTitle,"shown",e.cookieExpiresAfter),$("#bld-modal").modal("hide")})})}}