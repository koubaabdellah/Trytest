// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.41/esri/copyright.txt for details.
// See https://www.arcgis.com/home/copyright.txt for further details.
//>>built
define("arcgisonline/pages/accountswitcher-callback","require exports tslib ../esriGeowConfig esri/config ./utils/mapViewer ./utils/signin ./utils/storage ./utils/strings ../sharing/dijit/dialog/SubscriptionStatusDlg dojo/has dojo/_base/kernel dojo/Deferred esri/libs/sanitizer/Sanitizer esri/request dojo/i18n!../nls/arcgisonline ./utils/queryHandler".split(" "),function(K,L,r,p,C,D,z,v,E,F,A,G,w,H,x,m,y){p=r.__importDefault(p);C=r.__importDefault(C);z=r.__importDefault(z);v=r.__importDefault(v);E=
r.__importDefault(E);F=r.__importDefault(F);A=r.__importDefault(A);G=r.__importDefault(G);w=r.__importDefault(w);H=r.__importDefault(H);x=r.__importDefault(x);m=r.__importDefault(m);y=r.__importStar(y);return function(){function g(a){this.baseClass="flex-1 flex-column";this.hideFooter=this.hideHeader=!0;this.classicMapStartPage="webmap/viewer.html";this.modernMapStartPage="../apps/mapviewer/index.html";this.geodeClientId="geoanalyticsengine";C["default"].defaults.io.proxyUrl=p["default"].proxyServer;
this.setOAuthResponseHash(a)}g.prototype.fetchSelf=function(a){var b=this,c,d=p["default"].restBaseUrl+"portals/self",e=null===(c=this.hashInfo)||void 0===c?void 0:c.token;return x["default"]({url:d,content:{f:"json",token:e},handleAs:"json"}).then(function(f){return f},function(f){if("User not allowed for this account"!==f.message)return location.href=p["default"].baseUrl;x["default"]({url:b._getRootRestBaseUrl()+"portals/self",content:{f:"json",token:e},handleAs:"json"}).then(function(h){if(!h.urlKey||
h.urlKey===location.href.split("://")[1].split(".")[0])return location.href=b._getRootRestBaseUrl().replace("sharing/rest/","");location.href=b._generateOrgUrlFromUrlKey(h.urlKey,"accountswitcher-callback.html#"+b._swapUrlKeysInReturnUrl(a,h.urlKey))})})};g.prototype.setOAuthResponseHash=function(a){var b=this,c,d="#"===a.charAt(0),e="?"===a.charAt(0);if(d||e)a=a.substring(1);var f=y.queryToObject(a);if(f.error)this._showError(this._getLocalizedError(f));else{var h=f.state&&JSON.parse(f.state),n=
!!f.persist;a=null!==(c=null===h||void 0===h?void 0:h.clientId)&&void 0!==c?c:"arcgisonline";if(null===h||void 0===h?0:h.clientId)n?v["default"].setLocalStorageItem("portalAppClientId",a.toLowerCase()):v["default"].setSessionStorageItem("portalAppClientId",a.toLowerCase());z["default"].getCredential().then(function(l){var t=d?f.username:l.userId,q=d?f.access_token:l.token,I=d?f.expires_in?b.calculateExpires(f.expires_in):void 0:l.expires,J=d?"true"===f.ssl:l.ssl;l=d?h||null:h||l.oAuthState||void 0;
var B=(new Date).getTime();b.hashInfo={email:t,token:q,expires:I,allSSL:J,oAuthState:l,persistent:n,created:B};if(!A["default"]("ie")||8<A["default"]("ie"))window.location.hash="";b.fetchSelf(f).then(function(k){b.selfResult=k;b.portalUser=k.user;p["default"].userInfo=b.portalUser;b.setLocaleCookie(b.portalUser);return k}).then(function(k){return b.checkSubscription(k)}).then(function(k){return b._routeUser(k)}).then(function(k){var u;k=(null===(u=null===k||void 0===k?void 0:k.properties)||void 0===
u?0:u.landingPage)?k.properties.landingPage.returnUrl||""+p["default"].baseUrl+k.properties.landingPage.url:""+p["default"].baseUrl+(-1<b.portalUser.role.indexOf("admin")?"organization.html":"index.html");window.location.href=b._adjustReturnUrl(k)})})}};g.prototype.setLocaleCookie=function(a){var b,c=v["default"].getCookie("arcgisLocale");a=null===(b=null===a||void 0===a?void 0:a.culture)||void 0===b?void 0:b.toLowerCase();c&&a&&c!==a||!c&&a?v["default"].setCookie("arcgisLocale",a,{sameSite:"Strict"}):
v["default"].setCookie("arcgisLocale",null,{expires:-1})};g.prototype.checkSubscription=function(a){return this._subscriptionIsActive(a)?(a=new w["default"],a.resolve(this.portalUser),a):this.showSubscriptionStatusDlg(a)};g.prototype.showSubscriptionStatusDlg=function(a){var b=new w["default"],c=new F["default"]({portal:a});c.onOkClick=function(){c.hide();setTimeout(function(){b.resolve(!0)},250)};c.show(a.subscriptionInfo);return b};g.prototype._subscriptionIsActive=function(a){return!a.subscriptionInfo||
"active"===a.subscriptionInfo.state};g.prototype._routeUser=function(a){var b=this,c,d,e=a||{},f=this.hashInfo,h=new w["default"],n=!e.orgId;e=this._isNewUser(e);var l=this.isInitialOrgAdmin(f),t=(null===(c=this.hashInfo.oAuthState)||void 0===c?void 0:c.clientId)===this.geodeClientId;if(null===(d=this.hashInfo.oAuthState)||void 0===d?0:d.activating)h.resolve({properties:{landingPage:{url:"organization.html?welcome\x3dtrue"}}});else if(t)h.resolve({properties:{landingPage:{url:this.selfResult.urlKey?
"geoanalyticsengine.html":"setup.html"}}});else if(e&&!l)h.resolve({properties:{landingPage:{url:"user.html?newUser\x3dtrue"}}});else if(f.oAuthState&&f.oAuthState.returnUrl&&"true"!==f.oAuthState.useLandingPage)h.resolve({properties:{landingPage:{returnUrl:f.oAuthState.returnUrl}}});else if(n)h.resolve({properties:{landingPage:{url:"index.html"}}});else return this._getUserProperties(a.username).then(function(q){return b.configurePrimaryMapViewer(q)});return h};g.prototype.calculateExpires=function(a){return Date.now()+
this.convertToMS(a)};g.prototype.convertToMS=function(a){return 1E3*Number(a)};g.prototype.configurePrimaryMapViewer=function(a){var b,c,d,e=(null===(c=null===(b=null===a||void 0===a?void 0:a.properties)||void 0===b?void 0:b.landingPage)||void 0===c?void 0:c.url)||"";e&&e===this.classicMapStartPage&&(D.determineUserMapViewer({isSignedIn:!0,isViewingOrg:!0,properties:null===a||void 0===a?void 0:a.properties})||D.determineOrgMapViewer({mapViewer:null===(d=this.selfResult.portalProperties)||void 0===
d?void 0:d.mapViewer,created:this.selfResult.created,subscriptionInfo:this.selfResult.subscriptionInfo,isPortal:this.selfResult.isPortal}))===D.MapViewerType.Modern&&!p["default"].isDebug&&(a.properties.landingPage.url=this.modernMapStartPage);return a};g.prototype._isNewUser=function(a){var b=a.created?(new Date(a.created)).getTime():-1;return-1===a.lastLogin&&144E5>(new Date).getTime()-b};g.prototype.isInitialOrgAdmin=function(a){var b;return!0===(null===(b=null===a||void 0===a?void 0:a.oAuthState)||
void 0===b?void 0:b.initialAdmin)};g.prototype._adjustReturnUrl=function(a){var b,c,d,e,f,h=p["default"].isDebug,n=this.parseUrl(a),l=n.host,t=n.port,q=this.selfResult;n=q.urlKey;var I=q.customBaseUrl,J=q.allSSL,B=q.portalHostname;q=q.isPortal;var k=null===(b=this.hashInfo.oAuthState)||void 0===b?void 0:b.returnUrl;b=n?n+"."+I:B;t||(a=J?a.replace("http:","https:"):a.replace("https:","http:"));if(k){if(z["default"].isValidReturnUrl(q,k)){var u=(h=(null===(d=null===(c=null===(u=this.selfResult)||void 0===
u?void 0:u.subscriptionInfo)||void 0===c?void 0:c.companionOrganizations)||void 0===d?void 0:d.length)&&(null===(f=null===(e=this.selfResult.subscriptionInfo.companionOrganizations[0])||void 0===e?void 0:e.organizationUrl)||void 0===f?void 0:f.toLowerCase()))&&-1<k.indexOf(h);return!q&&u?this._swapUrlKeyInUrl(k,n):q||l!==B||this.isGeodeClientId()?a:this._switchToOrgUrl(a,l)}return p["default"].baseUrl+"index.html"}h||q||this.isGeodeClientId()||(a=a.replace(l,b));return a};g.prototype.isGeodeClientId=
function(){var a,b;return"geoanalyticsengine"===(null===(b=null===(a=this.hashInfo)||void 0===a?void 0:a.oAuthState)||void 0===b?void 0:b.clientId)};g.prototype._switchToOrgUrl=function(a,b){var c=this.selfResult,d=c.urlKey;c=c.customBaseUrl;d&&c&&-1===b.indexOf(d+"."+c)&&(a=a.replace(b,d+"."+c));return a};g.prototype._getUserProperties=function(a){var b;a=p["default"].restBaseUrl+"community/users/"+a+"/properties";var c=null===(b=this.hashInfo)||void 0===b?void 0:b.token;return x["default"]({url:a,
content:{f:"json",token:c},handleAs:"json"}).then(function(d){return d})};g.prototype._getBridgeUrl=function(a,b){var c=p["default"].bridgeUrl+"?url\x3d"+encodeURIComponent(a),d=b.expires&&(new Date(b.expires)).getTime(),e=(new Date).getTime();return d?c+"\x26exp\x3d"+Math.ceil((d-e)/1E3):c};g.prototype._getRootRestBaseUrl=function(){var a=location.href.split(".")[1].replace("maps","");return"https://"+(a?""+a+("qa"===a?"ext":"")+".":"")+"arcgis.com/sharing/rest/"};g.prototype._generateOrgUrlFromUrlKey=
function(a,b){var c=location.href.split(".")[1].replace("maps","");return"https://"+a+".maps"+c+".arcgis.com/home/"+(b||"")};g.prototype._swapUrlKeysInReturnUrl=function(a,b){if(a.state)try{var c=JSON.parse(a.state);if(c.returnUrl)return c.returnUrl=this._swapUrlKeyInUrl(c.returnUrl,b),a.state=JSON.stringify(c),y.objectToQuery(a)}catch(d){}return y.objectToQuery(a)};g.prototype._swapUrlKeyInUrl=function(a,b){if(a){var c=a.split("."),d=c[0].split("://");d[1]=b;c[0]=d.join("://");return c.join(".")}return a};
g.prototype._getLocalizedError=function(a){var b,c=a.state,d=a.messageCode,e=d&&m["default"].common.errors[d]||a.error_description&&decodeURIComponent(a.error_description)||a.error&&decodeURIComponent(a.error)||m["default"].common.errors.genericError.message,f=e.toLowerCase(),h="OAUTH_0051"===d,n="OAUTH_0032"===d;-1<f.indexOf("because you do not have an organization account associated with your")?e=m["default"].signInWidget.error.noSocialAccount:-1<f.indexOf("joining this organization is supported by invitation only")?
e=m["default"].signInWidget.error.notMemberOfOrg:-1<f.indexOf("cannot add user to subscription. subscription user limit reached.")?e=m["default"].signInWidget.error.memberLimitReached:-1<f.indexOf("unable to retrieve user profile from the provider")?e=m["default"].signInWidget.error.unableToRetrieveProfile:d&&"OAUTH_0032"===d?e=m["default"].signInInternalWidget.noActivationCodeFound:d&&"OAUTH_0058"===d?e=m["default"].signInWidget.error.subRequiresPublicEmail:d&&"OAUTH_0062"===d?e=m["default"].signInWidget.error.unableToRetrieveProfile+
" "+m["default"].signInWidget.error.unableToRetrieveProfile.contactAdmin:d&&"OAUTH_0012"===d&&(e="oauth_join"===(null===(b=a.state)||void 0===b?void 0:b.method)?m["default"].accountSwitcher.oauth.joinSessionTimeout:m["default"].accountSwitcher.oauth.yourLoginSessionHasBeenResetPleaseTry);a=new H["default"];return{errorMsg:E["default"].escapeHTML(a.sanitize(e)),showSignUp:h,hideSignIn:n,state:c}};g.prototype._showError=function(a){var b,c=document.querySelector(".js-error-wrapper"),d=document.querySelector(".js-error-message"),
e=document.querySelector(".js-signin-btn");d.innerHTML=a.errorMsg||m["default"].viewer.error.cannotSignInOAuth;a.showSignUp?(e.innerHTML=m["default"].createAccount.docTitle,e.href=this.getCreateAccountUrl()):e.innerHTML=m["default"].siteHeader.signIn;c.classList.remove("hide");("oauth_join"===(null===(b=a.state)||void 0===b?void 0:b.method)||a.hideSignIn)&&e.classList.add("hide");this._hideLoader()};g.prototype._hideLoader=function(){document.querySelector(".js-page-loader.is-active").classList.remove("is-active")};
g.prototype.getCreateAccountUrl=function(){var a=this.getDevEnviroment();return"dev"===a||"qa"===a?"https://preview.esri.com/en-us/sandbox/agol/"+("dev"!==a?"stg":"dev")+"-create-account":"https://www.esri.com/"+(G["default"].locale||"en-us")+"/arcgis/products/create-account"};g.prototype.getDevEnviroment=function(){var a,b=(null===(a=p["default"].restBaseUrl)||void 0===a?void 0:a.replace(location.protocol,""))||"";return 0===b.search(/^\/\/devext/)||-1<b.search(/mapsdevext\.arcgis\.com/)?"dev":0===
b.search(/^\/\/qaext/)||-1<b.search(/mapsqaext\.arcgis\.com/)?"qa":null};g.prototype.parseUrl=function(a){var b=document.createElement("a");b.href=a;var c=b.hostname,d=b.port,e=b.search,f=b.protocol.replace(":","");c=c||window.location.host;for(var h={},n=b.search.replace(/^\?/,"").split("\x26"),l=0;l<n.length;l++)if(n[l]){var t=n[l].split("\x3d");h[t[0]]=t[1]}return{source:a,protocol:f,host:c,port:d,query:e,params:h,file:(b.pathname.match(/\/([^/?#]+)$/i)||[,""])[1],hash:b.hash.replace("#",""),path:b.pathname.replace(/^([^/])/,
"/$1"),relative:(b.href.match(/tps?:\/\/[^/]+(.+)/)||[,""])[1],segments:b.pathname.replace(/^\//,"").split("/")}};g.prototype._closeWindow=function(){if("Microsoft Internet Explorer"===navigator.appName){var a=window.open("","_self");a.opener=this;a.close()}else window.close()};return g}()});