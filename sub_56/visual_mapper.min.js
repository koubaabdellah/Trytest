/*! Visual Mapper v1.6 | (c) 2017 Semantic Web Company */
!function(t){t.fn.initVisualMapper=function(e,a){return new t.VisualMapper(this[0],e,a)},t.VisualMapper=function(e,a,r){function n(t,e){null===t&&(t="");for(var a=t.split(/\s+/),r=[],n=[],s=0,i=0;i<a.length;i++)s+n.length+a[i].length>e&&0!=s&&(r.push(n.join(" ")),n=[],s=0),n.push(a[i]),s+=a[i].length,i==a.length-1&&r.push(n.join(" "));return r}var s=this;this.settings=t.extend(!0,{width:800,height:800,startUri:"",loadParams:{},spiderChart:{chartMarginLeft:0,chartMarginTop:0,rootInnerRadius:75,rootOuterRadius:360,rootFontSize:15,rootCharactersPerLine:18,conceptMaxRadius:30,conceptMinRadius:15,conceptFontSize:12,conceptCharactersPerLine:18,sectorMinArc:.5,paginationAngle:.5,rectHeight:90,rectWidth:90,showConceptSchemeSelection:!0,legendSize:12,legendPositionX:"left",legendPositionY:"top",legendStyle:"list"},export:{enabled:!0,exportButtonRadius:20,exportButtonPositionX:"right",exportButtonPositionY:"top",exportButtonColor:"#aaa",exportFileName:"visual_mapper"},relations:{},backColor:"#FFFFFF",backColorItems:"#FFFFFF",headerColor:"#0094cc",inactiveColor:"#dadada",chartTypes:["spider"],wording:{glossaryRoot:"Glossary Root",homeButton:"Glossary Root",currentConcept:"Current Concept",exportText:"Export as PNG"},fontMultiplier:1.2},a||{});for(var i in this.settings.relations)this.settings.relations[i]=t.extend(!0,{colors:{bright:"#ccc",dark:"#888"},wording:{legend:"Legend item"}},this.settings.relations[i]);this.listeners=t.extend({conceptLoaded:[],visibleConceptsChanged:[]},r||{}),this.element=e,this.browser=null,this.concepts=null,this.root_concept=null,this.concept_scheme_selection=null,this.cleanedConcepts=!0,this.chart_data=null,this.xScale=d3.scale.linear().range([0,this.settings.width]),this.yScale=d3.scale.linear().range([0,this.settings.height]),this.rawJsonData=null,this.UriHistory=[],this.chartType=this.settings.chartTypes[0],this.loadUrl="",this.language="",this.loading=!0,t.extend(this,{init:function(){if(s.settings.chartTypes.length>1){var e=d3.select(".chart-type-selection").append("ul");s.settings.chartTypes.forEach(function(a){e.append("li").text("spider"===a?"Visual Mapper":"Tree Mapper").attr("data-type",a).attr("class",a===s.chartType?"active":"").on("click",function(){t(this).hasClass("active")||(t(this).siblings().removeClass("active"),t(this).addClass("active"),d3.selectAll(s.browser.node().childNodes).remove(),d3.selectAll(d3.select("#chart-header").node().childNodes).remove(),s.chartType=t(this).attr("data-type"),s.load(s.loadUrl),t("#chart-header").hide())})})}d3.select(s.element).append("div").attr("id","chart-header").attr("class","collapsed").style("width",s.settings.width-2*t("#chart-header").css("padding-left").replace("px","")+"px").style("background-color",s.settings.headerColor).style("display","none").attr("width",s.settings.width-2*t("#chart-header").css("padding-top").replace("px","")),s.browser=d3.select(s.element).append("svg").attr("width",s.settings.width).attr("height",s.settings.height).attr("class","visual-mapper-svg").style("background",s.settings.backColor),d3.select(s.element).append("svg").attr("id","export-svg").attr("width",s.settings.width).attr("height",s.settings.height).style("background",s.settings.backColor),d3.select(s.element).append("canvas").attr("id","export-canvas").attr("width",s.settings.width).attr("height",s.settings.height).style("background",s.settings.backColor)},load:function(e,a,r){s.loadUrl=e,s.language=void 0!==r?r:"";var n=!a||0==a.length;t.ajax({dataType:"json",url:e,data:t.extend({uri:a||s.settings.startUri||"",lang:s.language},s.settings.loadParams),success:function(a){switch(s.rawJsonData=a,void 0!==a.settings&&s.updateSettings(a.settings),s.chartType){case"spider":d3.select(s.element).append("svg").attr("height",1).attr("width",1).attr("id","pattern-definition-svg").append("defs").attr("id","pattern-definitions").append("pattern").attr("height",1).attr("width",1).attr("id","concept-image-pattern").append("image").attr("x",0).attr("y",0).attr("width",2*s.settings.spiderChart.rootInnerRadius-0).attr("height",2*s.settings.spiderChart.rootInnerRadius-0).attr("id","concept-image"),s.browser.select(".concepts").empty()&&(s.concepts=s.browser.append("g").attr("class","concepts")),s.browser.select(".root-concept").empty()&&(s.root_concept=s.concepts.append("g").attr("class","concept root-concept")),s.browser.select(".concept-scheme-selection").empty()&&(s.concept_scheme_selection=s.browser.append("g").attr("class","concept-scheme-selection").attr("transform","scale(1, 0)").style("display","none")),s.settings.spiderChart.showConceptSchemeSelection&&0==t(s.concept_scheme_selection.node()).children().length&&(n?s.drawConceptSchemeSelection(a,n):t.ajax({dataType:"json",url:e,data:t.extend({lang:s.language},s.settings.loadParams),success:function(t){s.drawConceptSchemeSelection(t,n)}}));for(l=0;l<s.listeners.conceptLoaded.length;l++)s.listeners.conceptLoaded[l](a);s.drawBrowser(a);break;case"treemap":t("#chart-header").empty().append('<div id="chart-breadcrumb"><ul><li><a href="" class="active">Glossary</a></li></ul></div>').show(),a.children&&t(a.children).each(function(){this.children?(this.hasChildren=!0,delete this.children):this.hasChildren=!1});var r=d3.layout.treemap().round(!0).size([s.settings.width,s.settings.height]).value(function(t){return t.size}).sort(function(t,e){return t.size-e.size});s.chart_data=a;var i=r.nodes(a).filter(function(t){return!t.children}),o=s.browser.datum(a).selectAll("g").data(i);o.enter().append("svg:g").attr("class",function(t){return t.hasChildren?"cell has-children":"cell"}).attr("id",function(t){return s.friendly_url(t.id)}).call(s.position).attr("transform",function(t){return"translate("+t.x+","+t.y+")"}).on("click",function(t){return s.treemap_cell_clicked(t)}),s.update_breadcrumbs(),o.append("svg:rect").attr("width",function(t){return t.dx-1}).attr("height",function(t){return t.dy-1}).style("fill",function(t){var e=s.rawJsonData.children&&!s.rawJsonData.children[0].parents?"conceptScheme":"children";return t.hasChildren?s.settings.relations[e].colors.bright:s.settings.relations[e].colors.dark}).append("title").text(function(t){return t.name}),o.append("svg:text").attr("x",function(t){return t.dx/2}).attr("y",function(t){return t.dy/2}).attr("dy",".35em").attr("text-anchor","middle").text(function(t){return t.name}).style("display",function(t){return t.w=this.getComputedTextLength(),t.dx>t.w?"block":"none"})}for(var l=0;l<s.listeners.visibleConceptsChanged.length;l++)s.listeners.visibleConceptsChanged[l](s.getVisibleData())}})},addListener:function(t,e){return!!this.listeners.hasOwnProperty(t)&&(this.listeners[t].push(e),!0)},drawBrowser:function(t){s.root_concept.attr("transform","translate("+(s.settings.width/2+s.settings.spiderChart.chartMarginLeft)+","+(s.settings.height/2+s.settings.spiderChart.chartMarginTop)+")").datum(t).drawRootConcept(),this.addExportButton(),this.updateLegend(t)},addExportButton:function(){if(s.settings.export.enabled){var e=10,a=10,r=s.settings.export.exportButtonRadius;"right"===s.settings.export.exportButtonPositionX&&(e=s.settings.width-10-2*r),"bottom"===s.settings.export.exportButtonPositionY&&(a=s.settings.height-10-2*r),export_element=s.browser.append("g").attr("transform","translate("+e+", "+a+")").attr("class","export-button"),export_element.append("circle").attr("r",r).attr("cx",r).attr("cy",r).attr("fill",s.settings.backColorItems).attr("stroke",s.settings.export.exportButtonColor).attr("stroke-width",3),export_element.append("path").attr("d","M"+r+" "+r/3+" L"+r+" "+(2*r-(r/3+2))+" M"+r+" "+(2*r-r/3)+" L"+.6*r+" "+1.2*r+" L"+r+" "+(2*r-r/3)+" L"+1.4*r+" "+1.2*r).attr("fill",s.settings.backColorItems).attr("stroke",s.settings.export.exportButtonColor).attr("stroke-width",3),export_element.append("text").text(s.settings.wording.exportText).attr("text-anchor","right"===s.settings.export.exportButtonPositionX?"end":"start").attr("dominant-baseline","middle").attr("class","export-button-text").attr("transform","translate("+("right"===s.settings.export.exportButtonPositionX?"-"+r:3*r)+", "+r+")").style("font-size",r+"px").style("fill",s.settings.export.exportButtonColor).style("opacity",0),export_element.append("circle").attr("r",r+2).attr("cx",r).attr("cy",r).attr("class","invisibleExportCircle").on("mouseover",function(t){d3.select(this.parentNode).selectAll(".export-button-text").transition().duration(500).style("opacity",1)}).on("mouseout",function(t){d3.select(this.parentNode).selectAll(".export-button-text").transition().duration(500).style("opacity",0)}).on("click",function(e){if(!s.loading){var a=t(s.concepts.node()).clone(!0);a.find(".invisibleConceptCircle, .page-container:not(.active)").remove();var r=t("#export-svg");r.append(a);var n=document.getElementById("export-svg"),i=document.getElementById("export-canvas"),o=i.getContext("2d"),l=(new XMLSerializer).serializeToString(n),c=window.URL||window.webkitURL||window;r.empty();var d=new Image,p=new Blob([l],{type:"image/svg+xml;charset=utf-8"}),g=c.createObjectURL(p);d.onload=function(){o.drawImage(d,0,0),c.revokeObjectURL(g);var t=i.toDataURL("image/png").replace("image/png","image/octet-stream"),e=new MouseEvent("click",{view:window,bubbles:!1,cancelable:!0}),a=document.createElement("a");a.setAttribute("download",s.settings.export.exportFileName+".png"),a.setAttribute("href",t),a.setAttribute("target","_blank"),a.dispatchEvent(e)},d.src=g}})}},updateLegend:function(e){var a=[];for(var r in e.relations)e.relations[r].length>0&&(-1===t.inArray(r,a)&&a.push(r),e.relations[r].forEach(function(e){for(var r in e.relations)-1===t.inArray(r,a)&&a.push(r)}));"project"===e.type&&-1===t.inArray(Object.keys(s.settings.relations)[0],a)&&a.push(Object.keys(s.settings.relations)[0]);var n=[],i=[];for(var r in s.settings.relations)if(-1!==t.inArray(r,a)){var o=s.settings.relations[r].wording.legend;-1===t.inArray(o,n)&&(i.push(r),n.push(o))}var l=d3.select(".chart-legend");if(l.empty()){var c=10+("circle"===s.settings.spiderChart.legendStyle?40:0),d=10,p=!1;s.settings.export.enabled&&s.settings.spiderChart.legendPositionX===s.settings.export.exportButtonPositionX&&s.settings.spiderChart.legendPositionY===s.settings.export.exportButtonPositionY&&(p=!0),"right"===s.settings.spiderChart.legendPositionX&&(c=s.settings.width-5*s.settings.spiderChart.legendSize-60),"bottom"===s.settings.spiderChart.legendPositionY?(d=s.settings.height-(s.settings.spiderChart.legendSize*(i.length+1)*1.5+15),p&&(d-=2*s.settings.export.exportButtonRadius+10)):p&&(d+=2*s.settings.export.exportButtonRadius+("circle"===s.settings.spiderChart.legendStyle?10:0)),l=s.concepts.append("g").attr("transform","translate("+c+", "+d+")").attr("class","chart-legend")}else l.selectAll("*").remove();var g=0;i.forEach(function(t){if("list"===s.settings.spiderChart.legendStyle)l.append("rect").attr("width",s.settings.spiderChart.legendSize).attr("height",s.settings.spiderChart.legendSize).style("fill",s.settings.relations[t].colors.dark).attr("transform","translate(0,"+(s.settings.spiderChart.legendSize*g*1.5+25)+")"),l.append("text").text(s.settings.relations[t].wording.legend).attr("transform","translate("+1.5*s.settings.spiderChart.legendSize+","+(s.settings.spiderChart.legendSize*g*1.5+s.settings.spiderChart.legendSize-2+25)+")").style("font-size",s.settings.spiderChart.legendSize+"px");else if("circle"===s.settings.spiderChart.legendStyle){var e=d3.svg.arc().innerRadius(10).outerRadius(30).startAngle(2*Math.PI/i.length*g).endAngle(2*Math.PI/i.length*(g+1));l.append("path").attr("d",e).attr("stroke",s.settings.backColorItems).attr("stroke-width",1).attr("fill",s.settings.relations[t].colors.dark).attr("class","legend-circle-part").attr("transform","translate("+-1.5*s.settings.spiderChart.legendSize+","+(s.settings.spiderChart.legendSize*i.length*.5+s.settings.spiderChart.legendSize+9)+")"),l.append("text").text(s.settings.relations[t].wording.legend).attr("transform","translate("+1.5*s.settings.spiderChart.legendSize+","+(s.settings.spiderChart.legendSize*g*1.5+s.settings.spiderChart.legendSize-2+15)+")").style("font-size",s.settings.spiderChart.legendSize+"px").style("fill",s.settings.relations[t].colors.dark)}g++})},drawConceptSchemeSelection:function(e){t("#chart-header").show(),d3.select("#chart-header").append("div").attr("id","chart-navigation").append("span").attr("id","glossary-root-button").text(s.settings.wording.homeButton).on("click",function(){var e=t(this).closest("#chart-header");e.hasClass("collapsed")?(e.removeClass("collapsed"),s.concept_scheme_selection.style("display","").transition().duration(500).attr("transform","scale(1 1)").call(s.endAll,function(){d3.select(this).attr("transform",null)})):s.concept_scheme_selection.transition().duration(500).attr("transform","scale(1 0)").call(s.endAll,function(){d3.select(this).style("display","none"),t("#chart-header").addClass("collapsed")})}),d3.select("#chart-navigation").append("span").attr("class","current-concept-info").text("project"!==s.rawJsonData.type?s.settings.wording.currentConcept+": "+(s.rawJsonData.name.length<=30?s.rawJsonData.name:s.rawJsonData.name.substr(0,30)+"..."):"");var a=[],r=0,n=0;for(var i in s.settings.relations)if(void 0!==e.relations[i]&&e.relations[i].length){var o=e.relations[i];for(var l in o)a.push(o[l]);o[0].size>r&&(r=o[0].size),(o[o.length-1].size<n||0==n)&&(n=o[o.length-1].size)}var c=r-n,d=s.settings.spiderChart.conceptMaxRadius-s.settings.spiderChart.conceptMinRadius,p=a.length,g=(s.settings.height-20)/(2*s.settings.spiderChart.conceptMaxRadius+5);g=p>(g=(s.settings.height-20)/(2*s.settings.spiderChart.conceptMaxRadius+5))?Math.ceil(p/2):p,s.concept_scheme_selection.append("svg:rect").attr("width",s.settings.width-2).attr("height",g*s.settings.spiderChart.conceptMaxRadius*2+20+5*(g-1)).attr("rx",5).attr("ry",5).style("fill",s.settings.backColorItems).attr("transform","translate(1, -5)").style("opacity",.9).style("stroke-width",2).style("stroke",s.settings.headerColor);var h=0,u=0;for(var l in a){(e=a[l]).radius=function(t){return c>0?(t.size-n)/c*d+s.settings.spiderChart.conceptMinRadius:s.settings.spiderChart.conceptMaxRadius}(e);var f=s.concept_scheme_selection.append("g");f.selectAll("g").data([e]).enter().append("g").attr("class","concept concept-scheme").attr("transform","translate("+(s.settings.spiderChart.conceptMaxRadius+10+400*h)+","+((u+.5)*s.settings.spiderChart.conceptMaxRadius*2+10+5*u)+")").drawConcept(),t(f.node()).find("tspan").remove(),f.select("text").text(e.name).attr("text-anchor","start").attr("transform","translate("+(s.settings.spiderChart.conceptMaxRadius+5)+", "+(s.settings.spiderChart.conceptFontSize/2-2)+")"),f.select("circle.invisibleConceptCircle").on("click",function(e){return t("#glossary-root-button").d3Click(),s.updateConcept(e)}),++u>=g&&(h++,u=0)}},updateConcept:function(e){s.loading||(s.loading=!0,s.cleanedConcepts=!1,d3.selectAll("text.rootConceptText, g.pagination-container").transition().duration(500).style("opacity",0).remove(),d3.selectAll("g.concept:not(.root-concept):not(.concept-scheme)").transition().duration(500).attr("transform","translate(0,0)").style("opacity",0).call(s.endAll,function(){s.cleanedConcepts=!0}).remove(),t.ajax({dataType:"json",url:s.loadUrl,data:t.extend({uri:e.id,lang:this.language},s.settings.loadParams),success:function(t){void 0!==e.noHistory&&e.noHistory||s.UriHistory.push(s.rawJsonData.id),s.rawJsonData=t,void 0!==t.settings&&s.updateSettings(t.settings);for(var a=0;a<s.listeners.conceptLoaded.length;a++)s.listeners.conceptLoaded[a](t);var r=setInterval(function(){if(s.cleanedConcepts){clearInterval(r),d3.select(".current-concept-info").text(s.settings.wording.currentConcept+": "+(t.name.length<=30?t.name:t.name.substr(0,30)+"...")),s.concepts.select("g").datum(t).drawRootConcept();for(var e=0;e<s.listeners.visibleConceptsChanged.length;e++)s.listeners.visibleConceptsChanged[e](s.getVisibleData())}},10);s.updateLegend(t)}}))},back:function(){if(this.UriHistory.length>0){var t=this.UriHistory.pop();return this.updateConcept({id:t,noHistory:!0}),!0}return!1},getVisibleData:function(){for(var t=d3.selectAll(".page-container.active  g.concept"),e=[],a=0;a<t[0].length;a++)e.push(t[0][a].__data__);return e},updateSettings:function(e){if(void 0!==e.relations){s.settings.relations=jQuery.extend(!0,{},e.relations),delete e.relations;for(var a in s.settings.relations)s.settings.relations[a]=t.extend(!0,{colors:{bright:"#ccc",dark:"#888"},wording:{legend:"Legend item"}},s.settings.relations[a])}s.settings=t.extend(!0,s.settings,e||{})},treemap_cell_clicked:function(e){!s.loading&&e.hasChildren&&(s.loading=!0,t("#chart-breadcrumb ul a").removeClass("active"),t("#chart-breadcrumb ul").append('<li><span> -> </span><a href="'+e.id+'" class="active">'+e.name+"</a></li>"),this.update_breadcrumbs(),this.update_treemap(e))},update_treemap:function(e){t.ajax({dataType:"json",url:s.loadUrl,data:t.extend({uri:e.id,lang:this.language},s.settings.loadParams),success:function(a){s.rawJsonData=a,a.relations.children&&t(a.relations.children).each(function(){this.children?(this.hasChildren=!0,delete this.children):this.hasChildren=!1});for(var r=0;r<s.chart_data.relations.children.length;r++)s.chart_data.relations.children[r].id==a.id&&(s.chart_data.relations.children[r].children=a.relations.children);var n=e;n.children=a.relations.children;var i=d3.layout.treemap().round(!0).size([n.dx,n.dy]).value(function(t){return t.size}).sort(function(t,e){return t.size-e.size}),o=d3.select("body").append("div").attr("class","sub-chart").style("width",n.dx-1+"px").style("height",n.dy-1+"px").append("svg:svg").attr("width",n.dx-1).attr("height",n.dy-1).style("left",n.x).style("top",n.y),l=i.nodes(a).filter(function(t){return!t.children}),c=o.datum(a).selectAll("g").data(l);c.exit().remove(),c.enter().append("svg:g").attr("class",function(t){return t.hasChildren?"cell has-children":"cell"}).attr("id",function(t){return s.friendly_url(t.id)}).call(s.position).attr("transform",function(t){return t.x+=n.x,t.y+=n.y,"translate("+t.x+","+t.y+")"}).on("click",function(t){return s.treemap_cell_clicked(t)}),c.text(function(t){return t.children?null:t.name}),c.append("svg:rect").attr("width",function(t){return t.dx-1}).attr("height",function(t){return t.dy-1}).style("fill",function(t){return t.hasChildren?s.settings.relations.children.colors.bright:s.settings.relations.children.colors.dark}).append("title").text(function(t){return t.name}),c.append("svg:text").attr("x",function(t){return t.dx/2}).attr("y",function(t){return t.dy/2}).attr("dy",".35em").attr("text-anchor","middle").text(function(t){return t.name}).style("display",function(t){return t.w=this.getComputedTextLength(),t.dx>t.w?"block":"none"}),t("#"+s.friendly_url(e.id)).children("rect, text").css("opacity",0),t("#"+s.friendly_url(e.id)).parent().append(t(".sub-chart").find("g.cell")),t(".sub-chart").remove(),s.zoom(n)}})},update_breadcrumbs:function(){t("#chart-breadcrumb a").unbind("click"),t("#chart-breadcrumb a").click(function(e){e.preventDefault(),s.loading||(s.loading=!0,cell_data=t(this).attr("href").length>0?t("#"+s.friendly_url(t(this).attr("href")))[0].__data__:s.chart_data,t(t(this).parent("li").nextAll().children("a").get().reverse()).each(function(){var e=t("#"+s.friendly_url(t(this).attr("href")))[0].__data__;t("#"+s.friendly_url(t(this).attr("href"))).find("rect, text").css("opacity","");for(var a=0;a<e.relations.children.length;a++)t("#"+s.friendly_url(e.relations.children[a].id)).remove();delete e.relations.children}),t(this).parent("li").nextAll().remove(),t(this).addClass("active"),s.zoom(cell_data))})},zoom:function(t){var e=this.settings.width/t.dx,a=this.settings.height/t.dy;this.xScale.domain([t.x,t.x+t.dx]),this.yScale.domain([t.y,t.y+t.dy]);var r=this.browser.selectAll("g.cell").transition().duration(750).attr("transform",function(t){return"translate("+s.xScale(t.x)+","+s.yScale(t.y)+")"}).call(s.endAll,function(){s.loading=!1});r.select("rect").attr("width",function(t){return e*t.dx-1}).attr("height",function(t){return a*t.dy-1}),r.select("text").attr("x",function(t){return e*t.dx/2}).attr("y",function(t){return a*t.dy/2}).style("display",function(t){return!t.children&&e*t.dx>t.w?"block":"none"})},position:function(){this.style("left",function(t){return t.x+"px"}).style("top",function(t){return t.y+"px"}).style("width",function(t){return Math.max(0,t.dx-1)+"px"}).style("height",function(t){return Math.max(0,t.dy-1)+"px"})},endAll:function(t,e){var a=0;t.each(function(){++a}).each("end",function(){--a||e.apply(this,arguments)})},arcTween:function(t,e,a,r,n,s){t.attrTween("d",function(){var t=d3.interpolate(a,r),i=d3.interpolate(n,s);return function(a){var r=t(a),n=i(a);return e({startAngle:r,endAngle:n})}})},friendly_url:function(t){for(var e=new Array(new Array("a",/[·‡‚„™¡¿¬√]/g),new Array("e",/[ÈËÍ…» ]/g),new Array("i",/[ÌÏÓÕÃŒ]/g),new Array("o",/[ÚÛÙı∫”“‘’]/g),new Array("u",/[˙˘˚⁄Ÿ€]/g),new Array("c",/[Á«]/g),new Array("n",/[—Ò]/g)),a=0;a<e.length;a++)t=t.replace(e[a][1],e[a][0]);return t.replace(/\s+/g,"-").toLowerCase().replace(/[^a-z0-9\-]/g,"-")}}),this.init(),d3.selection.prototype.drawRootConcept=function(){var e=this.datum();e.hasOwnProperty("image")&&d3.select(s.element).select("#pattern-definitions #concept-image").attr("xlink:href",e.image),this.select("circle").empty()?this.append("circle").style("fill",e.hasOwnProperty("image")?"url(#concept-image-pattern)":s.settings.backColorItems).attr("r",s.settings.spiderChart.rootInnerRadius).attr("stroke-width","0").addRootText("project"!=e.type?e.name:s.settings.wording.glossaryRoot):(t(this.node()).children("text").remove(),this.select("circle").addRootText("project"!=e.type?e.name:s.settings.wording.glossaryRoot),this.select("circle").style("fill",e.hasOwnProperty("image")?"url(#concept-image-pattern)":s.settings.backColorItems)),this.drawRootArc(e)},d3.selection.prototype.drawRootArc=function(t){d3.select("text.rootConceptText").transition().duration(500).style("opacity",1).call(s.endAll,function(){jQuery.isEmptyObject(s.rawJsonData.relations)&&(s.loading=!1)});var e=[],a=0,r=0;for(var n in s.settings.relations){h=t.relations[n]?t.relations[n]:[];e.push({type:n,elements:h,angle:0}),h.length&&(h[0].size>a&&(a=h[0].size),(h[h.length-1].size<r||0==r)&&(r=h[h.length-1].size))}var i=0,o=0;!function(){var t=0,a=0,r=[],n=0,i=0;sum=0;for(var o in e)t+=e[o].elements.length;if(t>0){for(var o in e)(n=e[o].elements.length/t*2*Math.PI)>0&&(r.push({id:o,angle:n}),n>=s.settings.spiderChart.sectorMinArc&&(sum+=n));r.sort(function(t,e){return t.angle>e.angle?1:t.angle<e.angle?-1:0});for(var o in r)r[o].angle<s.settings.spiderChart.sectorMinArc?(i+=s.settings.spiderChart.sectorMinArc-r[o].angle,r[o].angle=s.settings.spiderChart.sectorMinArc,a++):(n=r[o].angle*i/sum,r[o].angle-n<s.settings.spiderChart.sectorMinArc?sum-=r[o].angle:r[o].angle-=n);for(var o in r)e[r[o].id].angle=r[o].angle}}(),s.root_concept.select("g.root-arcs").empty()?s.root_concept.append("g").attr("class","root-arcs"):d3.selectAll("g.root-arc-circles").each(function(){var t=d3.select(this).attr("id").replace("root-arcs-","");s.settings.relations.hasOwnProperty(t)||(d3.select(".container."+t).remove(),d3.select(this).remove())});for(var l=0,c=0;c<e.length;c++){if(angle=e[c].angle,o=i+angle,0==i&&i!=o&&o<2*Math.PI&&(o=(i=(i-angle)/2)+angle),d3.select("g.container."+e[c].type).empty())var d=this.append("g").attr("class",e[c].type+" container");else(d=this.select("g.container."+e[c].type)).selectAll("g.pagination-container, g.page-container").remove();if(function(t,e,a){var r="project"==s.rawJsonData.type?Object.keys(s.settings.relations)[0]:t,n=a-e,i=d3.select("g.root-arcs"),o=i.select("g#root-arcs-"+t),c=o.empty(),d=s.settings.spiderChart.rootOuterRadius>=18?s.settings.spiderChart.rootOuterRadius>=100?5:2:1,p=d3.svg.arc().innerRadius(s.settings.spiderChart.rootInnerRadius).outerRadius(s.settings.spiderChart.rootOuterRadius);c&&(o=i.append("g").attr("id","root-arcs-"+t).attr("class","root-arc-circles")).append("path").attr("d",p).attr("stroke",s.settings.backColorItems).attr("stroke-width",d).attr("data-startangle",0).attr("data-endangle",0).attr("fill",s.settings.relations[r].colors.bright).attr("class","main-circle-part"),o.style("opacity",+(n>0));var g=o.select(".main-circle-part"),h=(o.select(".main-circle-part").transition().duration(500).call(s.arcTween,p,g.attr("data-startangle"),e,g.attr("data-endangle"),a).attr("data-startangle",e).attr("data-endangle",a).attr("fill",s.settings.relations[r].colors.bright).call(s.endAll,function(){++l==o.select(".main-circle-part").length&&(d3.selectAll(".page-1 g.concept").transition().duration(500).attr("transform",function(){return"translate("+d3.select(this).attr("data-x")+","+d3.select(this).attr("data-y")+")"}).style("opacity",1).call(s.endAll,function(){d3.selectAll(".page-container g.concept").style("opacity",1),s.loading=!1}),d3.selectAll("g.pagination-container").transition().duration(500).style("opacity",1))}),d3.svg.arc().innerRadius(s.settings.spiderChart.rootOuterRadius).outerRadius(s.settings.spiderChart.rootOuterRadius+20)),u=d3.svg.arc().innerRadius(s.settings.spiderChart.rootInnerRadius-10).outerRadius(s.settings.spiderChart.rootInnerRadius);if(c)var f=o.append("path").attr("d",h).attr("class","outer-circle").attr("stroke",s.settings.backColorItems).attr("stroke-width",d).attr("data-startangle",0).attr("data-endangle",0).attr("fill",s.settings.relations[r].colors.dark),y=o.append("path").attr("d",u).attr("class","inner-circle").attr("stroke",s.settings.backColorItems).attr("stroke-width",d).attr("data-startangle",0).attr("data-endangle",0).attr("fill",s.settings.inactiveColor);else var f=o.select("path.outer-circle"),y=o.select("path.inner-circle");f.transition().duration(500).call(s.arcTween,h,f.attr("data-startangle"),e,f.attr("data-endangle"),a).attr("data-startangle",e).attr("data-endangle",a).attr("fill",s.settings.relations[r].colors.dark),y.transition().duration(500).call(s.arcTween,u,y.attr("data-startangle"),e,y.attr("data-endangle"),a).attr("data-startangle",e).attr("data-endangle",a)}(e[c].type,i,o),angle>0){for(var p=0,g=0,h=e[c].elements,u=180*i/Math.PI,f=180*o/Math.PI,y=(a=h[0].size)-(r=h[h.length-1].size),x=s.settings.spiderChart.conceptMaxRadius-s.settings.spiderChart.conceptMinRadius;g<h.length;){var m=d.append("g").attr("class","page-container page-"+(p+1)+(p>0?"":" active"));g=function(t){var a=0,n=18,i=1,o=!1,l=Math.floor((f-u)/(2*n));l>h.length-t&&(l=h.length-t);for(var d=(f-u)/(l||1),p=t;p<h.length;p++){if(i>=l+1){if(a++,i=1,s.settings.spiderChart.rootOuterRadius-s.settings.spiderChart.rootInnerRadius<Math.sqrt(Math.pow(s.settings.spiderChart.rectWidth,2)+Math.pow(s.settings.spiderChart.rectHeight,2))*(a+1)+25*a-Math.ceil(12.5)*(a-1)){if(l>0||o){p--;break}a--,l=1,o=!0}n-=7/a,(l=Math.floor((f-u)/(2*n)))>h.length-p&&(l=h.length-p),d=(f-u)/(l||1)}var g=(u-90+(i-.5)*d)*Math.PI/180,v=Math.cos(g).toFixed(10),C=Math.sin(g).toFixed(10),w=s.settings.spiderChart.rootInnerRadius*v;w+=a*(s.settings.spiderChart.rectWidth+25)*v,w+=v*s.settings.spiderChart.rectWidth;var b=s.settings.spiderChart.rootInnerRadius*C;b+=a*(s.settings.spiderChart.rectHeight+25)*C,b+=C*s.settings.spiderChart.rectHeight;var k=e[c].elements[p];k.radius=function(t){return y>0?(t.size-r)/y*x+s.settings.spiderChart.conceptMinRadius:s.settings.spiderChart.conceptMaxRadius}(k),m.append("g").selectAll("g").data([k]).enter().append("g").attr("class","concept "+e[c].type).attr("data-x",w).attr("data-y",b).style("opacity",0).drawConcept(),i++}return p}(g)+1,p++}if(p>1){var v="Page ";if(clockwisePagination=!1,prefixSpaceToAdd=v.length*s.settings.fontMultiplier/(s.settings.spiderChart.rootOuterRadius/Math.PI),pagTextRadius=s.settings.spiderChart.rootOuterRadius+18,s.settings.spiderChart.paginationAngle*p>angle)var C=angle/p,w=o;else var C=s.settings.spiderChart.paginationAngle,w=i+angle/2+s.settings.spiderChart.paginationAngle*p/2;var b=o-(o-i)/2;(b<Math.PI/2||b>=1.5*Math.PI)&&(clockwisePagination=!0,w-=2*(w-b),C*=-1,pagTextRadius-=10);for(var k=d.append("g").attr("class","pagination-container").attr("id","pagination-container-"+e[c].type).style("opacity",0),A=1;A<=p;A++){var R=k.append("g").attr("class","pagination-page-container"+(1==A?" active":"")).attr("id","pagination-page-container-"+A).on("click",function(){if(-1==d3.select(this).attr("class").indexOf("active")){var t=this.parentNode.id.replace("pagination-container-","");d3.select(d3.select(this).node().parentNode).selectAll(".pagination-page-container").attr("class","pagination-page-container"),d3.select(this).attr("class","pagination-page-container active");var e=d3.select(this).attr("id").split("-").pop();d3.select(this.parentNode).selectAll("path.concept-pagination").attr("fill",s.settings.inactiveColor),d3.select(this.parentNode.parentNode).selectAll(".page-container").each(function(){d3.select(this).attr("class",d3.select(this).attr("class").replace(" active","")),d3.select(this).selectAll(".concept").attr("transform","translate(0,0)")}),d3.select(d3.select(this).node().parentNode.parentNode).select(".page-container.page-"+e).selectAll(".concept").attr("transform",function(){return"translate("+d3.select(this).attr("data-x")+","+d3.select(this).attr("data-y")+")"}),d3.select(d3.select(this).node().parentNode.parentNode).select(".page-container.page-"+e).attr("class","page-container page-"+e+" active"),d3.select(this).select("path.concept-pagination").attr("fill",s.settings.relations[t].colors.dark);for(var a=0;a<s.listeners.visibleConceptsChanged.length;a++)s.listeners.visibleConceptsChanged[a](s.getVisibleData())}}).on("mouseover",function(){if(-1==d3.select(this).attr("class").indexOf("active")){var t=this.parentNode.id.replace("pagination-container-","");d3.select(this).select("path.concept-pagination").attr("fill",s.settings.relations[t].colors.bright)}}).on("mouseout",function(){if(-1==d3.select(this).attr("class").indexOf("active")){this.parentNode.id.replace("pagination-container-","");d3.select(this).select("path.concept-pagination").attr("fill",s.settings.inactiveColor)}}),M=d3.svg.arc().innerRadius(s.settings.spiderChart.rootOuterRadius+2).outerRadius(s.settings.spiderChart.rootOuterRadius+24).startAngle(w-C*(A-1)).endAngle(w-C*A);R.append("path").attr("d",M).attr("stroke-width",1).attr("stroke",s.settings.backColorItems).attr("class","concept-pagination").attr("id","concept-pagination-"+A).attr("fill",1==A?s.settings.relations[e[c].type].colors.dark:s.settings.inactiveColor);var _=w-Math.PI/2,z=A.toString().length*s.settings.fontMultiplier/(s.settings.spiderChart.rootOuterRadius/Math.PI),S=(prefixSpaceToAdd+z)*(clockwisePagination?-1:1);Math.abs(C)<=Math.abs(2*S)&&(v="",S=z*(clockwisePagination?-1:1)),R.append("path").attr("d","M "+Math.cos(_-C*(A-.5)+S).toFixed(10)*pagTextRadius+","+Math.sin(_-C*(A-.5)+S).toFixed(10)*pagTextRadius+" Q "+Math.cos(_-C*(A-.5)).toFixed(10)*(pagTextRadius+2)+","+Math.sin(_-C*(A-.5)).toFixed(10)*(pagTextRadius+2)+" "+Math.cos(_-C*(A-.5)-S).toFixed(10)*pagTextRadius+","+Math.sin(_-C*(A-.5)-S).toFixed(10)*pagTextRadius).attr("id","concept-pagination-text-path-"+e[c].type+"-"+A).attr("class","concept-pagination-text-path").style("opacity",0),R.append("text").style("font-size","14px").attr("class","concept-pagination-text").append("textPath").attr("xlink:href","#concept-pagination-text-path-"+e[c].type+"-"+A).text(v+A)}}}i=o}return this},d3.selection.prototype.addRootText=function(t){return function(t,e){var a=t.node().parentNode,r=d3.select(a);textArray=n(e,s.settings.spiderChart.rootCharactersPerLine),paragraph=r.append("text").attr("class","rootConceptText").attr("transform","translate(0,"+(-(textArray.length-1)*(s.settings.spiderChart.rootFontSize/2+1)+(s.settings.spiderChart.rootFontSize/2-3))+")").style("opacity",0).attr("text-anchor","middle");for(var i=0;i<textArray.length;i++)paragraph.append("svg:tspan").attr("x","0").attr("y",i*(s.settings.spiderChart.rootFontSize+2)).text(textArray[i]).attr("font-size",s.settings.spiderChart.rootFontSize).style("stroke","#fff").style("stroke-width",4).style("stroke-linecap","butt").style("stroke-linejoin","miter"),paragraph.append("svg:tspan").attr("x","0").attr("y",i*(s.settings.spiderChart.rootFontSize+2)).text(textArray[i]).attr("font-size",s.settings.spiderChart.rootFontSize)}(this,t),this},d3.selection.prototype.drawConcept=function(){this.each(function(t){var e=d3.select(this),a=t.radius,r=a/2.5;e.append("rect").attr("width",s.settings.spiderChart.rectWidth).attr("height",s.settings.spiderChart.rectHeight).attr("transform","translate(-"+s.settings.spiderChart.rectWidth/2+",-"+s.settings.spiderChart.conceptMaxRadius+")").style("fill","none"),e.append("circle").style("fill",s.settings.backColorItems).attr("r",a).attr("stroke-width","0").addText(),e.drawArc(t,r,a),e.append("circle").attr("r",a).attr("class","invisibleConceptCircle").on("click",function(t){return s.updateConcept(t)})})},d3.selection.prototype.drawArc=function(t,e,a){var r=[],n=0;for(var i in s.settings.relations){var o=t.relations&&t.relations[i]?t.relations[i]:[];r.push({type:i,elements:o,angle:0}),n+=o.length}var l=0,c=0;for(var d in r){var p=r[d].elements.length/n*2*Math.PI;if(p>0){var g=this.append("g").attr("class",r[d].type);c=l+p,0==l&&(c=(l=(l-c)/2)+c);var h=d3.svg.arc().innerRadius(e).outerRadius(a).startAngle(l).endAngle(c),u=a>=18?a>=100?5:2:1;g.append("path").attr("d",h).attr("stroke",s.settings.backColorItems).attr("stroke-width",u).attr("stroke-miterlimit","10").attr("fill",s.settings.relations[r[d].type].colors.dark),l=c}}return this},d3.selection.prototype.addText=function(){function t(t,e){var a=d3.select(t),r=t.parentNode,i=d3.select(r);textArray=n(e,s.settings.spiderChart.conceptCharactersPerLine),paragraph=i.append("text").attr("class","conceptText").attr("transform","translate(0,"+(+a.attr("r")+2+s.settings.spiderChart.conceptFontSize)+")").attr("text-anchor","middle");for(var o=0;o<textArray.length;o++)paragraph.append("svg:tspan").attr("x","0").attr("y",o*(s.settings.spiderChart.conceptFontSize+2)).text(textArray[o]).attr("font-size",s.settings.spiderChart.conceptFontSize)}return this.each(function(e){t(this,e.name)}),this}},t.fn.d3Click=function(){this.each(function(t,e){var a=document.createEvent("MouseEvents");a.initMouseEvent("click",!0,!0,window,0,0,0,0,0,!1,!1,!1,!1,0,null),e.dispatchEvent(a)})}}(jQuery);